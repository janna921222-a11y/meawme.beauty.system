<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>| 繆米美學系統 |</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 妳提供的金鑰
        const firebaseConfig = {
            apiKey: "AIzaSyC58dtm6RX_Ew-xEwusvq113m1hMq68JIo",
            authDomain: "meawmesystem.firebaseapp.com",
            databaseURL: "https://meawmesystem-default-rtdb.firebaseio.com",
            projectId: "meawmesystem",
            storageBucket: "meawmesystem.firebasestorage.app",
            messagingSenderId: "436649468308",
            appId: "1:436649468308:web:438437ac8d97ab56d06f81",
            measurementId: "G-27RC3VTZZJ"
        };

        // 初始化連接
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 把雲端功能掛載到 window，讓原本的 script 可以抓到
        window.firebaseDB = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
    </script>

    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 核心視覺系統 --- */
        :root {
            --forest-bg: #1c3328;
            --border-base: #2d5a47;
            --border-hover: #3d6a57;
            --border-trans: rgba(45, 90, 71, 0.8);
            --nav-bg: #1c3328;
            --btn-bg: rgba(15, 40, 33, 0.95);
            --btn-hover: rgba(22, 53, 48, 0.9);
            --text-shadow: rgba(0, 0, 0, 0.5);
            --nav-text-unselect: rgba(245, 241, 232, 0.4);
            --nav-text-active: #f5f1e8;
            --card-bg: rgba(245, 241, 232, 0.08);
            --white-main: #f5f1e8;
            --white-sec: #d4cfc4;
            --gold-main: #c9b896;
            --grey-green: #8b9d8a;
            --nav-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            
            /* 日曆系統專用變數對應 */
            --cal-gold: #c9b896;
            --cal-red: #800020;
            --cal-green: #1a4731;
        }

        /* 後台高辨識度模式 */
        body.admin-mode {
            --forest-bg: #f5f1e8;
            --white-main: #1a3a2e;
            --white-sec: #4a5a54;
            --gold-main: #8a6d3b;
            --border-base: #c9b896;
            --card-bg: rgba(26, 58, 46, 0.05);
            --nav-bg: #f5f1e8;
            --nav-text-unselect: rgba(26, 58, 46, 0.4);
            --nav-text-active: #1a3a2e;
            --nav-shadow: 0 -4px 15px rgba(26, 58, 46, 0.1);
        }

        body { 
            background-color: var(--forest-bg); 
            color: var(--white-main); 
            /* Outfit 是現代極簡英數字體，搭配思源黑體 Noto Sans TC 的現代排版 */
            font-family: 'Outfit', 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden; 
            line-height: 1.6; 
            letter-spacing: 0.08em; 
            font-size: 15px;
            font-weight: 400;
        }

        .app-wrapper { 
            width: 100%; 
            max-width: 100%; /* 手機版預設全寬 */
            margin: 0 auto; 
            position: relative; 
            min-height: 100vh; 
            box-sizing: border-box; /* 確保 padding 不會撐破版面 */
            padding-bottom: 90px; /* 避免內容被底部導航遮住 */
        }
        .brand-header { padding: 45px 0 25px; text-align: center; }
        .logo-box { width: 85%; max-width: 380px; margin: 0 auto 12px; }
        .logo-img { width: 100%; height: auto; mix-blend-mode: lighten; }
        body.admin-mode #logo-guest {
            display: none !important; /* 隱藏前台 Logo */
        }

        body.admin-mode #logo-admin {
            display: block !important; /* 顯示後台 Logo */
            mix-blend-mode: multiply;  /* 後台淺色底用 multiply */
        }

        .studio-name { font-size: 32px; font-weight: 700; color: var(--white-main); text-shadow: 0 2px 10px rgba(0,0,0,0.3); letter-spacing: 4px; margin-bottom: 8px; }
        .studio-name2 { font-size: 20px; font-weight: 700; color: var(--white-main); text-shadow: 0 2px 8px rgba(0,0,0,0.3); letter-spacing: 4px; margin-bottom: 8px; }
        .studio-subtitle { font-size: 14px; color: var(--gold-main); letter-spacing: 4px; text-shadow: 0 1px 4px rgba(0,0,0,0.3); }

        /* 分頁系統 */
        .page-content { display: none; padding-bottom: 150px; }
        .page-content.active { display: block !important; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        #nav-admin.active-flex {
            display: flex !important;
        }

        /* 卡片樣式 */
        .info-title, .m-card h2 { 
            font-size: 20px !important; 
            font-weight: 700 !important; 
            color: var(--gold-main) !important; 
            margin-bottom: 15px !important; 
            display: block !important;
            letter-spacing: 2px !important;
            text-align: left !important;
        }

        [id^="page-admin"] h2 {
            font-size: 28px !important;
            text-align: center !important;
            margin: 30px 0 10px !important;
            color: var(--gold-main);
            font-weight: 800;
            letter-spacing: 3px;
        }

        /* Admin Styles */
        .admin-setting-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .setting-btn {
            padding: 10px 40px;
            background: var(--card-bg);
            border: 1px solid var(--border-base);
            border-radius: 30px;
            color: var(--gold-main);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setting-btn.editing { background: var(--gold-main); color: white; border-color: var(--gold-main); }
        .admin-section-label { font-size: 12px; color: var(--gold-main); font-weight: 700; margin: 20px 8% 10px; padding-left: 10px; border-left: 3px solid var(--gold-main); opacity: 0.7; }
        /* --- [修正後的] 後台排版 --- */
        .admin-item-row {
            margin: 0 8% 8px 8%;
            padding: 12px 15px;
            background: rgba(128, 128, 128, 0.08);
            border-radius: 12px;
            display: flex;
            align-items: center; 
            gap: 12px; /* 這裡改用 gap，東西才不會打架 */
            flex-wrap: wrap; /* 空間不夠時自動換行 */
            border: 1px solid rgba(201, 184, 150, 0.1);
        }

        .admin-item-row .info {
            flex: 1;
            min-width: 120px; /* 這裡保證輸入框至少有寬度，不會消失 */
        }
        
        .admin-item-row .edit-input {
            width: 100% !important; /* 讓輸入框填滿 */
            background: rgba(255,255,255,0.9) !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            color: #333 !important;
            font-size: 13px !important;
        }

        .admin-item-row .info small {
            display: block;
            font-size: 11px;
            opacity: 0.6;
            margin-top: 2px;
        }

        .admin-item-row .price {
            font-size: 14px;
            font-weight: 700;
            color: var(--gold-main);
            margin-left: auto; /* 讓價格靠右邊 */
            white-space: nowrap;
        }
        
        /* 避免按鈕被壓扁 */
        .admin-item-row button {
            flex-shrink: 0;
        }
        /* 確保輸入框樣式正確 */
        .admin-item-row .edit-input {
            background: rgba(255, 255, 255, 0.9) !important; 
            border: 1px solid #ccc !important; 
            width: 100%;
            padding: 4px 8px !important;
            color: #333 !important;
        }
        /* 防止按鈕被擠壓 */
        .admin-item-row button {
            flex-shrink: 0;
        }
        .check-toggle { width: 26px; height: 26px; border: 2px solid var(--gold-main); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: transparent; }
        .check-toggle.active { background: var(--gold-main); color: white; }
        .edit-input { background: rgba(255,255,255,0.9); border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; color: #333; font-size: 13px; }
        .gear-circle {
            width: 50px;
            height: 50px;
            background: var(--card-bg);
            border: 1px solid var(--border-base);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .gear-circle:hover {
            background: rgba(201, 184, 150, 0.1);
        }
        
        /* Dropdown & Table */
        .dropdown-container { width: 94%; max-width: 500px; margin: 0 auto 12px; }
        .dropdown-header { 
            background: rgba(255, 255, 255, 0.04) !important;
            border: 1px solid rgba(201, 184, 150, 0.3) !important;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-title {
            font-family: inherit; /* 強制繼承 body 的字體 */
            font-weight: 700;
            letter-spacing: 0.15em;
            color: var(--gold-main);
        }
        .dropdown-arrow { font-size: 16px; transition: transform 0.4s; color: var(--gold-main); font-weight: bold; }
        .dropdown-content { 
            max-height: 0; 
            overflow: hidden; 
            /* 關鍵：收起時 padding 也要設為 0，才不會擠壓文字 */
            padding: 0 18px; 
            transition: max-height 0.4s ease-out, padding 0.4s ease-out; 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid transparent; 
            border-top: none;
        }

        .dropdown-container.open .dropdown-content { 
            max-height: 2000px; 
            padding: 20px 18px; 
            border-color: rgba(201, 184, 150, 0.2); 
        }
        .dropdown-container.open .dropdown-arrow { transform: rotate(180deg); }
        .price-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .price-table td { border-bottom: 1px solid rgba(201, 184, 150, 0.1); padding: 12px 5px; color: var(--white-sec); }
        .price-value { color: var(--white-main); font-weight: 500; text-align: left; padding-left: 10px !important; }

        /* --- QA 樣式 --- */
        .qa-item { margin-bottom: 18px; }
        .qa-q { color: var(--gold-main); font-weight: 600; display: flex; align-items: flex-start; margin-bottom: 8px; }
        .qa-q::before { content: '?'; background: var(--gold-main); color: var(--forest-bg); width: 18px; height: 18px; min-width: 18px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 11px; margin-top: 3px; }
        .qa-a { color: var(--white-sec); padding-left: 3.2em; text-indent: -1.2em; }

        /* Nav */
        /* [修改] 底部導航欄：加高、固定高度 */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: var(--nav-bg) !important; 
            border-top: 1px solid var(--border-base); 
            z-index: 1000; 
            /* 這裡固定為 75px，不使用動態高度 */
            height: 60px !important; 
            min-height: 60px !important; 
            max-height: 60px !important;
            padding-bottom: env(safe-area-inset-bottom); 
            display: flex; 
            justify-content: center; 
            box-shadow: var(--nav-shadow);
            /* 移除任何 transition 縮放效果 */
            transition: none !important; 
        }

        .nav-inner {
            width: 100%;
            max-width: 100%;
            height: 100%;
            display: flex;
        }
        
        /* 調整日曆內小條目在電腦版的大小 */
        @media (min-width: 768px) {
            .fin-cal-cell {
                font-size: 11px !important; /* 原本是 8px */
            }
            .fin-cal-row {
                margin-bottom: 2px;
            }
            .fin-cal-total {
                font-size: 12px !important;
                padding-top: 4px;
            }
        }

        /* 修正報表標題顏色，與日曆記帳一致 (使用 var(--white-main)) */
        #report-month-title, #report-year-title {
            color: var(--white-main) !important;
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.1em;
        }
        /* [修改] 按鈕樣式：取消縮放動畫，改為純色塊區分 */
        .tab-button { 
            flex: 1; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--nav-text-unselect) !important; 
            font-size: 13px; /* 字體稍微加大 */
            font-weight: 600; 
            text-align: center; 
            cursor: pointer; 
            transition: color 0.2s ease; /* 只做顏色漸變，不改變大小 */
            padding-top: 5px; /* 增加頂部微距讓文字視覺置中 */
        }

        /* 選中狀態：字變亮，加底色，不改變大小 */
        .tab-button.active { 
            color: var(--white-main) !important; 
            font-weight: 700; 
            background: oklch(100% 0.00011 271.152 / 0.08); 
        }

        /* Login Overlay - 鍵盤防跳動優化 */
        #admin-login-overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(10, 20, 15, 0.98) !important;
            display: none; 
            flex-direction: column; 
            align-items: center; 
            /* [修正] 改為靠上對齊，並給予固定頂部距離，鍵盤彈起時才不會被擠壓 */
            justify-content: flex-start !important; 
            padding-top: 25vh !important; 
            z-index: 5000;
        }
        #admin-login-overlay.active { display: flex; animation: fadeIn 0.5s ease forwards; }
        .login-container { text-align: center; width: 100%; max-width: 450px; padding: 20px;}
        .login-title { font-family: 'Zen Maru Gothic', sans-serif;color: var(--gold-main); font-size: 18px; letter-spacing: 6px; margin-bottom: 40px; opacity: 0.8;}
        .pwd-input {
            background: transparent !important; 
            border: none !important; 
            border-bottom: 2px solid var(--gold-main) !important;
            color: white !important; 
            text-align: center !important; 
            font-size: 22px !important; 
            width: 95% !important; 
            padding: 10px 0 !important; 
            margin-bottom: 40px !important; 
            outline: none !important;
            letter-spacing: 8px !important; 
        }
        .login-action-btn { 
            background: transparent; 
            color: var(--gold-main); 
            border: 1px solid var(--gold-main);
            padding: 12px 60px; 
            font-size: 13px; 
            letter-spacing: 4px; 
            cursor: pointer; 
            transition: all 0.3s;
        }        
        .login-action-btn:hover { background: var(--gold-main); color: var(--forest-bg); }

        /* 計算機 Styles (保留) */
        #page-admin-calc .k-card { background: #ffffff !important; color: #1a3a2e !important; margin: 0 4% 15px 4% !important; padding: 15px !important; border-radius: 18px !important; }
        #page-admin-calc .label-zh { font-size: 22px !important; font-weight: 800 !important; color: #1a3a2e !important; margin-bottom: 12px !important; display: block !important; letter-spacing: 1px !important;}
        #page-admin-calc .option-btn { background: #f8f6f2 !important; color: #1a3a2e !important; padding: 6px 2px; border-radius: 8px; border: 1px solid rgba(26,58,46,0.1); font-size: 11px; font-weight: 700; }
        #page-admin-calc .option-btn.active { background: #1a3a2e !important; color: white !important; }
        #page-admin-calc .addon-card { background-color: #f5f2ee; border-radius: 18px; padding: 8px 4px; display: flex; flex-direction: column; align-items: center; border: 1.5px solid transparent; cursor: pointer; }
        #page-admin-calc .addon-card.selected { background-color: #1a3a2e; color: white; }
        .stepper-btn { width: 20px; height: 20px; border-radius: 50%; background: #c9b896; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; }
        .design-row { display: grid; grid-template-columns: 1.5fr 1fr 1.2fr 40px; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 1px solid rgba(26, 58, 46, 0.05);}
        .design-row span { font-size: 14px !important; font-weight: 600; }
        .design-row .price-input { font-size: 14px !important; padding: 6px !important; height: 35px; }
        .delete-btn {color: #ff6b6b;font-size: 20px;cursor: pointer;text-align: center;font-weight: bold;}
        .k-input { background: #f5f2ee; border-radius: 20px; padding: 4px 10px; width: 100%; font-size: 12px; border: 1px solid transparent; }
        .k-input-readonly { background: transparent; border: none; width: 40px; text-align: center; font-size: 10px; font-weight: 700; color: #c9b896; }
        #page-admin-calc .design-btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        #page-admin-calc .design-btn-grid .option-btn {padding: 10px 4px; font-size: 12px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
        #page-admin-calc .design-row { 
            display: grid !important; grid-template-columns: 1fr 55px 70px 20px !important; 
            align-items: center !important; gap: 5px !important; padding: 4px 0 !important; border-bottom: none !important; 
        }
        #copyBtn { background-color: #2d4639 !important; color: white !important; }
        .admin-form {background: rgba(255,255,255,0.03) !important;border: 1px solid rgba(201,184,150,0.1) !important;}
        .admin-item-card {display: flex;justify-content: space-between;align-items: center;padding: 12px 15px;background: rgba(128, 128, 128, 0.05);border-radius: 10px; margin-bottom: 8px; border: 1px solid rgba(201, 184, 150, 0.05);}
        .admin-item-card .item-info {flex: 1;}
        .admin-item-card .name {font-size: 14px;font-weight: 600;color: var(--white-main);}
        .admin-item-card .detail { font-size: 11px; opacity: 0.6;margin-top: 2px;}
        .admin-item-card button { padding: 4px 8px; background: transparent; border: 1px solid #ff6b6b;border-radius: 6px; color: #ff6b6b;font-size: 11px;cursor: pointer;transition: all 0.3s;}
        .admin-item-card button:hover { background: rgba(255, 107, 107, 0.1);}
        
        /* 讓滑鼠移到三條線時顯示抓取手勢 */
        .admin-item-row .text-\[var\(--gold-main\)\] {
            cursor: grab !important;
        }
        .admin-item-row .text-\[var\(--gold-main\)\]:active {
            cursor: grabbing !important;
        }

        /* 編輯模式下，禁止文字選取以利拖拽 */
        body.admin-mode .admin-item-row {
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        /* 確保輸入框還是可以點進去打字 */
        body.admin-mode .edit-input {
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        /* 抓取手勢 */
        .drag-handle {
            cursor: grab !important;
            padding: 10px;
            touch-action: none; /* 防止手機滑動干擾拖曳 */
        }
        .drag-handle:active {
            cursor: grabbing !important;
        }
        
        /* [新增] 價格選擇按鈕樣式 */
        .p-select-btn {
            background: #0f241d !important; /* 深綠色實心背景 */
            border: 1px solid var(--gold-main);
            color: #ffffff !important;
            padding: 16px;
            border-radius: 10px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s;
            cursor: pointer;
        }
        .p-select-btn:active {
            background: var(--gold-main) !important;
            color: #1a3a2e !important;
            transform: scale(0.98);
        }
        .p-select-btn span:nth-child(2) {
            color: var(--gold-main);
            font-size: 1.1em;
        }
        .p-select-btn:active span:nth-child(2) {
            color: #1a3a2e;
        }
        /* 隱藏百分比項目的錢字號 */
        .currency-symbol.hidden-symbol { display: none; }

        .p-select-btn span:last-child {
            color: var(--gold-main); /* 價格顯示金色 */
            font-size: 1.1em;
        }
        .p-select-btn:active span:last-child {
            color: #1a3a2e;
        }
        
        /* --- 編輯面板 (隱藏) --- */
        #global-edit-panel { display: none; }
        .hidden { display: none !important; }
        /* 強制拔除所有白色方塊背景 */
        #page-admin-calc .k-card, 
        #page-admin-calc .app-container,
        #page-admin-calc section { background: transparent !important; background-color: transparent !important; box-shadow: none !important; border: none !important;}
        /* --- 計算機底部懸浮列修正 --- */
        #page-admin-calc .sticky-calc-footer {
            position: fixed !important;
            bottom: 60px !important;
            
            /* 手機版：寬度改寬一點 (92%)，才不會太擠 */
            width: 92% !important; 
            left: 50% !important;
            transform: translateX(-50%) !important;

            /* 外觀設定 */
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(15px) !important;
            border-radius: 50px !important;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1) !important;
            z-index: 900 !important;
            padding: 15px 20px !important; 
            
            /* 排版設定 */
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border: 1px solid rgba(181, 164, 137, 0.2) !important;
        }

        /* 電腦版：限制最大寬度 500px，才不會太長 */
        @media (min-width: 768px) {
            #page-admin-calc .sticky-calc-footer {
                width: 500px !important; 
            }
        }
                
        /* --- [NEW] 行事曆系統專用樣式 (修正版) --- */
        .calendar-section { width: 100%; position: relative; }
        .serif { font-family: 'Playfair Display', serif; }
        .blur-target { filter: blur(8px); pointer-events: none; opacity: 0.1; transition: all 0.4s ease; }
        
        /* 1. 日曆網格佈局 (共用) */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 2px;
            width: 100%;
            padding: 0 4px; 
            box-sizing: border-box; 
            max-width: 1000px !important; 
            margin: 0 auto !important; 
            align-items: stretch; /* 讓格子高度自動對齊 */
        }
        
        @media (min-width: 768px) {
            .calendar-grid { gap: 6px; }
        }
        
        /* 2. 格子結構 (共用排版設定，確保高度與形狀一致) */
        .day-box, .fin-day-box { 
            border-radius: 4px; 
            padding: 4px 1px; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            min-height: 110px; 
            height: 100% !important; /* 強制填滿高度 */
            box-sizing: border-box;
            overflow: hidden;
        }

        /* [預約] 專用外觀：保留底色與咖啡色框 */
        .day-box {
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(201, 184, 150, 0.15); 
        }

        /* [財務] 專用外觀：無底色、改用淡白線 */
        .fin-day-box {
            background: transparent; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        
        /* 電腦版高度調整 (共用) */
        @media (min-width: 768px) {
            .day-box, .fin-day-box { 
                padding: 10px 4px; 
                
                /* [修改] 電腦版最小高度加大 */
                min-height: 150px; 
                
                border-radius: 8px; 
            }
        }

        /* 後台模式 (Admin Mode) 配色 */
        body.admin-mode .day-box { 
            background: rgba(0,0,0,0.03); 
            border-color: var(--gold-main); 
        }
        body.admin-mode .fin-day-box {
            background: transparent;
            border-color: rgba(0,0,0,0.1); /* 後台淺色模式下的財務邊框 */
        }

        /* 財務頁面：置中顯示專用樣式 */
        .fin-day-box.centered-state { justify-content: center; align-items: center; padding: 0; }
        .fin-day-box.centered-state .date-corner { position: absolute; top: 2px; left: 4px; font-size: 10px; }
        .fin-day-box.centered-state .center-text { font-size: 11px; font-weight: bold; letter-spacing: 1px; }
        .fin-day-header span.font-bold { font-size: 10px; }

        .sunday-bg { background: rgba(255, 0, 0, 0.05); }
        .past-day { opacity: 0.3; pointer-events: none; }

        /* 3. 時段按鈕格式 (共用) */
        .time-label { 
            display: flex;
            align-items: center;
            justify-content: center;
            width: 94%;
            background: rgba(201, 184, 150, 0.12); 
            color: var(--gold-main); 
            margin: 1.5px auto !important; 
            height: 18px; 
            border-radius: 2px; 
            font-size: 8px; 
            letter-spacing: -0.5px;
            line-height: 1;
        }
            
        @media (min-width: 768px) {
            .time-label { font-size: 11px; height: 24px; border-radius: 3px; margin: 2px auto !important; }
        }

        body.admin-mode .time-label { background: rgba(0,0,0,0.1); color: var(--gold-main); font-weight: bold; }
        .ask-mode .time-label { cursor: pointer; border: 0.5px solid var(--gold-main); box-sizing: border-box; }
        .ask-mode .time-label.selected { background: #800020 !important; color: white !important; transform: scale(1.05); }

        /* 4. 注意事項彈窗 (移除動畫，解決從小變大的問題) */
        .notice-glass-modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(10, 25, 18, 0.95); 
            z-index: 7000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            opacity: 1; /* 確保直接顯示 */
            backdrop-filter: blur(10px);
            /* 關鍵：不設定 animation */
            transition: none !important;
        }
        
        .notice-content-card {
            width: 100%;
            max-width: 360px;
            background: #1c3328;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid rgba(201, 184, 150, 0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            /* 確保卡片本身也沒有縮放動畫 */
            transform: none !important; 
            animation: none !important;
        }

        .notice-item-border {
            border-left: 2px solid var(--gold-main);
            padding-left: 15px;
            margin-bottom: 20px;
        }
        
        .notice-item-border p.font-bold,
        .notice-item-border .gold-text,
        .notice-item-border a {
            color: var(--gold-main) !important;
            fill: var(--gold-main) !important;
        }
        
        .notice-item-border a:hover {
            color: var(--gold-main) !important;
            opacity: 0.8;
        }

        /* 後台管理按鈕 */
        .admin-day-controls { display: none; grid-template-columns: 1fr 1fr; gap: 2px; margin-top: auto; }
        body.admin-mode .admin-day-controls { display: grid; }
        .tiny-btn { font-size: 8px; text-align: center; padding: 2px 0; cursor: pointer; background: rgba(0,0,0,0.1); }
        .tiny-btn.edit { background: var(--gold-main); color: white; }

        /* 詢問按鈕 */
        .ask-action-btn { 
            background: #800020; color: white; padding: 12px 30px; border-radius: 30px; 
            font-weight: bold; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: inline-block;
        }
        .confirm-action-btn {
            background: #1a4731; color: white; padding: 12px 30px; border-radius: 30px; 
            font-weight: bold; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
        }

        /* 模態視窗 (Modal) */
        .cal-modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; 
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .cal-modal-content {
            background: var(--forest-bg); border: 1px solid var(--gold-main); 
            border-radius: 20px; padding: 25px; width: 100%; max-width: 320px;
            color: var(--white-main); text-align: center; position: relative;
            display: flex;              /* 啟用 Flex 佈局 */
            flex-direction: column;     /* 上下排列 */
            max-height: 80vh;
        }
        body.admin-mode .cal-modal-content { background: #fff; color: #333; }
        
        .copy-btn { 
            width: 100%; 
            padding: 12px; 
            background: #1a4731; 
            color: white; 
            border-radius: 10px; 
            margin-top: 10px; 
            border: 1px solid var(--gold-main); /* 新增這行 */
        }

        /* --- [NEW] 財務行事曆專用樣式 --- */
        .fin-stat-header { display: flex; justify-content: space-between; align-items: flex-end; padding: 0 15px 15px; border-bottom: 1px solid rgba(201, 184, 150, 0.2); margin-bottom: 15px; }
        .fin-stat-group { text-align: right; }
        .fin-stat-label { font-size: 10px; color: var(--gold-main); opacity: 0.8; letter-spacing: 1px; }
        .fin-stat-val { font-size: 16px; font-weight: 700; color: var(--white-main); font-family: 'Playfair Display', serif; }
        .fin-day-header { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; color: var(--white-sec); }
        .is-holiday { color: #ff6b6b !important; }
        /* 財務頁面的假日樣式優化 */
        .is-holiday-bg { 
            background: rgba(255, 150, 150, 0.1) !important; /* 透明紅底 */
            border: 1px solid rgba(255, 107, 107, 0.4) !important; /* 精緻紅框 */
        }

        /* 讓假日日期數字更有設計感 */
        .is-holiday-bg .fin-day-header span.text-\[#ff6b6b\] {
            color: #ff6b6b;
            text-shadow: 0 0 8px rgba(255, 107, 107, 0.4);
            font-weight: 800;
        }
        
        /* 預約條目 - Flex 佈局優化 */
        .fin-item { 
            font-size: 10px !important; 
            font-weight: 500; 
            letter-spacing: 0.05em;
            /* 關鍵：改用 Flex 讓符號強制顯示 */
            display: flex !important; 
            justify-content: space-between !important;
            align-items: center !important;
            
            border: none !important;
            border-left: 3px solid transparent !important; 
            padding: 2px 4px !important; /* 稍微縮小內距 */
            margin: 1px 0 2px 0 !important; 
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(4px);
            border-radius: 0 4px 4px 0; 
            color: var(--white-main);
            box-shadow: none !important; 
        }

        /* [一般客人] 的邊條顏色 - 金色 */
        .fin-item:not(.is-model):not(.is-note):not(.is-price-view) {
            border-left-color: var(--cal-gold) !important;
        }

        /* [手模] 的邊條顏色 - 深綠色 */
        .fin-item.is-model {
            border-left-color: #184629 !important;
        }
        /* [純金額顯示] 優化：靠左、無符號、綠框改金框(可選) */
        .fin-item.is-price-view { 
            background: transparent !important; 
            border: 1px solid #1a4731 !important; 
            color: var(--gold-main) !important; 
            
            /* [修正] 改為靠左對齊 */
            justify-content: flex-start !important; 
            text-align: left !important;
            padding-left: 6px !important; /* 左邊留點呼吸空間 */
        }
        
        /* 確保裡面的文字也靠左 */
        .fin-item.is-price-view span {
            text-align: left !important;
            flex: 1 !important; /* 讓它佔滿剩餘空間 */
        }
        .fin-item.is-note {
            background: rgba(255, 107, 107, 0.15) !important; /* 淡紅底 */
            color: #ff6b6b !important; /* 紅字 */
            font-weight: 700 !important;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        /* 針對條目內的文字 (處理截斷問題) */
        .fin-item span.flex-1 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip; /* 不使用省略號 (...) */
            
            /* [關鍵技術] 漸層遮罩：讓文字尾端最後 15% 自然淡出 */
            /* 這樣就不會看到「只剩一點點筆畫」的醜切斷面 */
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }

        /* 週結算列 */
        .weekly-row { 
            grid-column: 1 / -1; 
            background: rgba(201, 184, 150, 0.1); 
            border-radius: 6px; 
            margin: 5px 0 15px; 
            padding: 8px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 11px;
        }
        
        /* 底部總結 */
        .fin-footer {
            display: flex; gap: 15px; justify-content: center; margin-top: 20px;
            font-size: 11px; color: var(--gold-main);
        }
        .fin-footer div span { display: block; font-size: 15px; font-weight: 700; color: var(--white-main); margin-top: 2px; }

        /* 切換按鈕 */
        .view-toggle-btn { 
            background: transparent; border: 1px solid var(--gold-main); color: var(--gold-main); 
            border-radius: 20px; padding: 4px 12px; font-size: 11px; cursor: pointer; 
        }
        .view-toggle-btn.active { background: var(--gold-main); color: var(--forest-bg); font-weight: bold; }
    
        /* --- [更新] 財務系統樣式優化 --- */
        
        /* 1. 當日詳情彈窗樣式 */
        .day-detail-list { 
            flex: 1;                 /* 自動佔用 header 與 footer 之間的所有空間 */
            overflow-y: auto;        /* 內容超過時顯示滾動條 */
            min-height: 0;           /* 防止 flex 子元素溢出 */
            margin-bottom: 15px; 
        }
        .day-detail-item { 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(201, 184, 150, 0.1);
            padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;
            transition: all 0.2s;
        }
        .day-detail-item:active { transform: scale(0.98); background: rgba(201, 184, 150, 0.1); }

        /* 2. 服務項目按鈕 (解決看不清字的問題) */
        .item-option-btn {
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white-sec);
            background: transparent;
            padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 500;
            cursor: pointer; text-align: left;
            transition: all 0.2s;
            /* 強制文字單行並截斷 */
            white-space: nowrap; overflow: hidden; text-overflow: clip;
        }
        /* 滑鼠移入或選中：深藍底 + 白字 */
        .item-option-btn:hover, .item-option-btn.active {
            background-color: #0f241d !important; /* 深藍/深綠色 */
            color: #ffffff !important;
            border-color: var(--gold-main);
            font-weight: 700;
        }

        /* 3. 已選項目列表 (固定格式 + 刪除) */
        .selected-list-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 12px;
        }
        .selected-name {
            white-space: nowrap; overflow: hidden; text-overflow: clip;
            color: var(--gold-main);
        }
        .del-item-btn {
            color: #ff6b6b; font-weight: bold; padding: 2px 8px;
            cursor: pointer; opacity: 0.7;
        }
        /* [新增] 清單內的小型價格輸入框 */
        .item-price-input {
            width: 60px;
            background: transparent;
            border: none;
            border-bottom: 1px solid #ccc; /* 底部有線，暗示可編輯 */
            text-align: right;
            font-weight: bold;
            color: #1a3a2e; /* 深綠色 */
            font-size: 13px;
            padding: 0 2px;
            border-radius: 0;
        }
        /* [新增] 清單內的小型時長輸入框 */
        .item-duration-input {
            width: 35px;
            background: transparent;
            border: none;
            border-bottom: 1px dashed #ccc; /* 虛線區隔 */
            text-align: center;
            color: #666;
            font-size: 11px;
            padding: 0;
            margin-right: 4px;
        }
        .item-duration-input:focus {
            outline: none;
            border-bottom: 1px solid var(--gold-main);
            color: var(--gold-main);
        }
        
        /* 類別切換按鈕 */
        .cat-tab-btn {
            flex: 1; padding: 6px 0; font-size: 11px; text-align: center;
            background: rgba(255,255,255,0.05); color: var(--white-sec);
            border: 1px solid transparent; cursor: pointer;
        }
        .cat-tab-btn.active {
            background: var(--gold-main); color: var(--forest-bg); font-weight: bold;
        }
        .cat-tab-group {
            display: flex; border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* 滿版提示 (Overlay Message) */
        .overlay-message-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .overlay-message {
            text-align: center;
            font-weight: bold;
            color: var(--gold-main);
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            padding: 20px;
            background: rgba(26, 58, 46, 0.9);
            border-radius: 12px;
            border: 1px solid var(--gold-main);
            margin: 0 20px;
            line-height: 1.6;
        }
        .overlay-message h3 { font-size: 20px; margin-bottom: 10px; color: #fff; }
        .overlay-message p { font-size: 14px; opacity: 0.9; }

        /* Top Button */
        /* [修改] Top 按鈕：縮小尺寸與字體，增加精緻感 */
        .scroll-top-btn {
            position: fixed; bottom: 90px; right: 20px; /* 位置微調 */
            width: 36px !important; height: 36px !important; /* 變小 */
            background: rgba(201, 184, 150, 0.9); /* 半透明金 */
            color: #1a3a2e;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px !important; /* 字變小 */
            font-weight: 800;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* 懸浮陰影 */
            z-index: 999; cursor: pointer; opacity: 0; visibility: hidden;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
        }
        .scroll-top-btn.show { opacity: 1; visibility: visible; }

        /* [新增] 高級立體質感 (High-End 3D) - 用於卡片 */
        .m-card { 
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            border-top: 1px solid rgba(255, 255, 255, 0.15) !important; /* 頂部高光 */
            border-bottom: 1px solid rgba(0, 0, 0, 0.3) !important; /* 底部陰影 */
            border-radius: 16px !important; 
            padding: 25px !important; margin: 0 8% 25px 8% !important; 
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.4) !important; /* 深邃陰影 */
            width: auto !important; 
            backdrop-filter: blur(10px);
        }

        /* [新增] 輸入框立體凹陷感 */
        .edit-input, #admin-pwd, textarea {
            background: rgba(0, 0, 0, 0.2) !important;
            border: none !important;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); /* 內部陰影 */
            color: #fff !important;
            border-bottom: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        /* [新增] 按鈕立體浮起感 */
        .ask-action-btn, .confirm-action-btn, .login-action-btn, .setting-btn {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.2) !important;
            transition: transform 0.1s;
        }
        .ask-action-btn:active, .confirm-action-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; backdrop-filter: blur(0px); }
            to { opacity: 1; backdrop-filter: blur(10px); }
        }

        /* 非首頁時，縮減 Header 底部留白，讓 Logo 距離內容更近 */
        .brand-header.header-compact {
            padding-bottom: 0 !important; /* 取消原本的 25px */
        }
        
        /* 財務管理標題置中專用 */
        .fin-title-container {
            position: relative;
            display: flex;
            justify-content: center; /* 標題置中 */
            align-items: center;
            padding: 24px 16px 16px; /* pt-6 px-4 mb-4 的對應 */
            margin-bottom: 16px;
        }
        /* 按鈕強制靠右 */
        .fin-right-btn {
            position: absolute;
            right: 16px;
        }

        /* --- [修正] 日曆系統手機版瘦身 --- */
        .day-box, .fin-day-box { 
            /* 手機版高度縮小，原本是 110px */
            min-height: 85px !important; 
        }

        /* 讓裡面的文字與條列更緊湊 */
        .fin-item {
            font-size: 8px !important;      /* 字體縮小 */
            padding: 1px 4px !important;    /* 內距縮小 */
            margin: 1px 0 2px 0 !important; /* 間距縮小 */
            line-height: 1.3 !important;
        }

        /* 預約時段按鈕也縮小 */
        .time-label {
            height: 15px !important;
            font-size: 8px !important;
            margin: 1px auto !important;
        }

        /* 電腦版維持原本大氣的配置 */
        @media (min-width: 768px) {
            .day-box, .fin-day-box { min-height: 150px !important; }
            .fin-item { font-size: 11px !important; padding: 4px 8px !important; }
            .time-label { height: 24px !important; font-size: 11px !important; }
            
            /* [修正] 計算機電腦版太寬的問題 -> 限制最大寬度 */
            #page-admin-calc .app-container {
                max-width: 500px !important; /* 限制寬度 */
                margin: 0 auto !important;
            }
        }

        /* [修改] 財務日曆格子底部 - 上下班時間顯示 */
        .fin-day-footer {
            margin-top: auto;
            padding-top: 4px;
            border-top: 1px dashed rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            
            /* 手機版設定：字小 + 間距緊 */
            font-size: 9px !important; 
            letter-spacing: -0.5px !important; /* [新增] 字距變窄 */
            
            font-family: 'Outfit', sans-serif;
            opacity: 0.8;
        }

        /* [新增] 電腦版設定 (平板以上)：字體恢復，間距正常 */
        @media (min-width: 768px) {
            .fin-day-footer {
                font-size: 12px !important;
                letter-spacing: 0 !important;
            }
        }

        /* 左邊上班，右邊下班 (顏色維持) */
        .fin-day-footer .start-time { color: var(--gold-main); font-weight: 700; }
        .fin-day-footer .end-time { color: var(--white-sec); }

        /* --- [新增] 後台價目表整合分頁樣式 --- */
        .admin-sub-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; padding: 0 10px; }
        .admin-sub-tab-btn { flex: 1; padding: 10px 0; text-align: center; border-radius: 30px; font-size: 13px; font-weight: 700; color: var(--gold-main); border: 1px solid var(--gold-main); background: transparent; transition: all 0.3s; }
        .admin-sub-tab-btn.active { background: var(--gold-main); color: var(--forest-bg); }

        /* --- [新增] 預約視窗項目分區標題 --- */
        .fe-section-title { grid-column: span 2; font-size: 11px; color: var(--gold-main); font-weight: 700; margin-top: 10px; margin-bottom: 5px; padding-bottom: 2px; border-bottom: 1px dashed rgba(201, 184, 150, 0.3); letter-spacing: 1px; }

        /* --- [新增] 數量輸入框樣式 --- */
        .item-qty-input { width: 30px; background: transparent; border: none; border-bottom: 1px solid #ccc; text-align: center; font-size: 11px; color: #333; margin-right: 4px; }
        .item-qty-input:focus { outline: none; border-color: var(--gold-main); }

        /* --- [新增] 圖片上傳預覽 --- */
        .img-upload-box { margin-top: 10px; border: 1px dashed #ccc; border-radius: 8px; padding: 10px; text-align: center; position: relative; background: rgba(255,255,255,0.05); }
        .img-preview { max-width: 100%; max-height: 150px; border-radius: 4px; margin-top: 5px; display: none; }
        .img-preview.show { display: block; margin: 5px auto 0; }

        /* --- [新增] 圖片全螢幕預覽 Modal --- */
        #img-preview-overlay {
            position: fixed; 
            inset: 0; 
            z-index: 10000; /* 確保在最上層 */
            background: rgba(0,0,0,0.95); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s ease; 
            backdrop-filter: blur(5px);
        }
        #img-preview-overlay.active { 
            opacity: 1; 
            pointer-events: auto; 
        }
        #img-preview-overlay img { 
            max-width: 95vw; 
            max-height: 85vh; 
            object-fit: contain; 
            border-radius: 4px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
        }
        .pv-btn {
            position: absolute; 
            top: 40px; /* 避開瀏海區 */
            width: 44px; 
            height: 44px;
            background: rgba(255,255,255,0.15); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            z-index: 10001; 
            font-size: 18px; 
            backdrop-filter: blur(4px); 
            transition: all 0.2s;
        }
        .pv-btn:active { 
            transform: scale(0.9); 
            background: rgba(255,255,255,0.3); 
        }
        .pv-close { left: 20px; }  /* 叉叉改到左邊 */
        .pv-dl { right: 20px; }    /* 下載改到右邊 */

        /* --- [NEW] 結帳與詳情視窗專用樣式 --- */
        
        /* 狀態標籤 */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }
        .status-pending { background: rgba(255, 255, 255, 0.1); color: #ccc; border: 1px solid #666; }
        .status-checked { background: #1a4731; color: var(--gold-main); border: 1px solid var(--gold-main); }
        .status-noshow { background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid #ff6b6b; }

        /* 定金選擇按鈕 (取代原本的 checkbox) */
        .dep-opt-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            background: #fff;
            transition: all 0.2s;
        }
        .dep-opt-btn.active {
            background: var(--gold-main);
            color: #1a3a2e;
            border-color: var(--gold-main);
            font-weight: bold;
        }

        /* 結帳列表項目 */
        .checkout-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid #eee;
            cursor: pointer;
        }
        .checkout-item:active { background: #f9f9f9; }
        .checkout-price-group { text-align: right; }
        .checkout-final-price { font-weight: 700; color: #1a3a2e; font-size: 15px; }
        .checkout-discount-tag { font-size: 10px; color: #ff6b6b; display: block; }

        /* 折扣按鈕網格 */
        .discount-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .disc-btn {
            padding: 8px 0;
            text-align: center;
            background: #f5f2ee;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            color: #555;
        }
        .disc-btn:active { background: #ddd; }

        /* 支付方式列 */
        .pay-method-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .pay-method-row:last-child { border-bottom: none; }
        .pay-method-row.selected { background: rgba(201, 184, 150, 0.1); }
        .pay-radio {
            width: 18px; height: 18px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 10px;
            position: relative;
        }
        .pay-method-row.selected .pay-radio {
            border-color: var(--gold-main);
            background: var(--gold-main);
        }

        /* --- [02/14 修正版] 視覺優化 --- */

        /* 1. 月曆上的小條目：結帳後變「透白底 + 深綠字 + 深綠框」 */
        .fin-item.status-checked {
            background: rgba(180, 223, 247, 0.5) !important; /* 透白底 */
            border-left: 3px solid #1a4731 !important;        /* 強制深綠框 */
            color: #1a4731 !important;                        /* 強制深綠字 */
            font-weight: 700 !important;
        }
        
        /* 修正：讓原本的金/綠邊框邏輯只在「非結帳」狀態下生效 */
        .fin-item:not(.status-checked):not(.is-model):not(.is-note):not(.is-price-view) {
            border-left-color: var(--cal-gold) !important;
        }
        .fin-item:not(.status-checked).is-model {
            border-left-color: #184629 !important;
        }

        /* 2. 當日行程列表卡片：已結帳變「淺綠底」 */
        .day-detail-item.status-checked {
            background: #e6f4ea !important; /* 淺綠底 */
            border: 1px solid #34d399 !important; /* 綠框 */
        }
        /* 讓淺綠卡片裡面的文字深一點，比較好讀 */
        .day-detail-item.status-checked .text-gray-400,
        .day-detail-item.status-checked .text-\[\#c9b896\] { 
            color: #065f46 !important; /* 深綠字 */
        }
        .day-detail-item.status-checked .text-\[\#4b3621\] {
            color: #047857 !important;
        }

        /* 3. 爽約按鈕樣式 */
        .btn-noshow {
            font-size: 10px;
            padding: 2px 8px;
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            background: transparent;
            border-radius: 12px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-noshow:hover {
            background: #ff6b6b;
            color: white;
        }

        /* 4. 強制金色字體 (給星期/時段用) */
        .text-gold-force { color: var(--gold-main) !important; }

        /* [新增] 結算頁面專用樣式 */
        .settle-btn { 
            padding: 4px 6px !important;       /* 縮小左右內距 (原本 12px -> 6px) */
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: 1px solid transparent; 
            margin-right: 2px !important;      /* 縮小右邊間距 (原本 10px -> 2px) */
            white-space: nowrap !important;    /* 關鍵：強制文字不換行 */
            flex-shrink: 0 !important;         /* 關鍵：防止按鈕被壓扁 */
        }
        .settle-btn-main { background: var(--gold-main); color: #1a3a2e; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .settle-btn-outline { border-color: var(--gold-main); color: var(--gold-main); background: transparent; }
        
        .settle-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .settle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #eee; cursor: pointer; }
        .settle-title { font-size: 14px; font-weight: 700; color: #1a3a2e; display: flex; align-items: center; gap: 6px; }
        .settle-total { font-size: 16px; font-weight: 800; color: #1a3a2e; font-family: 'Playfair Display', serif; }
        
        .settle-detail-row { display: flex; justify-content: space-between; font-size: 11px; padding: 6px 0; color: #666; border-bottom: 1px solid #f9f9f9; }
        .settle-detail-row:last-child { border-bottom: none; }
        
        /* 鈔票計算機樣式 */
        .cash-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 8px; margin-bottom: 8px; align-items: center; }
        .cash-label { font-size: 13px; font-weight: bold; color: #555; text-align: right; padding-right: 10px; }
        .cash-input { background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; padding: 6px 10px; font-size: 14px; text-align: right; width: 100%; font-weight: bold; color: #333; }
        .cash-input:focus { border-color: var(--gold-main); background: #fff; outline: none; }
        
        .alloc-btn { padding: 8px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 12px; color: #666; cursor: pointer; background: #fff; transition: all 0.2s; }
        .alloc-btn:active { background: #1a3a2e; color: var(--gold-main); border-color: #1a3a2e; }
        
        /* 唯讀與結算狀態 */
        /* 唯讀模式：禁止滑鼠事件，透明度降低 */
        .readonly-mode .cash-input, 
        .readonly-mode .alloc-btn { 
            pointer-events: none !important; 
            opacity: 0.7; 
            background: #e5e7eb !important; /* 灰色底 */
        }
        .settled-badge { display: inline-block; background: #1a4731; color: var(--gold-main); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; margin-left: 10px; }

        /* --- [NEW] 財務報表專用樣式 --- */
        .report-tabs { display: flex; gap: 10px; margin-bottom: 15px; padding: 0 10px; }
        .report-tab-btn { flex: 1; padding: 8px; text-align: center; border-radius: 8px; font-size: 13px; font-weight: 700; color: var(--gold-main); border: 1px solid var(--gold-main); background: transparent; transition: all 0.3s; }
        .report-tab-btn.active { background: var(--gold-main); color: var(--forest-bg); }

        /* 財務日曆格子 (與預約格子區分) */
        .fin-cal-cell { font-size: 8px; line-height: 1.2; text-align: left; overflow: hidden; height: 100%; display: flex; flex-direction: column; padding-top: 2px; }
        .fin-cal-row { display: flex; justify-content: space-between; margin-bottom: 0px; color: #555 !important;font-weight: 600; }
        .fin-cal-total { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 1px; text-align: right; font-weight: bold; color: var(--gold-main); font-size: 9px; }

        /* 報表卡片 */
        .report-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .report-section-title { font-size: 14px; font-weight: 800; color: #1a3a2e; border-left: 4px solid var(--gold-main); padding-left: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .report-big-stat { font-size: 24px; font-weight: 800; color: #1a3a2e; font-family: 'Playfair Display', serif; text-align: center; margin: 10px 0; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .stat-box { background: #f9f9f9; padding: 10px; border-radius: 8px; text-align: center; }
        .stat-label { font-size: 10px; color: #888; font-weight: 700; }
        .stat-val { font-size: 14px; font-weight: 800; color: #333; }

        /* 支出表單 */
        .expense-form-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .exp-input { flex: 1; background: #f2f2f2; border: 1px solid #ddd; padding: 8px; border-radius: 6px; font-size: 13px; color: #333 !important; }
        .exp-select { background: #f2f2f2; border: 1px solid #ddd; padding: 8px; border-radius: 6px; font-size: 13px; color: #333; }
        
        /* 條列式項目 */
        .list-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 12px; color: #555; }
        .list-row:last-child { border-bottom: none; }
        .list-row.header { font-weight: 800; color: #1a3a2e; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 5px; }

        /* 圓餅圖替代方案 (長條) */
        .bar-container { margin-bottom: 8px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 2px; color: #555; }
        .bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--gold-main); border-radius: 3px; }

        /* --- [修正] 財務頁面文字顏色優化 --- */
        .fin-cal-row { color: #555 !important; font-weight: 600; } 
        .fin-cal-row span:first-child { color: var(--gold-main) !important; font-weight: 800; }
        .fin-cal-row.text-\[#ff6b6b\] { color: #ff6b6b !important; }
        .fin-cal-row.text-\[#ff6b6b\] span:first-child { color: #ff6b6b !important; }
        .fin-cal-total { border-top: 1px solid rgba(0,0,0,0.1) !important; color: #1a3a2e !important; }
        #acc-date-title { color: #1a3a2e !important; }
    
        /* --- 高級自定義數字鍵盤樣式 --- */
        /* --- 優化後的智能鍵盤樣式 --- */
        #custom-numpad {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--nav-bg); /* 使用與導航欄相同的背景色 */
            border-top: 2px solid var(--gold-main);
            z-index: 9999;
            
            /* 動畫設定 */
            transform: translateY(100%);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* 排版 */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            padding: 8px;
            
            padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
            
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
        }
        
        #custom-numpad.active {
            transform: translateY(0);
        }

        /* 按鈕樣式微調 (可選，讓按鈕在小螢幕不要太高) */
        .num-btn {
            background: rgba(245, 241, 232, 0.05);
            color: var(--white-main);
            border: 1px solid rgba(201, 184, 150, 0.1);
            padding: 15px 0; /* 稍微縮小內距 */
            font-size: 20px;
            font-weight: 500;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
        }

        /* 功能鍵配色 */
        .num-op { background: rgba(201, 184, 150, 0.15); color: var(--gold-main); font-weight: 700; }
        .num-del { color: #ff6b6b; }
        .num-confirm { 
            background: var(--gold-main); 
            color: var(--forest-bg); 
            /* grid-column: span 2;  <-- 刪除這一行，讓它變回單格 */
            font-weight: 800; 
            letter-spacing: 2px; 
        }

        /* 讓輸入框在喚起鍵盤時有光暈 */
        .numpad-focus { border: 2px solid var(--gold-main) !important; box-shadow: 0 0 15px rgba(201, 184, 150, 0.4) !important; }

        /* --- 智能鍵盤顯示時的版面調整 (修正版) --- */
        
        /* 1. 撐開主頁面 (針對非彈窗的輸入框) */
        body.numpad-active {
            padding-bottom: 50vh !important;
            transition: padding-bottom 0.2s ease;
        }

        /* 2. ★★★ 關鍵修正：撐開彈窗內部的捲動區域 ★★★ */
        /* 當鍵盤開啟時，強制讓所有彈窗內的捲動容器底部增加 400px 的空白 */
        /* 這樣 el.scrollIntoView() 才有空間把底部的東西捲上來 */
        body.numpad-active .cal-modal-content > .overflow-y-auto,
        body.numpad-active .cal-modal-content .flex-1.overflow-y-auto {
            padding-bottom: 400px !important; 
        }

        /* [修改] 導航欄位容器：確保寬度足夠且不被擠壓 */
        .nav-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 auto 20px;
            padding: 0 15px;
            max-width: 400px;
            position: relative;
        }

        /* [修改] 本月/今年 按鈕樣式 (取消絕對定位，改用 Flex 排列) */
        .today-btn {
            font-size: 10px;
            border: 1px solid var(--gold-main);
            color: var(--gold-main);
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            background: rgba(201, 184, 150, 0.1);
            font-weight: 700;
            transition: all 0.2s;
            margin-right: 5px; /* 與箭頭保持距離 */
            white-space: nowrap;
            /* 移除 position: absolute */
        }
        .today-btn:active {
            background: var(--gold-main);
            color: var(--forest-bg);
        }

        /* [新增] 右側控制區群組 (讓按鈕跟箭頭排在一起) */
        .nav-right-group {
            display: flex;
            align-items: center;
        }

    </style>
</head>
<body>

<div class="app-wrapper">
    <header class="brand-header">
        <div class="logo-box">
    <img id="logo-guest" src="logo-1.png" alt="MEAW ME" class="logo-img">
    <img id="logo-admin" src="logo-2.png" alt="MEAW ME ADMIN" class="logo-img" style="display: none;">
</div>
        <h1 class="studio-name">繆米美學</h1>
        <h1 class="studio-name2">｜MEAW ME BEAUTY｜</h1>

        <div class="studio-subtitle">｜美甲｜美睫｜美容｜</div>
    </header>

    <div id="scrollTopBtn" class="scroll-top-btn" onclick="scrollToTop()">ᴛᴏᴘ</div>

    <section id="page-home" class="page-content active pb-32">
    <div class="text-center px-8 py-4">
        <p style="font-size: 14px; color: #faf3e0; line-height: 1.8; letter-spacing: 1.5px;">
            店內有兩位貓店店長 會神出鬼沒的視察、陪伴及療癒客人。<br><br>
            致力於提供最舒適的一站式美業工作室<br>
            結合美甲、美睫、美容三個項目<br>
            讓每位客人都能以最高的品質 輕鬆還原美貌。
        </p>
    </div>
    
    <div class="m-card">
        <h2 class="info-title">營業時間</h2>
        <div class="flex justify-between text-[14px] mb-2">
            <span>週一至週六</span>
            <span style="color: #faf3e0;">10:00 - 22:00</span>
        </div>
        <div class="flex justify-between text-[14px]">
            <span>週日</span>
            <span style="color: #faf3e0;">公休</span>
        </div>
    </div>

    <div class="m-card">
        <h2 class="info-title">付款方式</h2>
        <div class="text-[14px] space-y-1" style="color: #faf3e0;">
            <div>現金</div>
            <div>轉帳</div>
            <div>街口支付</div>
            <div>LINE PAY</div>
        </div>
    </div>

    <div class="m-card">
        <h2 class="info-title">地址</h2>
        <p class="text-[14px]" style="color: #faf3e0;">中壢SOGO附近</p>
        <a href="https://maps.app.goo.gl/zhXE9N28NodmVeHf7?g_st=ipc" class="map-button" style="background: var(--gold-main); color: var(--forest-bg); width: 100%; padding: 10px; border-radius: 8px; text-align: center; font-size: 14px; font-weight: 600; display: block; margin-top: 15px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.2);">開啟 Google 地圖</a>
    </div>

    <div class="m-card">
        <h2 class="info-title">聯絡我們</h2>
        <a href="https://www.instagram.com/meawme.beauty?igsh=eDRjZGFtNTcyY28y" target="_blank" class="contact-card" style="display: flex; align-items: center; background: var(--btn-bg); border: 1px solid var(--border-base); padding: 12px; border-radius: 10px; margin-top: 10px; text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <svg class="social-icon" style="width: 26px; height: 26px; stroke: var(--gold-main); fill: none; margin-right: 15px;" viewBox="0 0 24 24" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
            <div>
                <div class="text-[15px] font-semibold text-white">Instagram</div>
                <div class="text-[12px] text-[var(--grey-green)]">｜作品集｜不回覆訊息｜</div>
            </div>
        </a>
        <a href="https://lin.ee/kv6nqyW" target="_blank" class="contact-card" style="display: flex; align-items: center; background: var(--btn-bg); border: 1px solid var(--border-base); padding: 12px; border-radius: 10px; margin-top: 10px; text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <svg class="social-icon" style="width: 26px; height: 26px; stroke: var(--gold-main); fill: none; margin-right: 15px;" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke="currentColor"><path d="M21 11.5C21 7.02 16.97 3.5 12 3.5S3 7.02 3 11.5C3 15.48 6.15 18.73 10.35 19.38C10.74 19.45 11.02 19.64 10.92 20.03C10.82 20.42 10.45 21.68 10.45 21.68C10.35 22.07 10.66 21.82 11.16 21.49C11.66 21.16 14.16 19.49 15.34 18.73C18.66 18.15 21 15.11 21 11.5Z"></path><text x="12" y="13" font-family="Arial" font-size="4" font-weight="bold" fill="currentColor" text-anchor="middle">LINE</text></svg>
            <div>
                <div class="text-[15px] font-semibold text-white">LINE</div>
                <div class="text-[12px] text-[var(--grey-green)]">｜加入LINE@詢問｜</div>
            </div>
        </a>
    </div>
</section>

    <section id="page-notice" class="page-content pb-32">
    <h2 class="section-title" style="font-size: 22px; font-weight: 600; color: var(--gold-main); text-align: center; margin: 25px 0 15px; letter-spacing: 2px;">預約須知</h2>
    <p class="text-[13px] text-center text-[#8b9d8a] mb-6">（預約視同同意）</p>
    
    <div class="m-card">
        <h3 class="info-title">預約方式</h3>
        <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">〚全預約制〛需提前3天預約</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">請加入LINE@，進入預約系統</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">時段可上預約系統查看</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">釋出空檔會在LINE VOOM當月優惠的留言區</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">定金需於12小時內完成支付，會於當日消費折抵</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">當天請『準時』抵達，請勿〚遲到/提早〛超過10分鐘</li>
        </ul>
    </div>

    <div class="m-card">
        <h3 class="info-title">預約規範</h3>
        <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">遲到超過10分鐘視為取消</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">取消、更改需提前3天告知</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">臨時取消、更改或無故未到，定金不退</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">當月取消三次，則無法預約</li>
        </ul>
    </div>

    <div class="m-card">
        <h3 class="info-title">付款方式</h3>
        <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">接受現金、轉帳、街口支付、LINE PAY</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">服務完成於現場結帳</li>
        </ul>
    </div>

    <div class="m-card">
        <h3 class="info-title">重要提醒</h3>
        <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">禁止攜伴</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">店內有貓，如會過敏請三思</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">工作室禁止吃東西，請提前用餐</li>
            <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">過程中若有不適、不滿意的情況請當下即反應</li>
        </ul>
    </div>
</section>

    <section id="page-nail" class="page-content pb-32">
    <h2 class="section-title" style="font-size: 22px; font-weight: 600; color: var(--gold-main); text-align: center; margin: 25px 0 15px; letter-spacing: 2px;">美甲服務</h2>
    
    <div class="dropdown-container">
        <div class="dropdown-header" onclick="toggleDropdown(this)">
            <span class="dropdown-title">預約須知 <small style="font-size:12px; color:var(--grey-green)">*預約視同同意</small></span>
            <span class="dropdown-arrow">﹀</span>
        </div>
        <div class="dropdown-content">
            <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>請保持預約當天指甲超過指肉至少3mm</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>不然修出來的形狀不好看</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>操作時無法包邊，導致牢固性不佳</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>只要指甲上殘有凝膠，都需預約卸甲</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>若未預約當天會加收$500趕工費或取消不退定金。</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>無足部美甲</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>病甲、問題甲預約請先溝通再預約</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>未溝通者一律取消，定金不退</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>延甲需提前預約</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>不接受當天臨時告知</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>不挑款，請備註色系或風格／喜好</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>由我設計，不得干涉</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>開運設計需備註提供出生年月日、時間及加強方向</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>由我設計，不得干涉</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>自帶圖需先傳圖報價、討論後做預約</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>未溝通則一律取消，定金不退</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>每一店使用的膠、素材皆不同，無法做到百分之百完美複刻</li>
            </ul>
        </div>
    </div>

    <div class="dropdown-container">
        <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">價目表</span><span class="dropdown-arrow">﹀</span></div>
        <div class="dropdown-content">
            <table class="price-table" style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                <tr><th style="font-size: 14px; color: var(--gold-main); text-align: left; padding: 10px 5px; border-bottom: 1px solid var(--border-base);">項目名稱</th><th class="price-value" style="font-size: 14px; color: var(--gold-main); text-align: left; padding: 10px 5px; border-bottom: 1px solid var(--border-base);">價格</th></tr>
                <tr><td>指甲護理〚裸色〛</td><td class="price-value">$600</td></tr>
                <tr><td>純色〚單色/跳色〛</td><td class="price-value">$700</td></tr>
                <tr><td>貓眼/漸層/法式/鏡面/碎鑽</td><td class="price-value">$800</td></tr>
                <tr><td>自帶圖</td><td class="price-value">$900↑</td></tr>
                <tr><td>不挑款 - 簡約</td><td class="price-value">$900</td></tr>
                <tr><td>不挑款 - 輕奢</td><td class="price-value">$1,000</td></tr>
                <tr><td>開運設計</td><td class="price-value">$1,200</td></tr>
            </table>
        </div>
    </div>

    <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">加購項目</span><span class="dropdown-arrow">﹀</span></div>
                <div class="dropdown-content">
                    <div class="subsection-title">卸甲續作</div>
                    <table class="price-table">
                        <tr><td>本店</td><td class="price-value">$200</td></tr>
                        <tr><td>他店</td><td class="price-value">$300</td></tr>
                    </table>
                    <div class="subsection-title">純卸甲</div>
                    <table class="price-table">
                        <tr><td>本店</td><td class="price-value">$300</td></tr>
                        <tr><td>他店</td><td class="price-value">$500</td></tr>
                    </table>
                    <div class="subsection-title">延甲</div>
                    <table class="price-table">
                        <tr><td>甲片</td><td class="price-value">$50/指</td></tr>
                    </table>
                    <div class="subsection-title">手部SPA護理</div>
                    <table class="price-table">
                        <tr><td>基礎</td><td class="price-value">$500</td></tr>
                        <tr><td>進階</td><td class="price-value">$800</td></tr>
                    </table>
                 </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">常見問題</span><span class="dropdown-arrow">﹀</span></div>
                <div class="dropdown-content">
                    <div class="qa-item"><div class="qa-q">美甲可以維持多久？</div><div class="qa-a">｜ 凝膠美甲通常可以維持 3-4 週，實際時間依個人指甲生長速度及用手習慣決定。建議每 3-4 週回來修補，以保持最佳狀態。</div></div>
                    <div class="qa-item"><div class="qa-q">做完美甲後如何保養？</div><div class="qa-a">｜ 避免使用指甲做事，多多使用指腹。手部易乾燥、起屑，建議多擦指緣油、護手霜來保持手部滋潤。</div></div>
                    <div class="qa-item"><div class="qa-q">為什麼每次做完沒多久指甲都會翹或進空氣？</div><div class="qa-a">｜ 常常使用指尖（包含：敲打、按鍵、摳東西等），凝膠的硬度會比指甲硬，所以受力程度不同，就會導致凝膠與指甲分離。</div></div>
                    <div class="qa-item"><div class="qa-q">為什麼每次卸甲後指甲都會變薄？</div><div class="qa-a">｜ 在美甲師的正常操作下，會在上膠前用海綿拋光輕微刻磨甲面，增加凝膠與甲面的摩擦力，增加其牢固度，但不會導致指甲變薄變軟。會覺得變薄變軟是因為習慣凝膠的硬度與厚度，少了凝膠就會覺得變薄變軟了。</div></div>
                    <div class="qa-item"><div class="qa-q">做指甲後大約多久需要讓指甲休息、呼吸？</div><div class="qa-a">｜ 指甲是代謝出的老廢角質，不需要呼吸。休息與否可聽從美甲師、醫生建議，或是看個人情況。</div></div>
                    <div class="qa-item"><div class="qa-q">美甲太長可以自己剪短嗎？</div><div class="qa-a">｜ 不可以唷！這會讓凝膠與指甲分離導致綠膿桿菌。可用美甲磨板修到合適位置，不可修太短或自行修型。</div></div>
                </div>
            </div>
        </section>

    <section id="page-eyelash" class="page-content pb-32">
    <h2 class="section-title" style="font-size: 22px; font-weight: 600; color: var(--gold-main); text-align: center; margin: 25px 0 15px; letter-spacing: 2px;">美睫服務</h2>
    
            <div class="dropdown-container">
        <div class="dropdown-header" onclick="toggleDropdown(this)">
            <span class="dropdown-title">預約須知 <small style="font-size:12px; color:var(--grey-green)">*預約視同同意</small></span>
            <span class="dropdown-arrow">﹀</span>
        </div>
        <div class="dropdown-content">
            <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>當天請勿化妝</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>避免化妝殘留，導致牢固性降低</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>以下情況請勿預約美睫，避免無法操作</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>眼睛容易過敏</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>雷射未滿一年</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>雙眼皮手術未滿三個月</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>睫毛稀疏狀況嚴重</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>有眼部疾病、傷口</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>避免碰水/水氣</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>嫁接後3至6小時內請勿碰水</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>2天內避免蒸氣室、烤箱、游泳</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>日常維護</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>避免高溫、揉眼、拉扯、使用睫毛夾</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>避免使用油性產品</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>如卸妝油、睫毛膏、或是含油的彩妝</li>
            </ul>
                </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)">
                    <span class="dropdown-title">價目表</span>
                    <span class="dropdown-arrow">﹀</span>
                </div>
                <div class="dropdown-content">
                    <table class="price-table"></table> 

                   <div class="subsection-title" style="color:var(--gold-main); font-weight:700; margin-top:20px; margin-bottom:10px; border-left:3px solid var(--gold-main); padding-left:10px;">
                        睫毛管理
                    </div>
                    <div id="front-eyelash-management"></div> 
                </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">加購項目</span><span class="dropdown-arrow">﹀</span></div>
                <div class="dropdown-content">
                    <div class="subsection-title">下睫毛</div>
                    <table class="price-table"><tr><td>下睫毛</td><td class="price-value">$100</td></tr></table>
                    <div class="subsection-title">卸睫續作</div>
                    <table class="price-table"><tr><td>本店</td><td class="price-value">Free</td></tr><tr><td>他店</td><td class="price-value">$200</td></tr></table>
                    <div class="subsection-title">補睫</div>
                    <table class="price-table">
                        <tr><td>一週內</td><td class="price-value">三折</td></tr>
                        <tr><td>兩週內</td><td class="price-value">五折</td></tr>
                        <tr><td>三週內</td><td class="price-value">七折</td></tr>
                    </table>
                </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">常見問題</span><span class="dropdown-arrow">﹀</span></div>
                <div class="dropdown-content">
                    <div class="qa-item"><div class="qa-q">睫毛可以維持多久？</div><div class="qa-a">｜ 嫁接通常可維持3-4週，建議2-3週回來補。睫毛管理可維持6-8週。</div></div>
                    <div class="qa-item"><div class="qa-q">接睫毛後如何保養？</div><div class="qa-a">｜ 避免揉眼，溫柔清潔。嫁接後3-6小時不碰水，不使用油性卸妝產品。睡覺時盡量側睡，避免壓到睫毛。</div></div>
                    <div class="qa-item"><div class="qa-q">美睫可以自行卸除嗎？</div><div class="qa-a">｜ 不建議唷！需專業卸睫劑，自行卸除可能會傷到睫毛與眼睛。</div></div>
                    <div class="qa-item"><div class="qa-q">可以畫眼妝嗎？</div><div class="qa-a">｜ 可以，但不可使用睫毛膏、睫毛夾與防水眼線液。卸妝時避免使用油性卸妝產品。</div></div>
                    <div class="qa-item"><div class="qa-q">為什麼接完睫毛過後連自己的睫毛也會掉？</div><div class="qa-a">｜ 這是正常的。睫毛有生長週期約28天左右，時間到了就會自然脫落再重新生長，會建議客人大約2-3週回來補睫，以維持美睫的最佳狀態。</div></div>                     
                </div>
            </div>
        </section>

    <section id="page-skin" class="page-content pb-32">
    <h2 class="section-title" style="font-size: 22px; font-weight: 600; color: var(--gold-main); text-align: center; margin: 25px 0 15px; letter-spacing: 2px;">美容服務</h2>
    
            <div class="dropdown-container">
        <div class="dropdown-header" onclick="toggleDropdown(this)">
            <span class="dropdown-title">預約須知 <small style="font-size:12px; color:var(--grey-green)">*預約視同同意</small></span>
            <span class="dropdown-arrow">﹀</span>
        </div>
        <div class="dropdown-content">
            <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>預約前請先私訊LINE@</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>需先諮詢美容師評估狀況</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>定期回來保養</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>效果是長期評估，不能只看單次，肌膚週期為28天</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>加強防曬與補水</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>建議物理防曬，停止使用酸類、美白、去角質產品一週</li>
                <li class="main-item" style="color: var(--white-main); font-weight: 500;"><span class="symbol" style="display: inline-block; width: 1.2em; text-align: center;">｜</span>生活習慣調整</li>
                <li class="sub-item" style="color: var(--grey-green); font-size: 13px;"><span class="symbol-dot" style="display: inline-block; width: 1.2em; text-align: center; margin-left: 1em;">．</span>避免抽菸、喝酒、辛辣食物。一週內避免去溫泉、三溫暖</li>
            </ul>
                </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">價目表</span><span class="dropdown-arrow">﹀</span></div>
                <div class="dropdown-content">
                    <table class="price-table">
                        <tr><th>服務項目</th><th class="price-value">原價</th><th class="price-value">體驗價</th></tr>
                        <tr><td>復活保濕修護</td><td class="price-value">$1,000</td><td class="price-value">$800</td></tr>
                        <tr><td>耳燭舒壓</td><td class="price-value">$1,100</td><td class="price-value">$900</td></tr>
                        <tr><td>面部撥筋</td><td class="price-value">$1,200</td><td class="price-value">$1,000</td></tr>
                        <tr><td>手工清粉刺</td><td class="price-value">$1,300</td><td class="price-value">$1,100</td></tr>
                        <tr><td>ES皮膚管理</td><td class="price-value">$1,500</td><td class="price-value">$1,300</td></tr>
                        <tr><td>藻針喚膚</td><td class="price-value">$1,600</td><td class="price-value">$1,400</td></tr>
                        <tr><td>MTS駐顏粉底</td><td class="price-value">$1,800</td><td class="price-value">$1,500</td></tr>
                    </table>
                </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">加購項目</span><span class="dropdown-arrow">﹀</span></div>
                <div class="dropdown-content">
                    <table class="price-table">
                        <tr>
                            <td>撥筋〚局部｜臉部〛</td>
                            <td class="price-value" style="text-align: right; width: auto;">$300／$500</td>
                        </tr>
                        <tr>
                            <td>耳燭舒壓</td>
                            <td class="price-value" style="text-align: right; width: auto;">$500</td>
                        </tr>
                        <tr>
                            <td>頭部釋壓</td>
                            <td class="price-value" style="text-align: right; width: auto;">$500</td>
                        </tr>
                        <tr>
                            <td>手工清粉刺〚局部〛</td>
                            <td class="price-value" style="text-align: right; width: auto;">$500</td>
                        </tr>
                        <tr>
                            <td>藻針喚膚〚局部〛</td>
                            <td class="price-value" style="text-align: right; width: auto;">$600</td>
                        </tr>
                        <tr>
                            <td>MTS駐顏粉底〚局部〛</td>
                            <td class="price-value" style="text-align: right; width: auto;">$700</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown(this)"><span class="dropdown-title">常見問題</span><span class="dropdown-arrow">﹀</span></div>
                <div class="dropdown-content">
                    <div class="qa-item"><div class="qa-q">多久做一次臉部護理比較好？</div><div class="qa-a">｜ 正常情況下一個月深度清潔保養一次即可。膚況不穩建議一兩週一次。</div></div>
                    <div class="qa-item"><div class="qa-q">為什麼剛做完臉會長痘痘？</div><div class="qa-a">｜ 部分課程是幫助肌膚加速代謝，屬暫時代謝反應，多補水保濕後會逐漸改善。建議療程中有任何不適請向美容師反應，做完保養盡量簡單清爽。</div></div>
                    <div class="qa-item"><div class="qa-q">孕婦可以做美容療程嗎？</div><div class="qa-a">｜ 請預約時告知懷孕狀況，我們會選用溫和產品並調整療程內容。</div></div>
                </div>
            </div>
        </section>

    <section id="page-method" class="page-content pb-32">
            <h2 class="section-title" style="font-size: 22px; font-weight: 600; color: var(--gold-main); text-align: center; margin: 25px 0 15px; letter-spacing: 2px;">預約方式</h2>
            
            <div class="m-card">
                <h3 class="info-title">如何預約</h3>
                <p class="text-[13px] text-[#8b9d8a] mb-4">預約前請詳閱預約須知，預約視同同意</p>
                <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">〚全預約制〛需提前3天預約</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">請加入LINE@，進入預約系統</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">時段可上預約系統查看</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">釋出空檔會在LINE VOOM當月優惠的留言區</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">定金需於12小時內完成支付，會於當日消費折抵</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">當天請『準時』抵達，請勿〚遲到/提早〛超過10分鐘</li>
                </ul>
            </div>

            <div class="m-card">
                <h2 class="info-title">聯絡我們</h2>
                <a href="https://www.instagram.com/meawme.beauty?igsh=eDRjZGFtNTcyY28y" target="_blank" class="contact-card" style="display: flex; align-items: center; background: var(--btn-bg); border: 1px solid var(--border-base); padding: 12px; border-radius: 10px; margin-top: 10px; text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <svg class="social-icon" style="width: 26px; height: 26px; stroke: var(--gold-main); fill: none; margin-right: 15px;" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                    <div>
                        <div class="text-[15px] font-semibold text-white">Instagram</div>
                        <div class="text-[12px] text-[var(--grey-green)]">｜作品集｜不回覆訊息｜</div>
                    </div>
                </a>
                <a href="https://lin.ee/kv6nqyW" target="_blank" class="contact-card" style="display: flex; align-items: center; background: var(--btn-bg); border: 1px solid var(--border-base); padding: 12px; border-radius: 10px; margin-top: 10px; text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <svg class="social-icon" style="width: 26px; height: 26px; stroke: var(--gold-main); fill: none; margin-right: 15px;" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5C21 7.02 16.97 3.5 12 3.5S3 7.02 3 11.5C3 15.48 6.15 18.73 10.35 19.38C10.74 19.45 11.02 19.64 10.92 20.03C10.82 20.42 10.45 21.68 10.45 21.68C10.35 22.07 10.66 21.82 11.16 21.49C11.66 21.16 14.16 19.49 15.34 18.73C18.66 18.15 21 15.11 21 11.5Z"></path>
                        <text x="12" y="13" font-family="Arial" font-size="4" font-weight="bold" fill="currentColor" text-anchor="middle">LINE</text>
                    </svg>
                    <div>
                        <div class="text-[15px] font-semibold text-white">LINE</div>
                        <div class="text-[12px] text-[var(--grey-green)]">｜加入LINE@詢問｜</div>
                    </div>
                </a>
                <a href="https://liff.line.me/2006698321-314ABPEZ" target="_blank" class="contact-card" style="display: flex; align-items: center; background: var(--btn-bg); border: 1px solid var(--border-base); padding: 12px; border-radius: 10px; margin-top: 10px; text-decoration: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <svg class="social-icon" style="width: 26px; height: 26px; stroke: var(--gold-main); fill: none; margin-right: 15px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                        <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"></path>
                    </svg>
                    <div>
                        <div class="text-[15px] font-semibold text-white">夯客</div>
                        <div class="text-[12px] text-[var(--grey-green)]">｜預約系統｜</div>
                    </div>
                </a>
            </div>
            
            <div class="m-card">
                <h3 class="info-title">重要提醒</h3>
                <ul class="bullet-list" style="list-style: none; padding: 0; margin: 0;">
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">禁止攜伴</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">店內有貓，如會過敏請三思</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">工作室禁止吃東西，請提前用餐</li>
                    <li style="font-size: 13.5px; color: var(--white-sec); letter-spacing: 1.2px; margin-bottom: 8px;">過程中若有不適、不滿意的情況請當下即反應</li>
                </ul>
            </div>
        </section>

    <section id="page-booking" class="page-content pb-32">
        <div id="booking-notice-modal" class="notice-glass-modal hidden">
            <div class="notice-content-card">
                <h3 class="serif text-[var(--gold-main)] text-xl mb-6 font-bold tracking-[0.2em] text-center">注意事項</h3>
                <div class="space-y-4 text-xs leading-relaxed mb-8 opacity-90 text-[var(--white-sec)]">
                    <div class="notice-item-border">
                        <p class="font-bold mb-1">1. 優先使用線上系統</p>
                        <p>正式預約請先前往系統查看。若系統已無時段，再透過本頁面進行人工詢問。</p>
                        <a href="https://liff.line.me/2006698321-314ABPEZ" class="inline-block mt-2 px-4 py-2 bg-white/10 border border-gold gold-text rounded-full font-bold text-[10px] tracking-widest">前往預約系統 ❯</a>
                    </div>
                    <div class="notice-item-border">
                        <p class="font-bold mb-1">2. 非即時完成預約</p>
                        <p>本系統僅提供時段查詢與詢問。預約需進入系統或依照官方LINE指示，成功預約會收到通知。</p>
                    </div>
                    <div class="notice-item-border">
                        <p class="font-bold mb-1">3. 內容僅供參考</p>
                        <p>時段會隨即時預約、詢問優先順序、施做時長，實際請以人工確認為準。</p>
                    </div>
                </div>
                <button onclick="closeBookingNotice()" class="w-full py-4 bg-[var(--gold-main)] text-[#1c3328] font-black rounded-xl shadow-lg tracking-widest text-sm">我了解並同意</button>
        </div>
    </div>
    
    <div id="guideModal" class="notice-glass-modal hidden">
        <div class="notice-content-card">
            <h3 class="serif text-[var(--gold-main)] text-2xl mb-8 font-bold tracking-widest text-center">使用方式</h3>
            <div class="space-y-6 mb-10 text-left text-[var(--white-main)]">
                <div class="flex items-start">
                    <div class="bg-[var(--gold-main)] text-[#1c3328] w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 text-xs font-bold">1</div>
                    <p class="text-sm">點選想詢問的時段（最多三個）<br><span class="opacity-50 text-[11px]">※ 請依偏好順序進行選取</span></p>
                </div>
                <div class="flex items-start">
                    <div class="bg-[var(--gold-main)] text-[#1c3328] w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 text-xs font-bold">2</div>
                    <p class="text-sm">點擊「確定選取」並輸入預約項目<br><span class="opacity-50 text-[11px]">例如：指定款A+卸甲</span></p>
                </div>
                <div class="flex items-start">
                    <div class="bg-[var(--gold-main)] text-[#1c3328] w-6 h-6 rounded-full flex items-center justify-center mr-3 flex-shrink-0 text-xs font-bold">3</div>
                    <p class="text-sm">點選「複製文字」並前往 LINE 貼上詢問</p>
                </div>
            </div>
            <button onclick="startAskMode()" class="w-full py-4 bg-[var(--gold-main)] text-[#1c3328] font-black rounded-xl shadow-lg tracking-widest text-sm">開始選取時段</button>
            <button onclick="document.getElementById('guideModal').classList.add('hidden')" class="w-full mt-6 text-xs opacity-40 text-[var(--white-sec)]">暫時取消</button>
        </div>
    </div>
    <div class="max-w-4xl mx-auto px-4 pt-8">
            <h2 class="text-center text-[22px] text-[var(--gold-main)] font-bold my-6 tracking-widest">查詢可預約時段</h2>
        
        <div class="nav-header-container">
            <button onclick="changeBookingMonth(-1)" class="text-[var(--gold-main)] text-xl p-2">❮</button>
            <div id="admin-month-display" class="serif text-xl font-bold tracking-[0.1em] text-[var(--gold-main)]"></div>
            <div class="nav-right-group">
                <button onclick="resetToToday('booking')" class="today-btn">本月</button>
                <button onclick="changeBookingMonth(1)" class="text-[var(--gold-main)] text-xl p-2">❯</button>
            </div>
        </div>

        <div style="position: relative; min-height: 300px;">
            <div class="grid grid-cols-7 gap-[2px] mb-2 px-1 text-center text-[10px] opacity-50 font-bold max-w-[1000px] mx-auto">
                <div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div>
                <div class="text-[#ff6b6b]">SAT</div> <div class="text-[#ff6b6b]">SUN</div>
            </div>
            <div id="booking-calendar-grid" class="calendar-grid"></div>
            
            <div id="calendar-overlay-msg" class="overlay-message-container hidden">
                <div class="overlay-message">
                    <h3 id="overlay-title"></h3>
                    <p id="overlay-desc"></p>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button id="askBtn" onclick="showGuide()" class="ask-action-btn">詢問時段</button>
            <button id="confirmSelectionBtn" onclick="openAskDialog()" class="confirm-action-btn">確定選取</button>
        </div>
    </section>

    <section id="page-admin-pricelist" class="page-content pb-32">
        <h2 style="margin-bottom: 20px !important;">價目表管理</h2>
        
        <div class="admin-sub-tabs" style="flex-wrap: wrap;">
            <button class="admin-sub-tab-btn active" onclick="switchAdminPriceTab('nail-model', this)">手模</button>
            <button class="admin-sub-tab-btn" onclick="switchAdminPriceTab('eyelash-practice', this)">睫模</button>
            <button class="admin-sub-tab-btn" onclick="switchAdminPriceTab('nail', this)">美甲</button>
            <button class="admin-sub-tab-btn" onclick="switchAdminPriceTab('eyelash', this)">美睫</button>
            <button class="admin-sub-tab-btn" onclick="switchAdminPriceTab('skin', this)">美容</button>
        </div>

        <div id="admin-cat-content-nail-model">
            <div class="admin-setting-container"><button class="setting-btn" onclick="toggleEditMode('nail-model')">⚙️ 設置系統 </button></div>
            <div class="admin-section-label">手模專區</div><div id="list-nail-model"></div><div id="add-nail-model"></div>
        </div>

        <div id="admin-cat-content-eyelash-practice" class="hidden">
            <div class="admin-setting-container"><button class="setting-btn" onclick="toggleEditMode('eyelash-practice')">⚙️ 設置系統</button></div>
            <div class="admin-section-label">睫模專區</div><div id="list-eyelash-practice"></div><div id="add-eyelash-practice"></div>
        </div>

        <div id="admin-cat-content-nail" class="hidden">
            <div class="admin-setting-container"><button id="btn-set-nail" class="setting-btn" onclick="toggleEditMode('nail')">⚙️ 設置系統</button></div>
            <div class="admin-section-label">主項目 (價目表)</div><div id="list-nail-main"></div><div id="add-nail-main"></div>
            <div class="admin-section-label">加購項目</div><div id="list-nail-addon"></div><div id="add-nail-addon"></div>
        </div>

        <div id="admin-cat-content-eyelash" class="hidden">
            <div class="admin-setting-container"><button id="btn-set-eyelash" class="setting-btn" onclick="toggleEditMode('eyelash')">⚙️ 設置系統</button></div>
            <div class="admin-section-label">主項目</div><div id="list-eyelash-main"></div><div id="add-eyelash-main"></div>
            <div class="admin-section-label">睫毛管理</div><div id="list-eyelash-model"></div><div id="add-eyelash-model"></div>
            <div class="admin-section-label">加購項目</div><div id="list-eyelash-addon"></div><div id="add-eyelash-addon"></div>
        </div>

        <div id="admin-cat-content-skin" class="hidden">
            <div class="admin-setting-container"><button id="btn-set-skin" class="setting-btn" onclick="toggleEditMode('skin')">⚙️ 設置系統</button></div>
            <div class="admin-section-label">主項目</div><div id="list-skin-main"></div><div id="add-skin-main"></div>
            <div class="admin-section-label">加購項目</div><div id="list-skin-addon"></div><div id="add-skin-addon"></div>
        </div>
    </section>

        <section id="page-admin-calc" class="page-content pb-32">
        <h2 style="font-size: 28px !important; text-align: center !important; margin: 30px 0 10px !important; color: var(--gold-main); font-weight: 800; letter-spacing: 3px;">美甲款式計算機</h2>
        
        <div class="app-container px-4" style="max-width: 500px; margin: 0 auto;">
                <div class="flex bg-white rounded-full p-1 mb-4 shadow-sm border border-gray-100 mx-[4%]">
                    <button id="tab-regular" onclick="switchMode('regular')" class="flex-1 py-1.5 text-[10px] rounded-full transition-all tab-active font-bold">一般顧客</button>
                    <button id="tab-model" onclick="switchMode('model')" class="flex-1 py-1.5 text-[10px] rounded-full transition-all text-gray-400 font-bold">手模專區</button>
                </div>
                <div class="space-y-4">
                     <section>
                        <label class="label-group"><span class="label-zh">款式底價</span></label>
                        <div class="k-card p-2"><div id="basePriceOptions" class="grid grid-cols-2 gap-2"></div></div>
                    </section>
                    <section>
                        <label class="label-group"><span class="label-zh">造型加價</span></label>
                        <div class="k-card p-2.5">
                            <div id="designSelectionGrid" class="design-btn-grid mb-2.5"></div>
                            <div id="designList" class="space-y-1"></div>
                        </div>
                    </section>
                     <section id="section-addons">
                        <label class="label-group"><span class="label-zh">固定加購</span></label>
                        <div class="k-card p-2.5 grid grid-cols-3 gap-2" id="addOnsList"></div>
                    </section>
                    <section>
                        <label class="label-group"><span class="label-zh">卸甲服務</span></label>
                        <div class="k-card p-3">
                            <div class="flex gap-1.5 mb-3" id="removalButtons"></div>
                            <div id="specialRemovalList" class="space-y-2.5 border-t border-gray-50 pt-3"></div>
                        </div>
                    </section>
                    <section>
                        <label class="label-group"><span class="label-zh">額外調整</span></label>
                        <div class="k-card p-2.5">
                            <input type="number" inputmode="numeric" id="adjAmount" class="k-input text-right font-bold" placeholder="輸入金額" oninput="calculate()">
                        </div>
                    </section>
                </div>
            </div>
            <div class="sticky-calc-footer">
                <div class="flex flex-col">
                    <p class="text-[7px] text-gray-400 uppercase font-bold tracking-tighter">Amount</p>
                    <p class="text-xl font-bold text-[#2d4639] leading-none">$<span id="totalDisplay">0</span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetCalculator()" class="text-[10px] text-gray-400 font-bold px-2">清除</button>
                    <button onclick="toggleSheet('bottomSheet', true)" class="px-4 py-1.5 text-[11px] font-bold bg-[#f5f2ee] text-[#2d4639] rounded-full">明細</button>
                    <button id="copyBtn" onclick="copyBill()" class="px-5 py-1.5 text-[11px] font-bold bg-[#2d4639] text-white rounded-full">複製</button>
                </div>
            </div>
        </section>

    <section id="page-budget" class="page-content pb-32">
        <h2 class="text-center text-[22px] font-bold my-6 text-[var(--gold-main)]">時段管理</h2>
        
        <div class="nav-header-container">
    <button onclick="changeBookingMonth(-1)" class="text-[var(--gold-main)] text-xl p-2">❮</button>
    <div id="booking-month-display" class="serif text-xl font-bold tracking-[0.1em] text-[var(--gold-main)]"></div>
    <div class="nav-right-group">
                <button onclick="resetToToday('booking')" class="today-btn">本月</button>
                <button onclick="changeBookingMonth(1)" class="text-[var(--gold-main)] text-xl p-2">❯</button>
            </div>
        </div>

        <div class="text-center mb-4">
            <button onclick="toggleMonthStatus()" id="admin-month-status-btn" class="border border-[var(--gold-main)] text-[var(--gold-main)] px-4 py-2 rounded-full text-xs font-bold mr-2">狀態讀取中</button>
            <button onclick="exportAvailableSlots()" class="bg-[var(--gold-main)] text-[#1a3a2e] px-4 py-2 rounded-full text-xs font-bold shadow-lg">匯出空檔</button>
        </div>

        <div class="grid grid-cols-7 gap-[2px] mb-2 px-1 text-center text-[10px] opacity-50 font-bold max-w-[1000px] mx-auto">
            <div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div>
            <div class="text-[#ff6b6b]">SAT</div> <div class="text-[#ff6b6b]">SUN</div>
        </div>
        <div id="admin-calendar-grid" class="calendar-grid"></div>
    </section>

    <section id="page-admin-finance" class="page-content pb-32">
        <div class="fin-title-container">
            <button onclick="fixLegacyData()" class="view-toggle-btn" style="position: absolute; left: 16px; border-color: #ff6b6b; color: #ff6b6b;">系統校正</button>
            
            <h2 style="margin:0 !important; font-size:20px !important;">預約管理</h2>
            
            <button id="finViewToggle" onclick="toggleFinView()" class="view-toggle-btn fin-right-btn">顯示: 金額</button>
        </div>

        <div class="fin-stat-header">
            <div>
                <div class="fin-stat-label">應休 / 實休</div>
                <div class="fin-stat-val"><span id="stat-target-off">0</span> / <span id="stat-real-off" class="text-[#ff6b6b]">0</span></div>
            </div>
            <div class="text-center">
                <div class="fin-stat-label">服務人數</div>
                <div class="fin-stat-val" id="stat-count">0</div>
            </div>
            <div class="fin-stat-group">
                <div class="fin-stat-label">平均單價</div>
                <div class="fin-stat-val">$<span id="stat-avg">0</span></div>
            </div>
        </div>

        <div class="nav-header-container">
            <button onclick="changeFinMonth(-1)" class="text-[var(--gold-main)] text-xl p-2">❮</button>
            <div id="fin-month-display" class="serif text-xl font-bold tracking-[0.1em] text-[var(--white-main)]"></div>
            <div class="nav-right-group">
                <button onclick="resetToToday('finance')" class="today-btn">本月</button>
                <button onclick="changeFinMonth(1)" class="text-[var(--gold-main)] text-xl p-2">❯</button>
            </div>
        </div>

        <div class="grid grid-cols-7 gap-[2px] mb-2 px-1 text-center text-[10px] opacity-50 font-bold max-w-[1000px] mx-auto">
            <div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div>
            <div class="text-[#ff6b6b]">SAT</div> <div class="text-[#ff6b6b]">SUN</div>
        </div>

        <div id="finance-calendar-grid" class="calendar-grid"></div>

        <div class="fin-footer">
            <div class="text-center">
                總計 (本月)
                <span id="stat-month-total">$0</span>
            </div>
            <div class="text-center">
                預估實收 (扣定金)
                <span id="stat-month-real">$0</span>
            </div>
        </div>
    </section>

<section id="page-admin-report" class="page-content pb-32">
    <h2 style="font-size: 28px !important; text-align: center !important; margin: 30px 0 10px !important; color: var(--gold-main); font-weight: 800; letter-spacing: 3px;">財務報表</h2>

    <div class="report-tabs">
        <button class="report-tab-btn active" onclick="switchReportTab('calendar', this)">日報表</button>
        <button class="report-tab-btn" onclick="switchReportTab('month', this)">月報表</button>
        <button class="report-tab-btn" onclick="switchReportTab('year', this)">年報表</button>
    </div>

    <div id="report-view-calendar">
        <div class="nav-header-container">
            <button onclick="changeReportCalendarMonth(-1)" class="text-[var(--gold-main)] text-xl p-2">❮</button>
            <div id="rep-cal-month-display" class="serif text-xl font-bold tracking-[0.1em] text-[var(--white-main)]"></div>
            <div class="nav-right-group">
                <button onclick="resetToToday('report-cal')" class="today-btn">本月</button>
                <button onclick="changeReportCalendarMonth(1)" class="text-[var(--gold-main)] text-xl p-2">❯</button>
            </div>
        </div>
        
        <div class="grid grid-cols-7 gap-[2px] mb-2 px-1 text-center text-[10px] opacity-50 font-bold max-w-[1000px] mx-auto">
            <div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div>
            <div class="text-[#ff6b6b]">SAT</div> <div class="text-[#ff6b6b]">SUN</div>
        </div>
        <div id="report-calendar-grid" class="calendar-grid"></div>
        
        <div class="fin-footer mt-4">
            <div class="text-center">本月營收 <span id="cal-month-rev">$0</span></div>
            <div class="text-center text-[#ff6b6b]">本月支出 <span id="cal-month-exp">$0</span></div>
            <div class="text-center text-[var(--gold-main)]">淨利 <span id="cal-month-net">$0</span></div>
        </div>
    </div>

    <div id="report-view-month" class="hidden px-4 max-w-2xl mx-auto text-[#333]">
        <div class="nav-header-container">
            <button onclick="changeReportDate('month', -1)" class="text-[var(--gold-main)] text-lg px-4">❮</button>
            <span id="report-month-title" class="font-bold text-[#333] text-lg"></span>
            <div class="nav-right-group">
                <button onclick="resetToToday('report-month')" class="today-btn !border-[#333] !text-[#333]">本月</button>
                <button onclick="changeReportDate('month', 1)" class="text-[var(--gold-main)] text-lg px-4">❯</button>
            </div>
        </div>
        <div id="month-report-content"></div>
    </div>

    <div id="report-view-year" class="hidden px-4 max-w-2xl mx-auto text-[#333]">
        <div class="nav-header-container">
            <button onclick="changeReportDate('year', -1)" class="text-[var(--gold-main)] text-lg px-4">❮</button>
            <span id="report-year-title" class="font-bold text-[#333] text-lg"></span>
            <div class="nav-right-group">
                <button onclick="resetToToday('report-year')" class="today-btn !border-[#333] !text-[#333]">今年</button>
                <button onclick="changeReportDate('year', 1)" class="text-[var(--gold-main)] text-lg px-4">❯</button>
            </div>
        </div>
        <div id="year-report-content"></div>
    </div>
</section>

<section>
    <div id="dayDetailModal" class="cal-modal-overlay hidden">
        <div class="cal-modal-content" style="max-width: 340px; text-align: left; padding: 20px;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="dd-title" class="text-[var(--gold-main)] font-bold text-lg font-serif"></h3>
                <div class="flex items-center">
                    <button id="btn-daily-settle" onclick="openSettlement()" class="settle-btn settle-btn-outline">💰當日結算</button>
                    <button onclick="closeDayDetail()" class="text-2xl opacity-50 pl-2 border-l border-white/20 ml-2">×</button>
                </div>
            </div>
            <div id="dd-list" class="day-detail-list"></div>
            <div class="grid grid-cols-2 gap-3 pt-2 border-t border-white/10">
                <button onclick="toggleDayOff()" id="btn-day-off" class="py-3 rounded-lg border border-[#ff6b6b] text-[#ff6b6b] font-bold text-sm transition-all">休假</button>
                <button onclick="openEditForm()" class="py-3 rounded-lg bg-[var(--gold-main)] text-[#1a3a2e] font-bold text-sm shadow-lg">＋ 新增預約</button>
            </div>
        </div>
    </div>

    <div id="settlementModal" class="cal-modal-overlay hidden" style="z-index: 7000;">
        <div class="cal-modal-content flex flex-col" style="max-width: 360px; height: 90vh; background: #f9f9f9; color: #333; padding: 0; border-radius: 20px; overflow: hidden;">
            <div class="bg-white p-4 shadow-sm z-10 flex justify-between items-center border-b border-gray-100">
                <h3 class="font-bold text-lg text-[#1a3a2e] flex items-center gap-2"><span id="settle-date"></span> <span id="settle-status-badge"></span></h3>
                <button onclick="document.getElementById('settlementModal').classList.add('hidden')" class="text-gray-400 text-xl">✕</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-[#f2f2f2]">
                <div class="settle-card">
                    <div class="settle-header" onclick="toggleSettleDetail('deposit')">
                        <div class="settle-title">💰 定金資訊</div>
                        <div class="settle-total">$<span id="settle-deposit-total">0</span></div>
                    </div>
                    <div id="settle-detail-deposit" class="hidden"></div>
                </div>

                <div class="settle-card">
                    <div class="settle-header" onclick="toggleSettleDetail('service')">
                        <div class="settle-title">💅 服務結算 (不含定金)</div>
                        <div class="settle-total">$<span id="settle-service-total">0</span></div>
                    </div>
                    <div id="settle-detail-service" class="hidden"></div>
                </div>

                <button id="btn-open-cashier" onclick="openCashier()" class="w-full py-4 bg-[#1a3a2e] text-[var(--gold-main)] rounded-xl font-bold text-sm shadow-lg flex justify-between px-6 items-center mt-4">
                    <span>💵 零用金結算</span><span>❯</span>
                </button>
                
                <div id="settle-action-area" class="mt-4 hidden">
                    <button onclick="toggleSettlementEdit()" class="w-full py-3 border-2 border-dashed border-gray-400 text-gray-500 rounded-xl font-bold text-sm hover:bg-gray-100 hover:text-gray-700 transition-all">
                        📑 編輯內容
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="cashierModal" class="cal-modal-overlay hidden" style="z-index: 7500;">
        <div class="cal-modal-content flex flex-col" style="max-width: 360px; height: 90vh; background: #fff; color: #333; padding: 0; border-radius: 20px; overflow: hidden;">
            <div class="bg-[#1a3a2e] p-4 text-center relative">
                <h3 class="text-[var(--gold-main)] font-bold">零用金結算</h3>
                <button onclick="document.getElementById('cashierModal').classList.add('hidden')" class="absolute top-4 right-4 text-[var(--gold-main)] text-xl font-bold p-2">✕</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <div>
                    <h4 class="font-bold text-[#1a3a2e] mb-2 border-l-4 border-[var(--gold-main)] pl-2">當前現金</h4>
                    <div id="cash-grid-current"></div>
                    <div id="current-cash-summary-container" class="mt-2 border-t pt-1">
                        <div class="text-right font-bold text-lg text-[#1a3a2e]">總計: $<span id="cash-total-current">0</span></div>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-[#1a3a2e] mb-2 border-l-4 border-[var(--gold-main)] pl-2">零用金</h4>
                    <div id="cash-grid-reserve"></div>
                    <div class="text-right font-bold text-lg text-[#1a3a2e] mt-2 border-t pt-1">總計: $<span id="cash-total-reserve">0</span></div>
                </div>

                <div class="bg-[#f9f9f9] p-3 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-[#1a3a2e]">本日盈餘</span>
                        <span class="font-bold text-xl text-[#ff6b6b]">$<span id="cash-surplus">0</span></span>
                    </div>
                    <div class="text-xs text-gray-400 mb-2">待分配金額: $<span id="cash-remaining">0</span></div>
                    
                    <div class="space-y-2" id="alloc-container">
                        <div class="grid grid-cols-[80px_1fr] gap-2 items-center">
                            <button class="alloc-btn" onclick="allocateSurplus('backup')">備用金</button>
                            <input type="number" id="alloc-backup" class="cash-input" placeholder="0" oninput="updateSurplus()">
                        </div>
                        <div class="grid grid-cols-[80px_1fr] gap-2 items-center">
                            <button class="alloc-btn" onclick="allocateSurplus('yongfeng')">永豐</button>
                            <input type="number" id="alloc-yongfeng" class="cash-input" placeholder="0" oninput="updateSurplus()">
                        </div>
                        <div class="grid grid-cols-[80px_1fr] gap-2 items-center">
                            <button class="alloc-btn" onclick="allocateSurplus('ctbc')">中信</button>
                            <input type="number" id="alloc-ctbc" class="cash-input" placeholder="0" oninput="updateSurplus()">
                        </div>
                        <div class="grid grid-cols-[80px_1fr] gap-2 items-center">
                            <button class="alloc-btn" onclick="allocateSurplus('wallet')">錢包</button>
                            <input type="number" id="alloc-wallet" class="cash-input" placeholder="0" oninput="updateSurplus()">
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-3 pt-2 border-t text-sm font-bold">
                        <span>已入庫總額</span>
                        <span class="text-[#1a4731]">$<span id="cash-stored">0</span></span>
                    </div>
                </div>
            </div>
            
            <div id="cashier-footer" class="p-4 border-t border-gray-200">
                </div>
        </div>
    </div>

    <div id="accountingModal" class="cal-modal-overlay hidden" style="z-index: 7200;">
        <div class="cal-modal-content flex flex-col" style="max-width: 360px; height: 90vh; background: #f9f9f9; color: #333; padding: 0; border-radius: 20px; overflow: hidden;">
            <div class="bg-white p-4 shadow-sm z-10 flex justify-between items-center border-b border-gray-100">
                <h3 class="font-bold text-lg text-[#1a3a2e]" id="acc-date-title">記帳本</h3>
                <button onclick="document.getElementById('accountingModal').classList.add('hidden')" class="text-gray-400 text-xl">✕</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <div class="report-card !mb-2 !p-3 bg-[#e8f5e9] border border-[#c8e6c9]">
                    <div class="report-section-title !mb-2 !border-none !p-0 text-[#1a4731]">💵 店內庫存 (系統推算)</div>
                    <div class="flex justify-between text-sm">
                        <span>零用金: <b id="acc-petty-cash">$0</b></span>
                        <span>備用金: <b id="acc-backup-cash">$0</b></span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-1 text-center">*錢包資金不計入店內庫存</div>
                </div>

                <div class="report-card !mb-2">
                    <div class="report-section-title">今日營收 (自動計算)</div>
                    <div id="acc-revenue-list" class="text-xs space-y-1 mb-2"></div>
                    <div class="text-right border-t pt-2 font-bold text-[#1a3a2e]">總計: $<span id="acc-revenue-total">0</span></div>
                </div>

                <div class="report-card !mb-2 border-l-4 border-[#ffb74d]">
                    <div class="report-section-title text-[#f57c00] !border-none !p-0">資金調度 (提領至錢包)</div>
                    <div class="space-y-2 mt-2">
                        <div class="flex gap-2 items-center">
                            <span class="text-xs font-bold text-gray-500 whitespace-nowrap">從</span>
                            <select id="transfer-source" class="exp-select flex-1">
                                <option value="petty">零用金</option>
                                <option value="backup">備用金</option>
                            </select>
                            <span class="text-xs font-bold text-gray-500 whitespace-nowrap">轉入錢包</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="transfer-amount" class="exp-input" placeholder="金額">
                            <button onclick="addTransfer()" class="py-2 px-4 bg-[#ffb74d] text-white rounded-lg font-bold text-xs shadow">執行</button>
                        </div>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-section-title">記一筆支出</div>
                    <div class="space-y-3">
                        <div class="expense-form-row">
                            <select id="exp-cat" class="exp-select w-1/3">
                                <option value="耗材">耗材</option>
                                <option value="設備">設備</option>
                                <option value="固定支出">固定支出</option>
                                <option value="退款">退款</option>
                            </select>
                            <input type="text" id="exp-name" class="exp-input w-2/3" placeholder="項目名稱">
                        </div>
                        <div class="expense-form-row">
                            <input type="number" id="exp-amount" class="exp-input" placeholder="金額">
                            <select id="exp-source" class="exp-select">
                                <option value="petty">零用金支付</option>
                                <option value="backup">備用金支付</option>
                                <option value="wallet">錢包支付</option> </select>
                        </div>
                        <button onclick="addExpense()" class="w-full py-2 bg-[#ff6b6b] text-white rounded-lg font-bold text-sm shadow">新增支出</button>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-section-title">今日收支明細</div>
                    <div id="acc-expense-list" class="text-xs space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="bookingDetailModal" class="cal-modal-overlay hidden" style="z-index: 6500;">
        <div class="cal-modal-content flex flex-col" style="max-width: 320px; background: #fff; color: #333; padding: 0; border-radius: 20px; overflow: hidden;">
            <div class="bg-[var(--forest-bg)] p-5 text-center relative">
                <div id="bd-date" class="text-[var(--gold-main)] text-xl font-serif font-bold tracking-widest"></div>
                <div id="bd-day" class="text-white/60 text-xs mt-1 font-bold tracking-widest"></div>
                <div id="bd-time" class="text-white text-2xl font-bold mt-2 font-serif"></div>
                <button onclick="document.getElementById('bookingDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-[var(--gold-main)] text-2xl font-bold opacity-100 hover:text-white transition-colors">✕</button>
            </div>
            <div class="p-5 flex-1 overflow-y-auto">
                <div id="bd-status-container" class="text-center mb-6">
                    <div class="status-badge status-pending">尚未到來</div>
                </div>
                <div class="space-y-4 text-sm">
                    <div class="flex justify-between border-b border-gray-100 pb-2">
                        <span class="text-gray-400 font-bold">定金支付</span>
                        <span id="bd-deposit" class="font-bold text-[#1a3a2e]"></span>
                    </div>
                    <div>
                        <span class="text-gray-400 font-bold block mb-1">服務項目</span>
                        <div id="bd-items" class="font-bold text-[#1a3a2e] space-y-1"></div>
                    </div>
                    <div id="bd-note-area" class="bg-gray-50 p-3 rounded-lg text-xs text-gray-600 hidden">
                        <span class="text-[10px] text-gray-400 block mb-1">備註</span>
                        <span id="bd-note"></span>
                    </div>

                    <div id="bd-img-area" class="mt-3 hidden">
                        <span class="text-[10px] text-gray-400 block mb-2 font-bold">照片紀錄</span>
                        <div id="bd-img-grid" class="grid grid-cols-3 gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 grid grid-cols-2 gap-3 border-t border-gray-100">
                <button id="btn-bd-edit" class="py-3 rounded-xl border border-gray-300 text-gray-500 font-bold text-sm">編輯預約</button>
                <button id="btn-bd-checkout" class="py-3 rounded-xl bg-[var(--gold-main)] text-[#1a3a2e] font-bold text-sm shadow-lg">結帳</button>
            </div>
        </div>
    </div>

    <div id="checkoutModal" class="cal-modal-overlay hidden" style="z-index: 7000;">
        <div class="cal-modal-content flex flex-col" style="max-width: 360px; height: 85vh; background: #f2f2f2; color: #333; padding: 0; border-radius: 20px; overflow: hidden;">
            <div class="bg-white p-4 shadow-sm z-10 flex justify-between items-center">
                <h3 class="font-bold text-lg text-[#1a3a2e]">結帳櫃檯</h3>
                <button onclick="closeCheckout()" class="text-gray-400 text-xl">✕</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div id="checkout-list"></div>
                <button onclick="openDiscountModal('global')" class="w-full bg-white p-3 rounded-lg border border-dashed border-[#c9b896] text-[#c9b896] font-bold text-sm flex justify-between items-center">
                    <span>全單折扣</span>
                    <span id="global-disc-display">- $0</span>
                </button>
            </div>
            <div class="bg-white p-4 border-t border-gray-200 z-10 shadow-[0_-4px_15px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-end mb-2">
                    <div class="text-xs text-gray-400">總額 $<span id="co-subtotal">0</span> <span class="mx-1">|</span> 折扣 $<span id="co-discount-total">0</span></div>
                    <div class="text-2xl font-bold text-[#1a3a2e] font-serif">$<span id="co-grand-total">0</span></div>
                </div>
                <button onclick="openPaymentModal()" class="w-full py-3 bg-[#1a3a2e] text-[var(--gold-main)] rounded-xl font-bold text-sm shadow-lg flex justify-between px-6 items-center"><span>選擇支付方式</span><span>❯</span></button>
            </div>
        </div>
    </div>

    <div id="discountModal" class="cal-modal-overlay hidden" style="z-index: 7500;">
        <div class="cal-modal-content" style="max-width: 300px; background: #fff; color: #333; padding: 20px; text-align: left;">
            <h3 class="font-bold text-center mb-4" id="disc-title">設定折扣</h3>
            <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
                <button onclick="switchDiscType('cash')" id="tab-disc-cash" class="flex-1 py-1.5 text-xs font-bold rounded bg-white shadow-sm">現金 ($)</button>
                <button onclick="switchDiscType('percent')" id="tab-disc-percent" class="flex-1 py-1.5 text-xs font-bold text-gray-400">折數 (%)</button>
            </div>
            <div class="mb-4"><input type="number" id="disc-input" class="w-full bg-gray-50 border border-gray-200 rounded p-3 text-center text-xl font-bold outline-none text-[#1a3a2e]" placeholder="輸入金額"></div>
            <div id="disc-grid-cash" class="discount-grid">
                <div class="disc-btn" onclick="setDiscVal(50)">50</div><div class="disc-btn" onclick="setDiscVal(100)">100</div><div class="disc-btn" onclick="setDiscVal(150)">150</div><div class="disc-btn" onclick="setDiscVal(200)">200</div>
                <div class="disc-btn" onclick="setDiscVal(250)">250</div><div class="disc-btn" onclick="setDiscVal(300)">300</div><div class="disc-btn" onclick="setDiscVal(350)">350</div><div class="disc-btn" onclick="setDiscVal(400)">400</div>
            </div>
            <div id="disc-grid-percent" class="discount-grid hidden">
                <div class="disc-btn" onclick="setDiscVal(95)">95折</div><div class="disc-btn" onclick="setDiscVal(92)">92折</div><div class="disc-btn" onclick="setDiscVal(90)">9折</div><div class="disc-btn" onclick="setDiscVal(88)">88折</div>
                <div class="disc-btn" onclick="setDiscVal(85)">85折</div><div class="disc-btn" onclick="setDiscVal(80)">8折</div><div class="disc-btn" onclick="setDiscVal(75)">75折</div><div class="disc-btn" onclick="setDiscVal(70)">7折</div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="document.getElementById('discountModal').classList.add('hidden')" class="py-2 border border-gray-300 rounded-lg text-xs font-bold text-gray-500">取消</button>
                <button onclick="applyDiscount()" class="py-2 bg-[var(--gold-main)] text-[#1a3a2e] rounded-lg text-xs font-bold">確認</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="cal-modal-overlay hidden" style="z-index: 7600;">
        <div class="cal-modal-content flex flex-col" style="max-width: 360px; height: 70vh; background: #fff; color: #333; padding: 0; border-radius: 20px; overflow: hidden;">
            <div class="bg-[var(--forest-bg)] p-4 text-center relative">
                <h3 class="text-[var(--gold-main)] font-bold mb-1">應付金額</h3>
                <div class="text-3xl text-[var(--gold-main)] font-serif font-bold">$<span id="pay-total-amount">0</span></div>
                <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="absolute top-4 right-4 text-[var(--gold-main)] text-xl font-bold hover:text-white transition-colors p-2">✕</button>
            </div>
            <div class="flex-1 overflow-y-auto">
               <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500">已付定金 (<span id="pay-dep-method">無</span>)</span>
                    <div class="flex items-center border-b border-gray-300">
                        <span class="font-bold text-[#1a3a2e] mr-1">$</span>
                        <input type="number" id="pay-dep-input" class="w-16 bg-transparent text-right font-bold text-[#1a3a2e] outline-none p-0" 
                            value="0" oninput="updatePayRemaining()" onfocus="this.select()">
                    </div>
                </div>
                <div class="mt-2">
                    <div class="pay-method-row selected" onclick="selectPayMethod('cash', this)"><div class="flex items-center"><div class="pay-radio"></div><span class="font-bold text-sm">現金</span></div><span class="font-bold text-[#1a3a2e] pay-amt" id="pay-val-cash">$0</span></div>
                    <div class="pay-method-row" onclick="selectPayMethod('transfer', this)"><div class="flex items-center"><div class="pay-radio"></div><span class="font-bold text-sm">匯款</span></div><span class="font-bold text-[#1a3a2e] pay-amt" id="pay-val-transfer"></span></div>
                    <div class="pay-method-row" onclick="selectPayMethod('linepay', this)"><div class="flex items-center"><div class="pay-radio"></div><span class="font-bold text-sm">LINE Pay</span></div><span class="font-bold text-[#1a3a2e] pay-amt" id="pay-val-linepay"></span></div>
                    <div class="pay-method-row" onclick="selectPayMethod('jko', this)"><div class="flex items-center"><div class="pay-radio"></div><span class="font-bold text-sm">街口支付</span></div><span class="font-bold text-[#1a3a2e] pay-amt" id="pay-val-jko"></span></div>
                    <div class="pay-method-row" onclick="selectPayMethod('stored', this)"><div class="flex items-center"><div class="pay-radio"></div><span class="font-bold text-sm">儲值金</span></div><span class="font-bold text-[#1a3a2e] pay-amt" id="pay-val-stored"></span></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200">
                <button onclick="confirmCheckout()" class="w-full py-3 bg-[#1a4731] text-white rounded-xl font-bold shadow-lg text-lg">結帳 NT$<span id="btn-pay-total">0</span></button>
            </div>
        </div>
    </div>

    <div id="finEditModal" class="cal-modal-overlay hidden">
        <div class="cal-modal-content flex flex-col" style="max-width: 360px; height: 85vh; padding: 0; overflow: hidden; border-radius: 20px; position: relative; background: #f2f2f2;">
            <div class="flex-shrink-0 bg-white z-20 shadow-md">
                <div class="flex justify-between items-center p-3 border-b border-gray-100">
                    <h3 id="fe-title" class="text-[var(--gold-main)] font-bold text-base tracking-wide">新增帳務</h3>
                    <button onclick="closeFinEditModal()" class="text-gray-400 text-xl w-8 h-8 flex items-center justify-center hover:bg-gray-50 rounded-full">✕</button>
                </div>
                <div class="p-3 pb-0 space-y-2">
                    <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <label class="text-xs text-gray-500 font-bold whitespace-nowrap">預約時間</label>
                        <div class="flex-1 flex items-center justify-center gap-1">
                            <select id="fe-h" class="bg-transparent text-[#1a3a2e] font-bold text-lg outline-none text-center appearance-none w-16 border-b border-gray-400 p-0"></select>
                            <span class="text-gray-400 font-bold">:</span>
                            <select id="fe-m" class="bg-transparent text-[#1a3a2e] font-bold text-lg outline-none text-center appearance-none w-16 border-b border-gray-400 p-0">
                                <option value="00">00</option><option value="30">30</option>
                            </select>
                        </div>
                    </div>
                    <div class="cat-tab-group shadow-sm bg-white border border-gray-200" style="margin-bottom: -1px;">
                        <div class="cat-tab-btn active" onclick="switchFinCat('nail_model', this)">手模</div>
                        <div class="cat-tab-btn" onclick="switchFinCat('eyelash_practice', this)">睫模</div>
                        <div class="cat-tab-btn" onclick="switchFinCat('nail', this)">美甲</div>
                        <div class="cat-tab-btn" onclick="switchFinCat('eyelash', this)">美睫</div>
                        <div class="cat-tab-btn" onclick="switchFinCat('skin', this)">美容</div>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3 pt-4 bg-[#f2f2f2] relative" style="overscroll-behavior: contain;">
                <div id="conflict-msg" class="hidden mb-3 p-3 bg-red-50 text-red-500 text-xs font-bold rounded-lg text-center border border-red-200 shadow-sm"></div>
                <div id="priceSelectorModal" class="cal-modal-overlay hidden" style="z-index: 6000;">
                    <div class="cal-modal-content" style="max-width: 300px; background: #1a3a2e; border: 2px solid var(--gold-main); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <h3 class="text-[var(--gold-main)] font-bold text-xl mb-6 tracking-widest text-center">請選擇方案</h3>
                        <div id="price-options-container" class="grid gap-3"></div>
                        <button onclick="document.getElementById('priceSelectorModal').classList.add('hidden')" class="w-full mt-6 py-3 border border-[#c9b896] text-[#c9b896] rounded-lg text-xs font-bold tracking-widest hover:bg-[#c9b896] hover:text-[#1a3a2e] transition-all">取消</button>
                    </div>
                </div>
                <div id="fe-item-grid" class="grid grid-cols-2 gap-2 p-1 mb-4"></div>
                <div class="mb-3 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between text-xs mb-2 text-gray-500 font-bold border-b border-gray-100 pb-2"><span>已選項目清單</span><span id="fe-count">0 項</span></div>
                    <div id="fe-selected-list" class="mb-3 space-y-1"></div>
                   <div class="mb-3 pt-2 border-t border-gray-100">
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-[10px] text-gray-400 font-bold">定金設定</label>
                            <div class="flex items-center border-b border-gray-300 pb-0.5">
                                <span class="text-[10px] text-gray-400 mr-1">$</span>
                                <input type="number" id="fe-dep-amount" class="w-14 bg-transparent text-right font-bold text-[#1a3a2e] text-sm outline-none p-0" value="100" placeholder="金額">
                            </div>
                        </div>
                        <div class="flex gap-1 flex-wrap">
                            <button type="button" class="dep-opt-btn" onclick="setDepositMethod('cash', this)">現金</button>
                            <button type="button" class="dep-opt-btn" onclick="setDepositMethod('transfer', this)">匯款</button>
                            <button type="button" class="dep-opt-btn" onclick="setDepositMethod('linepay', this)">Line Pay</button>
                            <button type="button" class="dep-opt-btn" onclick="setDepositMethod('stored', this)">儲值金</button>
                            <button type="button" class="dep-opt-btn active" onclick="setDepositMethod('none', this)">無</button>
                        </div>
                        <div class="mb-3 pt-2 border-t border-gray-100 flex items-center justify-between">
                        <label class="text-[10px] text-gray-400 font-bold block">定金歸帳日期</label>
                        <input type="date" id="fe-dep-date" class="bg-gray-50 border border-gray-300 rounded px-2 py-1 text-xs text-[#1a3a2e] font-bold">
                    </div>
                        <input type="hidden" id="fe-dep-method" value="none">
                    </div>

                    <div class="flex gap-2 items-center">
                        <div class="flex-1"><label class="text-[10px] block text-gray-400 mb-1">總金額</label><input type="number" inputmode="numeric" id="fe-price" class="edit-input w-full font-bold text-[#2d4639] text-lg bg-gray-50 border border-gray-200 rounded px-2 py-2"></div>
                        <div class="flex-1"><label class="text-[10px] block text-gray-400 mb-1">總時長(分)</label><input type="number" inputmode="numeric" id="fe-duration" class="edit-input w-full text-center bg-gray-50 border border-gray-200 rounded px-2 py-2 font-bold text-gray-600"></div>
                    </div>
                </div>
                <div class="mb-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                    <label class="text-[10px] block text-gray-400 mb-1">備註 (Note)</label>
                    <textarea id="fe-note" rows="2" class="w-full text-xs p-2 border border-gray-200 rounded bg-gray-50 text-gray-800 resize-none" placeholder="輸入備註..."></textarea>
                    <div class="img-upload-box mt-3 border-dashed border-2 border-gray-200 bg-gray-50 rounded-lg p-2">
                        <label for="fe-image-upload" class="cursor-pointer text-xs text-[var(--gold-main)] font-bold flex items-center justify-center gap-2 py-3 hover:bg-gray-100 transition-colors rounded-lg w-full">
                            📷 上傳照片 (可多選)
                            <input type="file" id="fe-image-upload" accept="image/*" multiple class="hidden" onchange="handleImageUpload(this)">
                        </label>
                        <div id="fe-preview-container" class="grid grid-cols-3 gap-2 mt-2"></div>
                    </div>
                    <div class="h-4"></div>
                </div>
                <div class="flex-shrink-0 p-3 border-t border-gray-200 bg-white z-20 shadow-[0_-4px_15px_rgba(0,0,0,0.05)]">
                    <button onclick="saveFinData()" class="w-full py-3 bg-[var(--gold-main)] text-[#1a3a2e] rounded-xl text-sm font-bold shadow-lg hover:brightness-105 active:scale-[0.98] transition-all">確認儲存</button>
                </div>
            </div>
        </div>
    </div>
</section>

    <nav class="bottom-nav">
        <div id="nav-guest" class="nav-inner">
            <div class="tab-button active" onclick="switchPage('home', this)">首頁</div>
            <div class="tab-button" onclick="switchPage('notice', this)">須知</div>
            <div class="tab-button" onclick="switchPage('nail', this)">美甲</div>
            <div class="tab-button" onclick="switchPage('eyelash', this)">美睫</div>
            <div class="tab-button" onclick="switchPage('skin', this)">美容</div>
            <div class="tab-button" onclick="switchPage('method', this)">方式</div>
            <div class="tab-button" onclick="switchPage('booking', this)">時段</div>
            <div class="tab-button" onclick="showAdminLogin()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
            </div>
        </div>
        <div id="nav-admin" class="nav-inner hidden">
            <div class="tab-button" onclick="switchPage('admin-pricelist', this)">價目表</div>
            <div class="tab-button" onclick="switchPage('admin-calc', this)">計算</div>
            <div class="tab-button" onclick="switchPage('budget', this)">時段</div>
            <div class="tab-button" onclick="switchPage('admin-finance', this)">預約</div>
            <div class="tab-button" onclick="switchPage('admin-report', this)">財報</div>
            
            <div class="tab-button" onclick="logout()" style="color:#ff6b6b">儲存</div>
        </div>
    </nav>

    <div id="admin-login-overlay">
        <form class="login-container" onsubmit="event.preventDefault(); checkAdminNew();">
            <div class="login-title">身份驗證</div>
            
            <input type="text" name="username" value="meawme" autocomplete="username" style="display:none;">

            <input type="password" id="admin-pwd" name="password" autocomplete="current-password" 
                    class="pwd-input" placeholder="ACCESS CODE" inputmode="numeric"
                    oninput="if(this.value==='2002') checkAdminNew()">
            
            <div class="flex flex-col gap-6 items-center">
                <button type="submit" class="login-action-btn">VERIFY</button>
                <button type="button" onclick="hideAdminLogin()" style="color:rgba(255,255,255,0.3); font-size: 11px; letter-spacing: 2px;">CANCEL</button>
            </div>
        </form>
    </div>

    <div id="askDialog" class="cal-modal-overlay hidden">
        <div class="cal-modal-content">
            <textarea id="serviceInput" placeholder="欲預約項目（例如：美甲指定款A+卸甲）" rows="3" class="w-full bg-black/10 border border-gray-500 rounded-lg p-3 text-sm outline-none mb-4 text-[#333] dark:text-white"></textarea>
            <div id="selectedTimesPreview" class="text-xs opacity-60 mb-6 bg-white/5 p-4 rounded-lg text-left"></div>
            <button onclick="copyToLine()" class="copy-btn">複製文字並前往 LINE 貼上</button>
            <button onclick="document.getElementById('askDialog').classList.add('hidden')" class="mt-4 text-xs opacity-50">返回修改</button>
        </div>
    </div>

    <div id="editTimeModal" class="cal-modal-overlay hidden">
        <div class="cal-modal-content">
            <h3 id="editTitle" class="mb-6 font-bold text-lg">編輯時段</h3>
            <div id="timeChips" class="grid grid-cols-3 gap-2 mb-6"></div>
            <div class="flex gap-2 mb-6">
                <select id="hSel" class="bg-gray-100 text-black p-2 rounded w-1/2"></select>
                <select id="mSel" class="bg-gray-100 text-black p-2 rounded w-1/2"><option value="00">00</option><option value="30">30</option></select>
                <button onclick="addCustomTime()" class="bg-[var(--gold-main)] text-white px-4 rounded">+</button>
            </div>
            <button onclick="closeEditModal()" class="w-full py-3 border border-[var(--gold-main)] text-[var(--gold-main)] font-bold rounded-lg">完成</button>
        </div>
    </div>
</div>

<div id="overlay" onclick="toggleSheet('bottomSheet', false)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;"></div>
<div id="bottomSheet" style="position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s ease-out; z-index: 2001; max-height: 80vh; overflow-y: auto;">
    <div style="width: 40px; height: 4px; background: #e5e7eb; border-radius: 2px; margin: 0 auto 15px;"></div>
    <h3 style="font-size: 16px; font-weight: 700; color: #1a3a2e; margin-bottom: 15px; text-align: center;">費用明細</h3>
    <div id="billContent" class="space-y-2"></div>
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 14px; font-weight: 700; color: #1a3a2e;">總計</span>
        <span style="font-size: 20px; font-weight: 800; color: #1a3a2e;">$<span id="sheetTotal">0</span></span>
    </div>
    <button onclick="copyBill()" style="width: 100%; background: #1a3a2e; color: white; padding: 12px; border-radius: 12px; font-weight: 700; margin-top: 15px;">複製明細</button>
</div>

<script>
    // =========================================================================
    // 核心資料清洗工具
    // =========================================================================
    function safeArray(data) {
        if (!data) return [];
        if (Array.isArray(data)) return data.filter(item => item !== null && item !== undefined);
        if (typeof data === 'object') return Object.values(data);
        return [];
    }

    function parsePrice(val) {
        if (!val) return 0;
        const num = parseInt(String(val).replace(/[^0-9]/g, '')); 
        return isNaN(num) ? 0 : num;
    }

    function formatPriceDisplay(price) {
        // 如果包含 %，顯示原樣 (並加上金色樣式)
        if (String(price).includes('%')) return `<span class="text-xs font-bold text-[var(--gold-main)]">${price}</span>`;
        // 如果是 0，顯示 Free
        if (parseInt(price) === 0 || price === "0") return "Free";
        // 一般金額
        return `$${price}`;
    }

    // --- 1. 資料核心與初始化 ---
    let rawData = null;
    try {
        rawData = JSON.parse(localStorage.getItem('nailServiceData'));
    } catch (e) {
        console.error("本地資料讀取失敗，使用預設值");
    }

    const defaultData = {
        nail: { main: [{name:"單色凝膠", duration:60, price:700, selectedForCalc:true}], addon: [], model: [] },
        eyelash: { main: [], addon: [], model: [], practice: [] }, // 新增 practice
        skin: { main: [], addon: [] }
    };

    let serviceData = rawData || JSON.parse(JSON.stringify(defaultData));
    let editStates = { nail: false, eyelash: false, skin: false };
    let currentMode = 'regular';
    let selectedBasePrice = 0, selectedBaseName = "", currentRemovalPrice = 0;

    // --- 財務系統核心 V3 (若遺失請補上) ---
    let financeStore = {
        viewDate: new Date(),
        viewMode: 'item', 
        data: {}, 
        manualOffDays: [],
        offDayNotes: {} // [修正] 確保備註欄位存在
    };

    let activeDateStr = "";
    let editingEntryId = null;
    let currentCheckoutEntry = null; // 補上這一行
    let tempItems = [];
    let currentCat = "nail";
    
    // 行事曆變數
    const DEFAULTS_TIMES = ["10:00", "13:00", "16:00", "19:00"];
    let bookingState = {
        viewDate: new Date(),
        isAskMode: false,
        selectedTimes: [],
        data: { openMonths: [], bookings: {} }, 
        editingKey: '' 
    };

    let hasSeenBookingNotice = false; // 紀錄是否看過告示

    function closeBookingNotice() {
        document.getElementById('booking-notice-modal').classList.add('hidden');
        hasSeenBookingNotice = true;
    }
    

    // 計算機 Config
    const calcUIConfigs = {
        regular: {
            designItems: ["貓眼", "跳色", "漸層", "鏡面", "暈染", "法式", "手繪", "立體", "鑽飾", "貼紙", "延甲", "補甲"],
            fixedAdd: [{name: "基礎保養", price: 500},{name: "深層保養", price: 800},{name: "全延甲", price: 500}],
            defaultDesignPrice: 25,
            removalOptions: [{n: "無", p: 0}, {n: "本店卸甲", p: 200}, {n: "他店卸甲", p: 300}],
            specialRemoval: [{ id: 'bigDiamond', name: '大鑽', defaultPrice: 20 }, { id: '3d', name: '立體', defaultPrice: 20 }]
        },
        model: {
            designItems: ["貓眼", "跳色", "漸層", "鏡面", "暈染", "法式", "手繪", "立體", "鑽飾", "貼紙", "補甲"],
            fixedAdd: [],
            defaultDesignPrice: 15,
            removalOptions: [{n: "無", p: 0}, {n: "卸甲", p: 100}],
            specialRemoval: [{ id: 'bigDiamond', name: '大鑽', defaultPrice: 10 }, { id: '3d', name: '立體', defaultPrice: 10 }, { id: 'ext', name: '延甲', defaultPrice: 10 }]
        }
    };

    // [修正版] 資料同步函數 (自動修復缺失欄位)
    function syncServiceData() {
        if (window.dbOnValue && window.dbRef) {
            window.dbOnValue(window.dbRef(window.firebaseDB, 'meawMeData'), (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    let cleanData = val;
                    // 確保三大類別都存在
                    ['nail', 'eyelash', 'skin'].forEach(cat => {
                        if (!cleanData[cat]) cleanData[cat] = { main: [], addon: [], model: [], practice: [] };
                        
                        // [關鍵修復] 如果沒有 practice (睫模) 欄位，自動補上空陣列
                        if (cat === 'eyelash' && !cleanData[cat].practice) {
                            cleanData[cat].practice = [];
                        }

                        // 確保所有子項目都是陣列
                        const types = ['main', 'addon', 'model', 'practice'];
                        types.forEach(type => {
                            // 如果該欄位不存在，就給它空陣列
                            if (!cleanData[cat][type]) {
                                cleanData[cat][type] = [];
                            } else {
                                cleanData[cat][type] = safeArray(cleanData[cat][type]);
                            }
                        });
                    });
                    serviceData = cleanData;
                } else {
                    serviceData = JSON.parse(JSON.stringify(defaultData));
                }
                
                // 加上 try-catch 防止單一錯誤導致全頁白屏
                try { renderServiceFront(); } catch(e) { console.error("Front error", e); }
                try { renderAdminList(); } catch(e) { console.error("Admin error", e); }
                try { initCalc(); } catch(e) { console.error("Calc error", e); }
            });
        }
    }

    function saveBookingData() {
        if (window.dbSet && window.dbRef) {
            // 寫入 Firebase 路徑 'meawMeBooking'
            window.dbSet(window.dbRef(window.firebaseDB, 'meawMeBooking'), bookingState.data)
                .then(() => {
                    // console.log("行事曆同步成功");
                })
                .catch((error) => {
                    console.error("行事曆同步失敗:", error);
                    alert("行事曆同步失敗，請檢查網路");
                });
        }
        renderCalendar();
    }

    // [智慧修正版] 同步預約時段 (Booking) - 自動識別資料結構
    function syncBookingData() {
        if (window.dbOnValue && window.dbRef) {
            window.dbOnValue(window.dbRef(window.firebaseDB, 'meawMeBooking'), (snapshot) => {
                const val = snapshot.val();
                // console.log("雲端時段資料:", val); // 除錯用
                
                if (val) {
                    // 智慧判斷：資料是被包在 bookings 裡，還是直接就是資料？
                    if (val.bookings || val.openMonths) {
                        // 結構 A：標準格式
                        bookingState.data = val; 
                    } else {
                        // 結構 B：舊格式或異常格式 (資料直接散落在根目錄)
                        bookingState.data = { 
                            bookings: val, 
                            openMonths: [] // 補上預設值
                        };
                    }
                }
                
                // 防呆：確保變數存在，避免網頁報錯
                if (!bookingState.data.bookings) bookingState.data.bookings = {};
                if (!bookingState.data.openMonths) bookingState.data.openMonths = [];
                
                renderCalendar();
            });
        }
    }
    
    // --- Render Functions ---
    function renderServiceFront() {
        const categories = ['nail', 'eyelash', 'skin'];
        
        categories.forEach(cat => {
            const categoryData = serviceData[cat] || { main: [], addon: [], model: [] };
            const mainItems = safeArray(categoryData.main);
            const addonItems = safeArray(categoryData.addon);
            const modelItems = safeArray(categoryData.model);

            // 1. 渲染主價目表
            const mainTable = document.querySelector(`#page-${cat} .price-table:first-of-type`);
            if (mainTable) {
                let html = "";
                if (cat === 'nail') {
                    html = `<tr><th style="text-align:left;">項目名稱</th><th class="price-value">價格</th></tr>`;
                    mainItems.forEach(item => {
                        // 使用 formatPriceDisplay 處理 0 -> Free
                        html += `<tr><td>${item.name}</td><td class="price-value">${formatPriceDisplay(item.price)}</td></tr>`;
                    });
                } else {
                    const h1 = cat === 'eyelash' ? '自然款' : '原價';
                    const h2 = cat === 'eyelash' ? '濃密款' : '體驗價';
                    html = `<tr><th style="text-align:left;">服務項目</th><th class="price-value">${h1}</th><th class="price-value">${h2}</th></tr>`;
                    mainItems.forEach(item => {
                        let p2 = (item.price2 && item.price2.toString().trim()) ? `$${item.price2}` : '-';
                        let note = (item.note1 || item.note2) ? `<div class="text-[10px] opacity-60">${item.note1||''} ${item.note2||''}</div>` : "";
                        // 使用 formatPriceDisplay
                        html += `<tr><td><div class="font-bold">${item.name}</div>${note}</td><td class="price-value">${formatPriceDisplay(item.price)}</td><td class="price-value">${p2}</td></tr>`;
                    });
                }
                mainTable.innerHTML = mainItems.length ? html : `<tr><td colspan="3" class="text-center opacity-30">暫無項目</td></tr>`;
            }

            // 2. 渲染加購項目 (在下拉選單內)
            const dropdowns = document.querySelectorAll(`#page-${cat} .dropdown-container`);
            dropdowns.forEach(dropdown => {
                if (dropdown.textContent.includes("加購")) {
                    const content = dropdown.querySelector('.dropdown-content');
                    let h = `<table class="price-table" style="width:100%">`;
                    addonItems.forEach(i => {
                        // 使用 formatPriceDisplay
                        h += `<tr><td style="border-bottom:1px solid rgba(201,184,150,0.1);">${i.name}</td><td class="price-value">${formatPriceDisplay(i.price)}</td></tr>`;
                    });
                    h += `</table>`;
                    if(content) content.innerHTML = addonItems.length ? h : `<div class="text-center opacity-30 p-4">暫無加購項目</div>`;
                }
            });

            // 3. 渲染睫毛管理 & [修正] 補上睫模專區
            if (cat === 'eyelash') {
                const mgmt = document.getElementById('front-eyelash-management');
                if (mgmt) {
                    // 這裡要手動抓取 practice 資料，因為上方的 const 定義沒有包含它
                    const practiceItems = safeArray(categoryData.practice);
                    
                    let html = "";

                    // 若有睫模項目，先渲染睫模標題與表格
                    if (practiceItems.length > 0) {
                        html += `<div class="subsection-title" style="color:var(--gold-main); font-weight:700; margin-top:20px; margin-bottom:10px; border-left:3px solid var(--gold-main); padding-left:10px;">睫模專區</div>`;
                        html += `<table class="price-table">`;
                        html += practiceItems.map(i => `<tr><td>${i.name}</td><td class="price-value">${formatPriceDisplay(i.price)}</td></tr>`).join('');
                        html += `</table>`;
                    }

                    // 接著渲染原本的睫毛管理
                    if (modelItems.length > 0) {
                        html += `<div class="subsection-title" style="color:var(--gold-main); font-weight:700; margin-top:20px; margin-bottom:10px; border-left:3px solid var(--gold-main); padding-left:10px;">睫毛管理</div>`;
                        html += `<table class="price-table">`;
                        html += modelItems.map(i => `<tr><td>${i.name}</td><td class="price-value">${formatPriceDisplay(i.price)}</td></tr>`).join('');
                        html += `</table>`;
                    }

                    mgmt.innerHTML = html;
                }
            }

        }); 

        initCalc();
    }

    // [修正] 列表渲染：迴圈加入 practice 以顯示睫模清單
    function renderAdminList() {
        const categories = ['nail', 'eyelash', 'skin'];
        categories.forEach(cat => {
            if (!serviceData[cat]) return;
            // 這裡加入 practice 讓迴圈能跑到新欄位
            const types = ['main', 'addon', 'model', 'practice']; 
            
            types.forEach(type => {
                if(!serviceData[cat][type]) return;

                const listId = `list-${cat}-${type}`;
                const listContainer = document.getElementById(listId);
                const addContainer = document.getElementById(`add-${cat}-${type}`);
                
                if (!listContainer) return;
                
                const items = safeArray(serviceData[cat][type]);
                const isEditing = editStates[cat]; 

                listContainer.innerHTML = items.map((item, index) => {
                    if (!item) return '';
                    const dataIdx = `data-idx="${index}"`;
                    const p1Disp = String(item.price).includes('%') ? item.price : `$${item.price}`;
                    const p2Disp = item.price2 ? ` / ${String(item.price2).includes('%') ? item.price2 : '$'+item.price2}` : '';
                    const durDisp = item.duration ? `(${item.duration}分)` : '';

                    if (isEditing) {
                        const showPrice2 = (type === 'main' && cat !== 'nail');
                        const showCalcCheck = (cat === 'nail' && (type === 'main' || type === 'model'));
                        
                        const checkHtml = showCalcCheck ? 
                            `<div class="flex flex-col items-center ml-2 cursor-pointer" onclick="toggleCalcOption('${cat}', '${type}', ${index})">
                                <span class="text-[9px] text-[var(--gold-main)] mb-1">計算</span>
                                <div class="check-toggle ${item.selectedForCalc ? 'active' : ''}">✔</div>
                             </div>` : '';

                        return `
                        <div class="admin-item-row" ${dataIdx}>
                            <div class="drag-handle text-[var(--gold-main)] mr-2 text-xl cursor-grab p-2">≡</div>
                            <div class="info">
                                <label class="text-[9px] opacity-50 block">項目名稱</label>
                                <input type="text" class="edit-input w-full font-bold mb-2" value="${item.name||''}" onchange="updateItemValue('${cat}', '${type}', ${index}, 'name', this.value)">
                                <div class="flex gap-2">
                                    <div class="flex-1">
                                        <label class="text-[9px] opacity-50 block">價格</label>
                                        <input type="text" inputmode="numeric" class="edit-input w-full" value="${item.price||''}" onchange="updateItemValue('${cat}', '${type}', ${index}, 'price', this.value)">
                                    </div>
                                    <div class="w-16">
                                        <label class="text-[9px] opacity-50 block">時長(分)</label>
                                        <input type="number" inputmode="numeric" class="edit-input w-full text-center" value="${item.duration||0}" onchange="updateItemValue('${cat}', '${type}', ${index}, 'duration', this.value)">
                                    </div>
                                    ${showPrice2 ? `<div class="flex-1"><label class="text-[9px] opacity-50 block">價格2</label><input type="text" class="edit-input w-full" value="${item.price2||''}" onchange="updateItemValue('${cat}', '${type}', ${index}, 'price2', this.value)"></div>` : ''}
                                </div> 
                            </div> 
                            ${checkHtml}
                            <button onclick="deleteService('${cat}', '${type}', ${index})" class="ml-2 text-red-400 text-xs px-2 border border-red-400 rounded">刪除</button>
                        </div>`;
                    } else {
                        const calcBadge = item.selectedForCalc ? '<span class="text-[8px] bg-[#1a4731] text-[#c9b896] px-1 rounded ml-1">計</span>' : '';
                        return `<div class="admin-item-row"><div class="info"><div class="name flex items-center">${item.name} ${calcBadge} <span class="text-[9px] opacity-50 ml-1">${durDisp}</span></div></div><div class="price font-bold">${p1Disp}${p2Disp}</div></div>`;
                    }
                }).join('');

                if (addContainer) {
                    addContainer.innerHTML = isEditing ? 
                        `<button onclick="addNewBlankItem('${cat}', '${type}')" class="w-full py-3 border-2 border-dashed border-[#c9b896] text-[#c9b896] rounded-xl text-sm font-bold opacity-60 hover:opacity-100 transition-all my-2">+ 新增項目</button>` : '';
                }
                if (isEditing) setTimeout(() => initSortable(listContainer, cat, type), 100);
            });
        });
    }

    function initSortable(el, cat, type) {
        if (!el || !window.Sortable) return;
        if (el._sortable) el._sortable.destroy(); // 避免重複綁定
        
        el._sortable = new Sortable(el, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'opacity-50',
            onEnd: function (evt) {
                const oldIndex = evt.oldIndex;
                const newIndex = evt.newIndex;
                if (oldIndex === newIndex) return;
                
                const list = serviceData[cat][type];
                const item = list.splice(oldIndex, 1)[0];
                list.splice(newIndex, 0, item);
                
                saveAndSync();
                // 重新渲染以確保 index 正確
                setTimeout(() => renderAdminList(), 100);
            }
        });
    }

    // --- Admin Logic ---
    function toggleEditMode(cat) {
        editStates[cat] = !editStates[cat];
        const btn = document.getElementById(`btn-set-${cat}`);
        if(btn) {
            if(editStates[cat]) {
                btn.innerHTML = "💾 儲存並發佈";
                btn.classList.add('editing');
            } else {
                btn.innerHTML = "⚙️ 設置系統";
                btn.classList.remove('editing');
                saveAndSync();
            }
        }
        renderAdminList();
    }

    function addNewBlankItem(cat, type) {
        if(!serviceData[cat][type]) serviceData[cat][type] = [];
        serviceData[cat][type].push({ name: "新項目", price: 0, selectedForCalc: false });
        renderAdminList();
    }
    
    function updateItemValue(cat, type, index, field, value) {
        if (field === 'duration' || field === 'price' && !isNaN(value)) value = parseInt(value) || 0;
        serviceData[cat][type][index][field] = value;
    }
    
    function deleteService(cat, type, index) {
        if(confirm("確定刪除？")) { 
            serviceData[cat][type].splice(index, 1); 
            serviceData[cat][type] = safeArray(serviceData[cat][type]);
            renderAdminList(); 
        }
    }
    
    function toggleCalcOption(cat, type, index) {
        serviceData[cat][type][index].selectedForCalc = !serviceData[cat][type][index].selectedForCalc;
        renderAdminList();
        saveAndSync();
    }

    function saveAndSync() {
        if (window.dbSet && window.dbRef) {
            let cleanData = JSON.parse(JSON.stringify(serviceData));
            ['nail', 'eyelash', 'skin'].forEach(cat => {
                ['main', 'addon', 'model'].forEach(type => {
                    cleanData[cat][type] = safeArray(cleanData[cat][type]);
                });
            });
            window.dbSet(window.dbRef(window.firebaseDB, 'meawMeData'), cleanData);
        }
        renderServiceFront();
        renderAdminList();
        initCalc();
    }

    // --- Calculator Logic ---
    function initCalc() { 
        if(!serviceData.nail) return;

        const config = calcUIConfigs[currentMode];
        const mainItems = safeArray(serviceData.nail.main);
        const modelItems = safeArray(serviceData.nail.model);
        
        const dataSource = currentMode === 'regular' ? mainItems : modelItems;
        const activeBases = dataSource.filter(i => i && i.selectedForCalc);
        
        const baseContainer = document.getElementById('basePriceOptions');
        if (baseContainer) {
            if (activeBases.length > 0) {
                baseContainer.innerHTML = activeBases.map(i => `
                    <button onclick="setBasePrice('${i.price}', '${i.name}', this)" class="base-btn py-1.5 option-btn">
                        <div>${i.name}</div><div class="opacity-60 text-[8px]">$${i.price}</div>
                    </button>
                `).join('');
            } else {
                baseContainer.innerHTML = `<div class="col-span-2 text-center opacity-40 text-xs py-2">後台未設定項目</div>`;
            }
        }

        document.getElementById('designSelectionGrid').innerHTML = config.designItems.map(n => 
            `<button onclick="addDesignItem('${n}')" class="option-btn text-[10px] font-bold !rounded-full py-1">${n}</button>`
        ).join('');

        const addOnsList = document.getElementById('addOnsList');
        if (config.fixedAdd && config.fixedAdd.length > 0) {
            document.getElementById('section-addons').style.display = 'block';
            addOnsList.innerHTML = config.fixedAdd.map(i => `
                <div onclick="toggleAddon(this)" class="addon-card">
                    <span class="addon-name text-[9px] font-bold">${i.name}</span>
                    <span class="addon-price text-[8px]">$${i.price}</span>
                </div>`).join('');
        } else { 
            document.getElementById('section-addons').style.display = 'none'; 
        }

        document.getElementById('specialRemovalList').innerHTML = config.specialRemoval.map(item => `
            <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-gray-400">${item.name}</span>
            <div class="flex items-center gap-3">
                <input type="number" id="price_${item.id}" class="k-input-readonly" value="${item.defaultPrice}" readonly>
                <div class="flex items-center gap-2.5 bg-gray-50 p-1 px-2 rounded-full">
                    <button onclick="changeStep('val_${item.id}', -1)" class="stepper-btn">-</button>
                    <span id="val_${item.id}" class="font-bold text-[10px] w-4 text-center">0</span>
                    <button onclick="changeStep('val_${item.id}', 1)" class="stepper-btn">+</button>
                </div>
            </div></div>`).join('');

        document.getElementById('removalButtons').innerHTML = config.removalOptions.map((opt, idx) => `
            <button onclick="setRemoval(${opt.p}, this)" class="removal-btn flex-1 py-1 option-btn">
                <div class="text-[10px]">${opt.n}</div>
                <div class="text-[9px] opacity-60">$${opt.p}</div>
            </button>`).join('');

        document.getElementById('designList').innerHTML = '';
        calculate(); 
    }

    function setBasePrice(p, n, btn) { 
        selectedBasePrice = p; selectedBaseName = n; 
        document.querySelectorAll('.base-btn').forEach(b => b.classList.remove('active')); 
        if(btn) btn.classList.add('active'); 
        calculate(); 
    }

    function setRemoval(p, btn) { 
        currentRemovalPrice = p; 
        document.querySelectorAll('.removal-btn').forEach(b => b.classList.remove('active')); 
        if(btn) btn.classList.add('active'); 
        calculate(); 
    }

    function toggleAddon(el) { el.classList.toggle('selected'); calculate(); }
    
    function changeStep(id, delta) { 
        const el = document.getElementById(id); 
        if(el) {
            el.innerText = Math.max(0, parseInt(el.innerText) + delta); 
            calculate(); 
        }
    }

    function addDesignItem(name) {
        const id = 'd_' + Date.now();
        const config = calcUIConfigs[currentMode];
        const html = `
            <div id="${id}" class="design-row">
                <span class="font-bold text-[10px] text-gray-500 truncate bg-[#f5f2ee]/50 px-2 py-0.5 rounded-full">${name}</span>
                <input type="number" class="price-input k-input !py-0.5 !text-center !text-[11px] font-bold" value="${config.defaultDesignPrice}" oninput="calculate()">
                <div class="flex items-center justify-between bg-[#f5f2ee]/80 rounded-full px-2 py-0.5">
                    <button onclick="changeQty('${id}', -1)" class="text-[#2d4639] font-bold text-[12px] w-4">-</button>
                    <span class="qty font-bold text-[11px] w-4 text-center">1</span>
                    <button onclick="changeQty('${id}', 1)" class="text-[#2d4639] font-bold text-[12px] w-4">+</button>
                </div>
                <button onclick="this.parentElement.remove();calculate()" class="text-gray-300 text-[12px] font-bold">✕</button>
            </div>`;
        document.getElementById('designList').insertAdjacentHTML('beforeend', html);
        calculate();
    }

    function changeQty(id, delta) { 
        const el = document.querySelector(`#${id} .qty`); 
        if(el) {
            el.innerText = Math.max(1, parseInt(el.innerText) + delta); 
            calculate(); 
        }
    }

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('tab-regular').className = mode === 'regular' ? 'flex-1 py-1.5 text-[10px] rounded-full transition-all tab-active font-bold' : 'flex-1 py-1.5 text-[10px] rounded-full transition-all text-gray-400 font-bold';
        document.getElementById('tab-model').className = mode === 'model' ? 'flex-1 py-1.5 text-[10px] rounded-full transition-all tab-active font-bold' : 'flex-1 py-1.5 text-[10px] rounded-full transition-all text-gray-400 font-bold';
        
        selectedBasePrice = 0;
        selectedBaseName = "";
        currentRemovalPrice = 0;
        document.getElementById('adjAmount').value = '';
        initCalc();
    }

    function calculate() {
        let total = 0;
        let items = []; 

        let base = parsePrice(selectedBasePrice);
        total += base;
        if (base > 0 || selectedBaseName) {
            // 顯示時保留原始字串 (含符號)
            let displayPrice = String(selectedBasePrice).includes('$') ? selectedBasePrice : `$${selectedBasePrice}`;
            items.push({ n: selectedBaseName || '基本款式', display: displayPrice });
        }

        document.querySelectorAll('#designList > div').forEach(row => {
            const name = row.querySelector('span').innerText;
            const qty = parseInt(row.querySelector('.qty').innerText) || 1;
            const price = parsePrice(row.querySelector('.price-input').value); // 使用新的解析函數
            const subtotal = qty * price;
            total += subtotal;
            items.push({ n: `✨ ${name} (${qty}指)`, display: `$${subtotal}` });
        });

        document.querySelectorAll('.addon-card.selected').forEach(card => {
            const name = card.querySelector('.addon-name').innerText;
            const price = parsePrice(card.querySelector('.addon-price').innerText);
            total += price;
            items.push({ n: `➕ ${name}`, display: `$${price}` });
        });

        const remPrice = parsePrice(currentRemovalPrice);
        if (remPrice > 0) {
            total += remPrice;
            items.push({ n: `🧼 卸甲服務`, display: `$${remPrice}` });
        }

        calcUIConfigs[currentMode].specialRemoval.forEach(item => {
            const count = parseInt(document.getElementById('val_' + item.id)?.innerText || 0);
            const price = parsePrice(document.getElementById('price_' + item.id)?.value);
            if (count > 0) {
                const subtotal = count * price;
                total += subtotal;
                items.push({ n: `💎 ${item.name}卸除 (${count}指)`, display: `$${subtotal}` });
            }
        });

        const adj = parseInt(document.getElementById('adjAmount').value) || 0;
        if (adj !== 0) {
            total += adj;
            items.push({ n: adj > 0 ? '⚙️ 額外加價' : '🎁 優惠折扣', display: `$${adj}` });
        }

        document.getElementById('totalDisplay').innerText = total.toLocaleString();
        const sheetTotal = document.getElementById('sheetTotal');
        if(sheetTotal) sheetTotal.innerText = total.toLocaleString();

        const billContent = document.getElementById('billContent');
        if(billContent) {
            billContent.innerHTML = items.map(i => `
                <div class="flex justify-between border-b border-gray-50 py-3">
                    <span class="text-gray-500">${i.n}</span>
                    <b class="text-[#2d4639]">${i.display}</b>
                </div>
            `).join('');
        }
    }

    function copyBill() {
        const mode = currentMode === 'regular' ? '一般顧客' : '手模專區';
        calculate(); 
        const rows = document.querySelectorAll('#billContent > div');
        if(rows.length === 0) return alert("目前沒有項目");

        const itemsText = Array.from(rows).map(row => `${row.querySelector('span').innerText}：${row.querySelector('b').innerText}`).join('\n');
        const total = document.getElementById('totalDisplay').innerText;
        const text = `【 繆米美學 𝑴𝑬𝑨𝑾 𝑴𝑬 𝑩𝑬𝑨𝑼𝑻𝒀 】\n服務類型：${mode}\n\n結帳明細：\n------------------------\n${itemsText}\n------------------------\n總計金額：$${total}\n\n感謝您的預約 ✨`;
        
        navigator.clipboard.writeText(text).then(() => { 
            const btn = document.getElementById('copyBtn'); 
            btn.innerText = "COPIED"; 
            setTimeout(() => btn.innerText = "複製", 2000); 
        }).catch(err => {
            alert("複製失敗，請手動截圖");
        });
    }

    function resetCalculator() { 
        if (confirm('要清除嗎？')) { 
            document.getElementById('adjAmount').value = ''; 
            initCalc(); 
        } 
    }
    
    function toggleSheet(id, s) { 
        const sheet = document.getElementById(id);
        const overlay = document.getElementById('overlay'); 
        if(sheet) sheet.style.transform = s ? 'translateY(0)' : 'translateY(100%)'; 
        if(overlay) overlay.style.display = s ? 'block' : 'none'; 
    }

    // --- Calendar System Logic ---
    function initCalendarTimeSelect() {
        const h = document.getElementById('hSel');
        for(let i=9; i<=22; i++) h.innerHTML += `<option value="${String(i).padStart(2,'0')}">${i}</option>`;
    }

    function renderCalendar() {
        const isUserPage = document.getElementById('page-booking').classList.contains('active');
        const isAdminPage = document.getElementById('page-budget').classList.contains('active');
        let targetGridId = isUserPage ? 'booking-calendar-grid' : 'admin-calendar-grid';
        let targetDisplayId = isUserPage ? 'booking-month-display' : 'admin-month-display';
        if (!isUserPage && !isAdminPage) return; 

        const y = bookingState.viewDate.getFullYear();
        const m = bookingState.viewDate.getMonth();
        const mKey = `${y}-${m}`;
        const isOpened = (bookingState.data.openMonths || []).includes(mKey);
        
        const holidayMap = window.getTaiwanHolidays(); 

        document.getElementById(targetDisplayId).textContent = `${y} / ${String(m+1).padStart(2,'0')}`;

        if (isAdminPage) {
            const btn = document.getElementById('admin-month-status-btn');
            btn.textContent = isOpened ? "● 開放預約中 (點擊關閉)" : "○ 關閉中 (點擊開放)";
            btn.style.opacity = isOpened ? "1" : "0.5";
        }

        const overlayContainer = document.getElementById('calendar-overlay-msg');
        const grid = document.getElementById(targetGridId);

        if (isUserPage && overlayContainer) {
            const askBtn = document.getElementById('askBtn');
            const now = new Date();
            const currentY = now.getFullYear();
            const currentM = now.getMonth();
            const isPast = (y < currentY) || (y === currentY && m < currentM);

            if (isPast) {
                overlayContainer.classList.remove('hidden');
                document.getElementById('overlay-title').innerText = "當月預約已滿";
                document.getElementById('overlay-desc').innerText = "感謝大家的支持！";
                askBtn.classList.add('hidden');
                grid.classList.add('blur-target'); 
            } else if (!isOpened) {
                overlayContainer.classList.remove('hidden');
                document.getElementById('overlay-title').innerText = "當月預約尚未開放";
                document.getElementById('overlay-desc').innerHTML = "＊每月20號開放下月預約<br>實際依照官方LINE公告為主";
                askBtn.classList.add('hidden');
                grid.classList.add('blur-target');
            } else {
                overlayContainer.classList.add('hidden');
                askBtn.classList.remove('hidden');
                grid.classList.remove('blur-target');
            }

            if (bookingState.isAskMode) grid.classList.add('ask-mode'); else grid.classList.remove('ask-mode');
        }

        grid.innerHTML = '';

        const offset = (new Date(y, m, 1).getDay() || 7) - 1;
        const lastDate = new Date(y, m + 1, 0).getDate();
        const todayNum = new Date().setHours(0,0,0,0);

        for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;

        for(let d=1; d<=lastDate; d++) {
            const key = `${y}-${m}-${d}`;
            const dateObj = new Date(y, m, d);
            const isSun = dateObj.getDay() === 0;
            const isSat = dateObj.getDay() === 6; // [新增] 判斷週六
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isHoliday = !!holidayMap[dateStr];
            
            const isPastDay = dateObj.getTime() < todayNum;
            const slots = bookingState.data.bookings[key] || [];

            // 背景邏輯：週日維持淡紅底 (若週六也要淡紅底，可在此加入 || isSat)
            const div = document.createElement('div');
            div.className = `day-box ${isSun ? 'sunday-bg' : ''}`;
            if (isPastDay && isUserPage) div.classList.add('past-day');

            // [修改] 紅字邏輯：週日 OR 週六 OR 國定假日
            let dateClass = "font-bold text-[12px] ";
            if (isSun || isSat || isHoliday) {
                dateClass += "text-[#ff6b6b]";
            }

            // [修改處] 將日期稍微放大，文字縮小，製造層次感
            let html = `<div class="flex justify-between px-1.5 mb-1"><span class="${dateClass} !text-[13px] font-serif">${d}</span></div>`;

            if (isSun) {
                html += `<div class="text-[#ff6b6b] text-[9px] text-center opacity-80 mt-1">公休</div>`;
            } else {
                if (slots.length === 0) {
                     html += `<div class="text-[9px] text-center opacity-30 mt-1">約滿</div>`;
                } else {
                    slots.sort().forEach(t => {
                        const labelId = `${m+1}/${d} ${t}`;
                        const isSelected = bookingState.selectedTimes.includes(labelId);
                        const clickAttr = isUserPage ? `onclick="toggleTimeSelection('${labelId}')"` : '';
                        html += `<div class="time-label ${isSelected ? 'selected' : ''}" ${clickAttr}>${t}</div>`;
                    });
                }
            }

            if (isAdminPage) {
                html += `
                <div class="admin-day-controls">
                    <div class="tiny-btn" onclick="toggleDaySlots('${key}')">${slots.length>0?'全關':'預設'}</div>
                    <div class="tiny-btn edit" onclick="openTimeEditor('${key}', ${d})">編輯</div>
                </div>`;
            }

            div.innerHTML = html;
            grid.appendChild(div);
        }
    }

    function changeBookingMonth(dir) {
        bookingState.viewDate.setMonth(bookingState.viewDate.getMonth() + dir);
        renderCalendar();
    }

    // [修正] 時段管理開啟邏輯 (同步排除：週日、國定假日、手動排休日)
    function toggleMonthStatus() {
        const y = bookingState.viewDate.getFullYear();
        const m = bookingState.viewDate.getMonth();
        const mKey = `${y}-${m}`;
        const idx = bookingState.data.openMonths.indexOf(mKey);
        
        // 取得假日表
        const holidayMap = window.getTaiwanHolidays(); 

        if (idx > -1) {
            // 如果原本是開啟，則關閉 (從清單移除)
            bookingState.data.openMonths.splice(idx, 1);
        } else {
            // 如果原本是關閉，則開啟 (加入清單並生成時段)
            bookingState.data.openMonths.push(mKey);
            const lastDate = new Date(y, m + 1, 0).getDate();
            
            for(let d=1; d<=lastDate; d++) {
                const day = new Date(y, m, d).getDay();
                const key = `${y}-${m}-${d}`; // Booking Key (YYYY-M-D)
                
                // 產生 Finance Key (YYYY-MM-DD) 用來對照排休表
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // 1. 檢查是否國定假日
                const isHoliday = !!holidayMap[dateStr];
                
                // 2. [新增] 檢查是否在「預約管理」的手動排休名單中
                const isManualOff = (financeStore.manualOffDays || []).includes(dateStr);

                // 核心邏輯：
                // 非週日 (day !== 0)
                // 且 非國定假日 (!isHoliday)
                // 且 非手動排休 (!isManualOff)
                // 才產生預設時段
                if (day !== 0 && !isHoliday && !isManualOff) {
                    // 只針對「還沒有設定時段」或「時段為空」的日子填入預設值
                    // 避免覆蓋掉原本已經手動調整過的時段
                    if (!bookingState.data.bookings[key] || bookingState.data.bookings[key].length === 0) {
                         bookingState.data.bookings[key] = [...DEFAULTS_TIMES];
                    }
                }
            }
        }
        saveBookingData();
    }

    // [修正] 切換單日開關 (防呆：避開已存在財務中的預約)
    function toggleDaySlots(key) {
        const currentSlots = bookingState.data.bookings[key];
        
        // 如果目前有開放，則全關
        if (currentSlots && currentSlots.length > 0) {
            bookingState.data.bookings[key] = [];
        } else {
            // 要開啟預設時段，但必須先檢查財務有沒有衝堂
            // 1. 轉換 Key 格式以對應 Finance Data (YYYY-M-D -> YYYY-MM-DD)
            const [y, m, d] = key.split('-');
            const finKey = `${y}-${String(parseInt(m)+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const finEntries = safeArray(financeStore.data[finKey]);

            // 2. 過濾預設時段
            const safeDefaults = DEFAULTS_TIMES.filter(defaultTime => {
                // 檢查這個 defaultTime 是否跟任何一個 finEntry 衝突
                const [dH, dM] = defaultTime.split(':').map(Number);
                const dMins = dH * 60 + dM;

                // 檢查是否落在任何一個預約區間內
                const isOccupied = finEntries.some(e => {
                     const [eH, eM] = e.time.split(':').map(Number);
                     const eStart = eH * 60 + eM;
                     const eDur = parseInt(e.duration || 60, 10);
                     const eEnd = eStart + eDur;
                     // 如果預設時間 落在 預約開始與結束之間，就是被佔用了
                     return (dMins >= eStart && dMins < eEnd);
                });
                return !isOccupied; // 沒被佔用才保留
            });

            bookingState.data.bookings[key] = safeDefaults;
        }
        saveBookingData();
    }

    function openTimeEditor(key, d) {
        bookingState.editingKey = key;
        document.getElementById('editTitle').textContent = `編輯 ${key} 時段`;
        document.getElementById('editTimeModal').classList.remove('hidden');
        renderTimeChips();
    }

    function renderTimeChips() {
        const container = document.getElementById('timeChips');
        container.innerHTML = '';
        const currentSlots = bookingState.data.bookings[bookingState.editingKey] || [];
        const allTimes = [...new Set([...DEFAULTS_TIMES, ...currentSlots])].sort();

        allTimes.forEach(t => {
            const isActive = currentSlots.includes(t);
            const btn = document.createElement('button');
            btn.className = `p-2 text-xs rounded border ${isActive ? 'bg-[#c9b896] text-white border-[#c9b896]' : 'border-gray-300 text-gray-400'}`;
            btn.textContent = t;
            btn.onclick = () => {
                if (isActive) {
                    bookingState.data.bookings[bookingState.editingKey] = currentSlots.filter(x => x !== t);
                } else {
                    if (!bookingState.data.bookings[bookingState.editingKey]) bookingState.data.bookings[bookingState.editingKey] = [];
                    bookingState.data.bookings[bookingState.editingKey].push(t);
                }
                saveBookingData();
                renderTimeChips(); 
            };
            container.appendChild(btn);
        });
    }

    // [修正] 行事曆手動新增時段 (新增：財務衝突檢查與提醒)
    function addCustomTime() {
        const h = document.getElementById('hSel').value;
        const m = document.getElementById('mSel').value;
        const t = `${h}:${m}`;
        
        // 1. 基本檢查：是否已存在
        if (!bookingState.data.bookings[bookingState.editingKey]) {
            bookingState.data.bookings[bookingState.editingKey] = [];
        }
        if (bookingState.data.bookings[bookingState.editingKey].includes(t)) {
            return alert("此時段已存在");
        }

        // 2. [新增] 進階檢查：是否與財務行程衝突
        // 轉換 Key 格式 (Booking Key "2026-1-8" -> Finance Key "2026-02-08")
        const [yStr, mStr, dStr] = bookingState.editingKey.split('-');
        const y = parseInt(yStr);
        const mm = parseInt(mStr) + 1; // booking key 的月是 0-base，轉成 1-base
        const dd = parseInt(dStr);
        const finKey = `${y}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
        
        const finEntries = safeArray(financeStore.data[finKey]);
        
        if (finEntries.length > 0) {
            // 計算欲新增的時間點 (分鐘數)
            const newMins = parseInt(h) * 60 + parseInt(m);
            
            // 檢查是否有任何預約覆蓋了這個時間點
            // 邏輯：如果 新增時間 >= 預約開始 AND 新增時間 < 預約結束，就是衝突
            const conflictEntry = finEntries.find(e => {
                const [eH, eM] = e.time.split(':').map(Number);
                const startMins = eH * 60 + eM;
                const dur = parseInt(e.duration || 60);
                const endMins = startMins + dur;
                
                return (newMins >= startMins && newMins < endMins);
            });

            if (conflictEntry) {
                // 算出結束時間方便顯示
                const [cH, cM] = conflictEntry.time.split(':').map(Number);
                const cDur = parseInt(conflictEntry.duration || 60);
                const cEndMins = cH * 60 + cM + cDur;
                const cEndH = Math.floor(cEndMins / 60);
                const cEndM = cEndMins % 60;
                const cEndStr = `${String(cEndH).padStart(2,'0')}:${String(cEndM).padStart(2,'0')}`;

                const msg = `⚠️ 警告：時段衝突！\n\n您想開啟的 ${t} 與現有預約重疊：\n預約：${conflictEntry.time} - ${cEndStr} (${conflictEntry.items[0]})\n\n確定要強制開啟嗎？(可能導致重複預約)`;
                
                if (!confirm(msg)) return; // 使用者按取消，則不新增
            }
        }

        // 3. 通過檢查，執行新增
        bookingState.data.bookings[bookingState.editingKey].push(t);
        bookingState.data.bookings[bookingState.editingKey].sort(); // 排序讓顯示更整齊
        saveBookingData();
        renderTimeChips();
    }

    function closeEditModal() {
        document.getElementById('editTimeModal').classList.add('hidden');
        renderCalendar();
    }

    window.showGuide = function() {
        if (bookingState.isAskMode) {
            toggleAskMode(); // 如果已經是選取模式，按鈕功能變為取消
        } else {
            document.getElementById('guideModal').classList.remove('hidden'); // 否則顯示教學
        }
    };

    window.startAskMode = function() {
        document.getElementById('guideModal').classList.add('hidden');
        toggleAskMode(); // 關閉教學並啟動選取
    };

    function toggleAskMode() {
        bookingState.isAskMode = !bookingState.isAskMode;
        bookingState.selectedTimes = [];
        const btn = document.getElementById('askBtn');
        const confirmBtn = document.getElementById('confirmSelectionBtn');
        
        if (bookingState.isAskMode) {
            btn.textContent = "取消選取";
            confirmBtn.style.display = "inline-block";
        } else {
            btn.textContent = "詢問時段";
            confirmBtn.style.display = "none";
        }
        renderCalendar();
    }

    function toggleTimeSelection(label) {
        if (!bookingState.isAskMode) return;
        const idx = bookingState.selectedTimes.indexOf(label);
        if (idx > -1) {
            bookingState.selectedTimes.splice(idx, 1);
        } else {
            if (bookingState.selectedTimes.length >= 3) {
                alert("最多選擇 3 個時段");
                return;
            }
            bookingState.selectedTimes.push(label);
        }
        renderCalendar();
    }

    function openAskDialog() {
        if (bookingState.selectedTimes.length === 0) return alert("請先選擇時段");
        document.getElementById('selectedTimesPreview').textContent = "您選取的時段：\n" + bookingState.selectedTimes.join('\n');
        document.getElementById('askDialog').classList.remove('hidden');
    }

    function copyToLine() {
        const item = document.getElementById('serviceInput').value || "(未填寫)";
        const text = `您好，我想詢問預約：\n項目：${item}\n偏好時段：${bookingState.selectedTimes.join('、')}\n再麻煩幫我確認，謝謝！`;
        navigator.clipboard.writeText(text).then(() => {
            alert("已複製！將跳轉至 LINE");
            location.href = "https://lin.ee/kv6nqyW";
        });
    }

    function toggleDropdown(header) {
        const container = header.parentElement;
        container.classList.toggle('open');
    }

    function showAdminLogin() { document.getElementById('admin-login-overlay').classList.add('active'); }
    function hideAdminLogin() { document.getElementById('admin-login-overlay').classList.remove('active'); document.getElementById('admin-pwd').value = ''; }

    // [修改] 登入成功後，透過 Hash 跳轉
    function checkAdminNew() {
        const pwd = document.getElementById('admin-pwd').value;
        if (pwd === '2002') { 
            hideAdminLogin();
            document.body.classList.add('admin-mode');
            
            // 切換 Nav 顯示
            document.getElementById('nav-guest').classList.add('hidden');
            document.getElementById('nav-admin').classList.remove('hidden');
            document.getElementById('nav-admin').classList.add('active-flex');
            
            // [修改] 登入後預設進入「財務管理」
            location.hash = 'admin-finance';
        } else {
            alert('密碼錯誤');
        }
    }

    // [修正] 匯出空檔邏輯：改為匯出「有時段的日期」 (即有開放的時段)
    function exportAvailableSlots() {
        let result = "";
        const y = bookingState.viewDate.getFullYear();
        const m = bookingState.viewDate.getMonth();
        const lastDate = new Date(y, m + 1, 0).getDate();
        
        let hasData = false;
        
        for(let d=1; d<=lastDate; d++) {
            const key = `${y}-${m}-${d}`;
            const slots = bookingState.data.bookings[key] || [];
            
            // 只要有設定時段，就匯出
            if(slots.length > 0) {
                hasData = true;
                result += `${m+1}/${d} ${slots.sort().join('、')}\n`;
            }
        }
        
        if(!hasData) result = "本月無開放時段";
        
        const text = `.ᐟ.ᐟ.ᐟ.ᐟ ${m+1}月可預約時段 .ᐟ.ᐟ.ᐟ.ᐟ\n〚請先私訊詢問再做預約〛\n${result}`;
        
        navigator.clipboard.writeText(text).then(() => {
            alert("已複製可預約時段！\n\n" + text);
        }).catch(err => {
            alert("複製失敗，請手動複製：\n" + text);
        });
    }

    // [智慧修正版] 同步帳務預約 (Finance) - 自動識別資料結構
    // ★ 如果您是「新增/編輯預約」看不到，主要是靠這一段救回來
    function syncFinanceV2() {
        if (window.dbOnValue && window.dbRef) {
            window.dbOnValue(window.dbRef(window.firebaseDB, 'meawMeFinanceV2'), (snapshot) => {
                const val = snapshot.val();
                // console.log("雲端帳務資料:", val); // 除錯用

                if(val) {
                    // 智慧判斷：資料是被包在 data 裡，還是直接就是資料？
                    if (val.data || val.manualOffDays) {
                        // 結構 A：標準格式
                        financeStore.data = val.data || {};
                        financeStore.manualOffDays = safeArray(val.manualOffDays);
                        financeStore.offDayNotes = val.offDayNotes || {};
                    } else {
                        // 結構 B：資料直接散落在根目錄 (這是最常見造成「看得到卻讀不到」的原因)
                        financeStore.data = val;
                        financeStore.manualOffDays = [];
                        financeStore.offDayNotes = {};
                    }
                }
                renderFinancePage();
                if (!document.getElementById('dayDetailModal').classList.contains('hidden')) {
                    renderDayDetailList();
                }
            });
        }
    }

    // [修正版] 同步結算單資料 (包含按鈕狀態刷新)
    function syncSettlements() {
        if (window.dbOnValue && window.dbRef) {
            window.dbOnValue(window.dbRef(window.firebaseDB, 'meawMeSettlements'), (snapshot) => {
                settlementData = snapshot.val() || {};
               
                const isSettleOpen = !document.getElementById('settlementModal').classList.contains('hidden');
                const isDetailOpen = !document.getElementById('dayDetailModal').classList.contains('hidden');

                if (isSettleOpen || isDetailOpen) {
                    checkSettlementStatus();
                }
            });
        }
    }

    // --- [NEW] 財務報表系統變數與同步 ---
    let expenseData = {}; 
    let reportState = { tab: 'calendar', date: new Date(), calDate: new Date() };

    function syncExpenses() {
        if (window.dbOnValue && window.dbRef) {
            window.dbOnValue(window.dbRef(window.firebaseDB, 'meawMeExpenses'), (snapshot) => {
                expenseData = snapshot.val() || {};
                // 如果報表頁面開著，刷新它
                if (document.getElementById('page-admin-report').classList.contains('active')) {
                    if (reportState.tab === 'calendar') renderReportCalendar();
                    else if (reportState.tab === 'month') renderMonthlyReport();
                    else renderYearlyReport();
                }
                // 如果記帳彈窗開著，刷新它
                if (!document.getElementById('accountingModal').classList.contains('hidden')) {
                    renderAccountingModal();
                }
            });
        }
    }

    // --- 頁面切換邏輯 ---
    window.switchReportTab = function(tab, btn) {
        reportState.tab = tab;
        document.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.getElementById('report-view-calendar').classList.add('hidden');
        document.getElementById('report-view-month').classList.add('hidden');
        document.getElementById('report-view-year').classList.add('hidden');
        
        document.getElementById(`report-view-${tab}`).classList.remove('hidden');
        
        if (tab === 'calendar') renderReportCalendar();
        if (tab === 'month') renderMonthlyReport();
        if (tab === 'year') renderYearlyReport();
    };
    
    // 日曆切換月份
    window.changeReportCalendarMonth = function(dir) {
        reportState.calDate.setMonth(reportState.calDate.getMonth() + dir);
        renderReportCalendar();
    };

    // 報表切換日期
    window.changeReportDate = function(type, dir) {
        if (type === 'month') reportState.date.setMonth(reportState.date.getMonth() + dir);
        if (type === 'year') reportState.date.setFullYear(reportState.date.getFullYear() + dir);
        
        if (type === 'month') renderMonthlyReport();
        if (type === 'year') renderYearlyReport();
    };

    // [修正版] 財務日曆渲染 (加入防呆保護 + 今天金色邊框 + 修正錯誤)
    window.renderReportCalendar = function() {
        const y = reportState.calDate.getFullYear();
        const m = reportState.calDate.getMonth();
        const displayEl = document.getElementById('rep-cal-month-display');
        if(displayEl) displayEl.textContent = `${y} / ${String(m+1).padStart(2,'0')}`;
        
        const grid = document.getElementById('report-calendar-grid');
        if(!grid) return; // 防呆：如果找不到元件就停止
        grid.innerHTML = '';
        
        const firstDay = new Date(y, m, 1).getDay();
        const offset = (firstDay === 0 ? 6 : firstDay - 1);
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const holidayMap = window.getTaiwanHolidays();
        
        // 取得今天的日期字串，用於金色邊框
        const todayObj = new Date();
        const todayStr = `${todayObj.getFullYear()}-${String(todayObj.getMonth()+1).padStart(2,'0')}-${String(todayObj.getDate()).padStart(2,'0')}`;

        let mRev = 0, mExp = 0;

        for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayOfWeek = new Date(y, m, d).getDay();
            
            // [防呆修正] 確保 financeStore.manualOffDays 是一個陣列，避免 undefined 錯誤
            const manualOffDays = financeStore.manualOffDays || [];
            const isRedDay = (dayOfWeek === 0 || dayOfWeek === 6 || holidayMap[dateStr] || manualOffDays.includes(dateStr));
            const isToday = (dateStr === todayStr);
            
            // 1. 計算當日營收
            let dailyRev = { cash:0, transfer:0, linepay:0, jko:0, stored:0, total:0 };
            
            // 服務收入 (防呆：確保 data[dateStr] 存在)
            const dayEntries = safeArray((financeStore.data || {})[dateStr]);
            dayEntries.forEach(e => {
                if (e.status === 'checked' && e.checkoutDetails) {
                    const amt = parseInt(e.checkoutDetails.finalTotal) - parseInt(e.checkoutDetails.paidDeposit || 0);
                    if(amt > 0) {
                        const method = e.checkoutDetails.paymentMethod || 'cash';
                        if (dailyRev[method] !== undefined) dailyRev[method] += amt;
                        dailyRev.total += amt;
                    }
                }
            });

            // 定金收入
            Object.keys(financeStore.data || {}).forEach(k => {
                safeArray(financeStore.data[k]).forEach(e => {
                    if ((e.hasDeposit || (e.depositMethod && e.depositMethod!=='none')) && e.depositDate === dateStr) {
                         const method = e.depositMethod || 'transfer';
                         const amt = parseInt(e.depositAmount || 100);
                         if (dailyRev[method] !== undefined) dailyRev[method] += amt;
                         dailyRev.total += amt;
                    }
                });
            });

            // 2. 計算當日支出 (防呆：確保 expenseData 存在)
            let dailyExp = 0;
            const dayExps = safeArray((expenseData || {})[dateStr]);
            dayExps.forEach(e => dailyExp += parseInt(e.amount));

            mRev += dailyRev.total;
            mExp += dailyExp;

            // 渲染格子
            const box = document.createElement('div');
            box.className = `fin-day-box ${isRedDay ? 'is-holiday-bg' : ''}`;
            box.style.minHeight = "100px";
            box.onclick = () => openAccounting(dateStr);
            
            // [關鍵] 如果是今天，套用與預約管理頁面完全相同的金色邊框樣式
            if (isToday) {
                box.style.cssText = `border: 2px solid var(--gold-main) !important; box-shadow: inset 0 0 10px rgba(201, 184, 150, 0.3) !important; overflow: hidden; min-height: 100px;`;
            } else {
                box.style.overflow = "hidden";
            }
            
            let html = `<div class="flex justify-between text-[10px] ${isRedDay?'text-[#ff6b6b] font-bold':'opacity-50'}">
                <span>${d}</span><span>${isRedDay?'休':''}</span>
            </div>`;
            
            html += `<div class="fin-cal-cell">`;
            if (dailyRev.cash > 0) html += `<div class="fin-cal-row"><span>現</span><span>${dailyRev.cash}</span></div>`;
            if (dailyRev.transfer > 0) html += `<div class="fin-cal-row"><span>匯</span><span>${dailyRev.transfer}</span></div>`;
            if (dailyRev.linepay > 0) html += `<div class="fin-cal-row"><span>LP</span><span>${dailyRev.linepay}</span></div>`;
            if (dailyRev.jko > 0) html += `<div class="fin-cal-row"><span>街</span><span>${dailyRev.jko}</span></div>`;
            if (dailyRev.stored > 0) html += `<div class="fin-cal-row"><span>儲</span><span>${dailyRev.stored}</span></div>`;
            
            if (dailyExp > 0) html += `<div class="fin-cal-row text-[#ff6b6b] mt-1 border-t border-white/10 pt-1"><span>支</span><span>-${dailyExp}</span></div>`;
            
            html += `<div class="fin-cal-total">$${dailyRev.total}</div>`;
            html += `</div>`;
            
            box.innerHTML = html;
            grid.appendChild(box);
        }
        
        // 更新底部加總 (防呆：如果找不到元件就不更新)
        const elRev = document.getElementById('cal-month-rev');
        const elExp = document.getElementById('cal-month-exp');
        const elNet = document.getElementById('cal-month-net');
        
        if(elRev) elRev.innerText = `$${mRev.toLocaleString()}`;
        if(elExp) elExp.innerText = `$${mExp.toLocaleString()}`;
        if(elNet) elNet.innerText = `$${(mRev - mExp).toLocaleString()}`;
    };

    // [新增] 一鍵回到當前日期功能 (放在 renderReportCalendar 下方)
    window.resetToToday = function(type) {
        const today = new Date(); // 產生當下時間物件
        
        if (type === 'booking') {
            bookingState.viewDate = new Date(today); 
            renderCalendar();
        } 
        else if (type === 'finance') {
            financeStore.viewDate = new Date(today);
            renderFinancePage();
        } 
        else if (type === 'report-cal') {
            reportState.calDate = new Date(today);
            renderReportCalendar();
        }
        else if (type === 'report-month') {
            reportState.date = new Date(today);
            renderMonthlyReport();
        }
        else if (type === 'report-year') {
            reportState.date = new Date(today);
            renderYearlyReport();
        }
    };

    // --- [更新] 記帳彈窗邏輯 (包含轉帳與錢包) ---
    window.openAccounting = function(dateStr) {
        activeDateStr = dateStr;
        document.getElementById('accountingModal').classList.remove('hidden');
        document.getElementById('acc-date-title').innerText = `${dateStr} 記帳本`;
        renderAccountingModal();
    };

    function renderAccountingModal() {
        // 1. 庫存邏輯 (需要扣掉當天的轉出與支出)
        const dates = Object.keys(settlementData).sort().reverse();
        const lastDate = dates[0]; // 抓最近一次結算的餘額
        const lastSettle = settlementData[lastDate] || { pettyCash: 0, allocations: [] };
        
        let petty = lastSettle.pettyCash || 0;
        let backup = lastSettle.allocations ? (lastSettle.allocations.find(a => a.target === '備用金')?.amount || 0) : 0;
        
        // 簡易扣除今日的即時支出 (僅供參考，不精確回推歷史)
        const exps = safeArray(expenseData[activeDateStr]);
        exps.forEach(e => {
            if (e.source === 'petty') petty -= e.amount;
            if (e.source === 'backup') backup -= e.amount;
            // wallet 支出不影響店內庫存
        });

        document.getElementById('acc-petty-cash').innerText = `$${petty}`;
        document.getElementById('acc-backup-cash').innerText = `$${backup}`;

        // 2. 營收 (與之前相同)
        const revList = document.getElementById('acc-revenue-list');
        revList.innerHTML = '';
        let totalRev = 0;
        let methods = { cash:0, transfer:0, linepay:0, jko:0, stored:0 };
        
        safeArray(financeStore.data[activeDateStr]).forEach(e => {
            if (e.status === 'checked' && e.checkoutDetails) {
                const amt = parseInt(e.checkoutDetails.finalTotal) - parseInt(e.checkoutDetails.paidDeposit || 0);
                if(amt > 0) methods[e.checkoutDetails.paymentMethod || 'cash'] += amt;
            }
        });
        Object.keys(financeStore.data).forEach(k => {
            safeArray(financeStore.data[k]).forEach(e => {
                if ((e.hasDeposit || (e.depositMethod && e.depositMethod!=='none')) && e.depositDate === activeDateStr) {
                     methods[e.depositMethod || 'transfer'] += parseInt(e.depositAmount || 100);
                }
            });
        });

        for (let [k, v] of Object.entries(methods)) {
            if (v > 0) {
                totalRev += v;
                revList.innerHTML += `<div class="flex justify-between"><span>${k==='cash'?'現金':(k==='transfer'?'匯款':(k==='linepay'?'LinePay':(k==='jko'?'街口':'儲值金')))}</span><span>$${v}</span></div>`;
            }
        }
        document.getElementById('acc-revenue-total').innerText = totalRev;

        // 3. 支出與轉帳明細
        const expList = document.getElementById('acc-expense-list');
        expList.innerHTML = '';
        
        exps.forEach((e, idx) => {
            let badgeColor = "bg-gray-200 text-gray-600";
            let amountColor = "text-[#ff6b6b]";
            let sign = "-";
            
            // 如果是轉帳/提領
            if (e.cat === 'transfer_out') {
                badgeColor = "bg-[#ffcc80] text-[#e65100]";
                amountColor = "text-[#f57c00]";
            }
            
            const sourceMap = { 'petty': '零用金', 'backup': '備用金', 'wallet': '錢包', 'other': '其他' };
            
            expList.innerHTML += `
                <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-200">
                    <div>
                        <span class="text-[10px] px-1 rounded ${badgeColor}">${e.cat==='transfer_out'?'提領':e.cat}</span>
                        <span class="font-bold ml-1">${e.name}</span>
                        <div class="text-[10px] text-gray-400">來源: ${sourceMap[e.source]}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold ${amountColor}">${sign}$${e.amount}</span>
                        <button onclick="deleteExpense(${idx})" class="text-gray-400">✕</button>
                    </div>
                </div>`;
        });
    }

    // [新增] 轉帳/提領功能
    window.addTransfer = function() {
        const source = document.getElementById('transfer-source').value;
        const amount = parseInt(document.getElementById('transfer-amount').value);
        
        if (isNaN(amount) || amount <= 0) return alert("請輸入金額");
        
        if (!expenseData[activeDateStr]) expenseData[activeDateStr] = [];
        
        // 轉帳也被視為一種「支出」(從店內流出到錢包)
        expenseData[activeDateStr].push({ 
            cat: 'transfer_out', 
            name: '提領至錢包', 
            amount: amount, 
            source: source, 
            id: Date.now() 
        });

        saveExpenseToDB();
    };

    window.addExpense = function() {
        const cat = document.getElementById('exp-cat').value;
        const name = document.getElementById('exp-name').value;
        const amount = parseInt(document.getElementById('exp-amount').value);
        const source = document.getElementById('exp-source').value;

        if (!name || isNaN(amount) || amount <= 0) return alert("請輸入正確資訊");

        if (!expenseData[activeDateStr]) expenseData[activeDateStr] = [];
        expenseData[activeDateStr].push({ cat, name, amount, source, id: Date.now() });

        saveExpenseToDB();
    };
    
    function saveExpenseToDB() {
        window.dbSet(window.dbRef(window.firebaseDB, `meawMeExpenses/${activeDateStr}`), expenseData[activeDateStr])
            .then(() => {
                // 清空輸入框
                document.getElementById('exp-name').value = '';
                document.getElementById('exp-amount').value = '';
                document.getElementById('transfer-amount').value = '';
                
                renderAccountingModal();
                if(reportState.tab === 'calendar') renderReportCalendar();
            });
    }

    window.deleteExpense = function(idx) {
        if (!confirm("確定刪除此筆支出？")) return;
        expenseData[activeDateStr].splice(idx, 1);
        saveExpenseToDB();
    };

    // --- 月報表與年報表生成邏輯 ---
    function generateReportData(year, month = null) {
        const data = {
            rev: { cash:0, credit:0, transfer:0, linepay:0, jko:0, stored:0, total:0 },
            exp: { fixed:0, equip:0, consume:0, refund:0, total:0 },
            services: {},
            attendance: { total:0, checked:0, noshow:0 }
        };

        // 1. 統計營收與出席
        Object.keys(financeStore.data).forEach(dateKey => {
            const [y, m, d] = dateKey.split('-').map(Number);
            if (y !== year) return;
            if (month !== null && m !== (month + 1)) return;

            const entries = safeArray(financeStore.data[dateKey]);
            entries.forEach(e => {
                data.attendance.total++;
                if (e.status === 'checked') data.attendance.checked++;
                if (e.status === 'noshow') data.attendance.noshow++;

                safeArray(e.items).forEach(item => {
                    const n = item.split(' x')[0]; // 去除數量
                    data.services[n] = (data.services[n] || 0) + 1;
                });
                
                if (e.status === 'checked' && e.checkoutDetails) {
                    const amt = parseInt(e.checkoutDetails.finalTotal) - parseInt(e.checkoutDetails.paidDeposit || 0);
                    if (amt > 0) {
                        const method = e.checkoutDetails.paymentMethod || 'cash';
                        if (data.rev[method] !== undefined) data.rev[method] += amt;
                        data.rev.total += amt;
                    }
                }
            });
        });

        // 2. 統計定金
        Object.keys(financeStore.data).forEach(dateKey => {
            safeArray(financeStore.data[dateKey]).forEach(e => {
                if (e.depositDate) {
                    const [dy, dm, dd] = e.depositDate.split('-').map(Number);
                    if (dy !== year) return;
                    if (month !== null && dm !== (month + 1)) return;

                    if (e.hasDeposit || (e.depositMethod && e.depositMethod !== 'none')) {
                         const method = e.depositMethod || 'transfer';
                         const amt = parseInt(e.depositAmount || 100);
                         if (data.rev[method] !== undefined) data.rev[method] += amt;
                         data.rev.total += amt;
                    }
                }
            });
        });

        // 3. 統計支出
        Object.keys(expenseData).forEach(dateKey => {
            const [y, m, d] = dateKey.split('-').map(Number);
            if (y !== year) return;
            if (month !== null && m !== (month + 1)) return;

            safeArray(expenseData[dateKey]).forEach(e => {
                const map = { '耗材':'consume', '設備':'equip', '固定支出':'fixed', '退款':'refund' };
                const key = map[e.cat] || 'fixed';
                data.exp[key] += parseInt(e.amount);
                data.exp.total += parseInt(e.amount);
            });
        });

        return data;
    }

    // [更新] 月報表渲染：加入平均日收與客單價
    window.renderMonthlyReport = function() {
        const y = reportState.date.getFullYear();
        const m = reportState.date.getMonth();
        document.getElementById('report-month-title').innerText = `${y} 年 ${m+1} 月`;
        
        const d = generateReportData(y, m);
        const profit = d.rev.total - d.exp.total;
        const margin = d.rev.total > 0 ? Math.round((profit / d.rev.total) * 100) : 0;
        const attendRate = d.attendance.total > 0 ? Math.round((d.attendance.checked / d.attendance.total) * 100) : 0;
        const sortedServices = Object.entries(d.services).sort((a,b) => b[1] - a[1]).slice(0, 5);

        // 新增計算公式
        const daysInMonth = new Date(y, m + 1, 0).getDate(); // 當月總天數
        // 平均日收 (總營收 / 當月天數)
        const avgDaily = Math.round(d.rev.total / daysInMonth);
        // 平均客單 (總營收 / 實際服務人數) -> 避免除以 0
        const avgTicket = d.attendance.checked > 0 ? Math.round(d.rev.total / d.attendance.checked) : 0;

        let html = `
            <div class="report-card !bg-[#1a3a2e] !text-[#f5f1e8]">
                <div class="text-center opacity-70 text-sm">本月淨利 (盈餘)</div>
                <div class="report-big-stat text-[#c9b896]">$${profit.toLocaleString()}</div>
                
                <div class="flex justify-around mt-4 border-t border-white/10 pt-2">
                    <div><div class="text-xs opacity-50">總營收</div><div class="font-bold">$${d.rev.total.toLocaleString()}</div></div>
                    <div><div class="text-xs opacity-50">總支出</div><div class="font-bold text-[#ff6b6b]">$${d.exp.total.toLocaleString()}</div></div>
                    <div><div class="text-xs opacity-50">毛利率</div><div class="font-bold text-[#c9b896]">${margin}%</div></div>
                </div>

                <div class="flex justify-around mt-2 border-t border-white/10 pt-2 pb-1">
                    <div class="text-center">
                        <div class="text-[10px] opacity-50">平均日收</div>
                        <div class="font-bold text-sm">$${avgDaily.toLocaleString()}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] opacity-50">平均單價</div>
                        <div class="font-bold text-sm text-[#c9b896]">$${avgTicket.toLocaleString()}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] opacity-50">服務人次</div>
                        <div class="font-bold text-sm">${d.attendance.checked} 人</div>
                    </div>
                </div>
            </div>

            <div class="report-card">
                <div class="report-section-title">📊 營收來源分析</div>
                <div class="stat-grid">
                    <div class="stat-box"><div class="stat-label">現金</div><div class="stat-val">$${d.rev.cash.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">匯款</div><div class="stat-val">$${d.rev.transfer.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">Line Pay</div><div class="stat-val">$${d.rev.linepay.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">街口</div><div class="stat-val">$${d.rev.jko.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">儲值金扣抵</div><div class="stat-val">$${d.rev.stored.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">信用卡</div><div class="stat-val">$${d.rev.credit.toLocaleString()}</div></div>
                </div>
            </div>

            <div class="report-card">
                <div class="report-section-title">💸 支出類別統計</div>
                <div class="stat-grid">
                    <div class="stat-box"><div class="stat-label">固定支出</div><div class="stat-val">$${d.exp.fixed.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">耗材</div><div class="stat-val">$${d.exp.consume.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">設備</div><div class="stat-val">$${d.exp.equip.toLocaleString()}</div></div>
                    <div class="stat-box"><div class="stat-label">退款</div><div class="stat-val">$${d.exp.refund.toLocaleString()}</div></div>
                </div>
            </div>

            <div class="report-card">
                <div class="report-section-title">🔥 熱門項目 & 出席</div>
                <div class="flex justify-between mb-4 text-xs font-bold text-center bg-gray-50 p-2 rounded">
                    <span>總預約: ${d.attendance.total}</span>
                    <span>報到: ${d.attendance.checked}</span>
                    <span class="text-[#ff6b6b]">爽約: ${d.attendance.noshow}</span>
                    <span class="text-[#1a3a2e]">出席率: ${attendRate}%</span>
                </div>
                ${sortedServices.map(([name, count]) => `
                    <div class="bar-container">
                        <div class="bar-label"><span>${name}</span><span>${count}次</span></div>
                        <div class="bar-bg"><div class="bar-fill" style="width:${(count/sortedServices[0][1])*100}%"></div></div>
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('month-report-content').innerHTML = html;
    };

    // [更新] 年報表渲染：同樣加入平均數據
    window.renderYearlyReport = function() {
        const y = reportState.date.getFullYear();
        document.getElementById('report-year-title').innerText = `${y} 年度報表`;
        
        const d = generateReportData(y, null);
        const profit = d.rev.total - d.exp.total;
        const margin = d.rev.total > 0 ? Math.round((profit / d.rev.total) * 100) : 0;

        // 計算年度天數 (簡單算 365)
        const daysInYear = 365;
        const avgDaily = Math.round(d.rev.total / daysInYear);
        const avgTicket = d.attendance.checked > 0 ? Math.round(d.rev.total / d.attendance.checked) : 0;

        let html = `
            <div class="report-card !bg-[#1a3a2e] !text-[#f5f1e8]">
                <div class="text-center opacity-70 text-sm">年度總淨利</div>
                <div class="report-big-stat text-[#c9b896]">$${profit.toLocaleString()}</div>
                 <div class="flex justify-around mt-4 border-t border-white/10 pt-2">
                    <div><div class="text-xs opacity-50">總營收</div><div class="font-bold">$${d.rev.total.toLocaleString()}</div></div>
                    <div><div class="text-xs opacity-50">總支出</div><div class="font-bold text-[#ff6b6b]">$${d.exp.total.toLocaleString()}</div></div>
                    <div><div class="text-xs opacity-50">毛利率</div><div class="font-bold text-[#c9b896]">${margin}%</div></div>
                </div>
                
                <div class="flex justify-around mt-2 border-t border-white/10 pt-2 pb-1">
                    <div class="text-center">
                        <div class="text-[10px] opacity-50">日均營收</div>
                        <div class="font-bold text-sm">$${avgDaily.toLocaleString()}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] opacity-50">平均單價</div>
                        <div class="font-bold text-sm text-[#c9b896]">$${avgTicket.toLocaleString()}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-[10px] opacity-50">總人次</div>
                        <div class="font-bold text-sm">${d.attendance.checked}</div>
                    </div>
                </div>
            </div>
            
            <div class="report-card">
                 <div class="report-section-title">年度營收結構</div>
                 <div class="list-row header"><span>方式</span><span>金額</span></div>
                 <div class="list-row"><span>現金</span><span>$${d.rev.cash.toLocaleString()}</span></div>
                 <div class="list-row"><span>匯款</span><span>$${d.rev.transfer.toLocaleString()}</span></div>
                 <div class="list-row"><span>Line Pay</span><span>$${d.rev.linepay.toLocaleString()}</span></div>
                 <div class="list-row"><span>街口</span><span>$${d.rev.jko.toLocaleString()}</span></div>
                 <div class="list-row"><span>儲值金</span><span>$${d.rev.stored.toLocaleString()}</span></div>
            </div>
        `;
        document.getElementById('year-report-content').innerHTML = html;
    };

    // --- [新增] 結算系統邏輯 ---
    
    // 1. 開啟結算視窗
    window.openSettlement = function() {
        document.getElementById('settlementModal').classList.remove('hidden');
        document.getElementById('settle-date').innerText = activeDateStr;
        checkSettlementStatus(); 
    };

    // [修正版] 檢查與同步所有結算狀態
    window.checkSettlementStatus = function() {
        // 1. 取得當前資料狀態
        const record = settlementData[activeDateStr];
        const isSettled = record && record.status === 'settled';
        
        // 2. 抓取所有相關 UI
        const badge = document.getElementById('settle-status-badge');
        const btnCashier = document.getElementById('btn-open-cashier');
        const btnUnlockArea = document.getElementById('settle-action-area');
        const btnDailySettle = document.getElementById('btn-daily-settle'); // 前一頁按鈕

        // 3. 強制同步「前一頁」的按鈕 (防止跳回去時跑掉)
        if (btnDailySettle) {
            if (isSettled) {
                btnDailySettle.innerText = "📋結算詳情";
                btnDailySettle.className = "settle-btn settle-btn-main"; 
            } else {
                btnDailySettle.innerText = "💰當日結算";
                btnDailySettle.className = "settle-btn settle-btn-outline"; 
            }
        }

        // 4. 控制「結算視窗」內部
        if (isSettled) {
            // === 🔒 已結算 (唯讀) ===
            if(badge) { badge.className = 'settled-badge'; badge.innerText = '已結算'; }
            
            // 零用金按鈕 -> 變為查看模式 (true)
            if(btnCashier) {
                btnCashier.classList.remove('hidden');
                btnCashier.innerHTML = `<span>💵 查看零用金</span><span>❯</span>`;
                btnCashier.onclick = () => openCashier(true); 
                btnCashier.classList.add('opacity-80'); 
            }
            
            // 顯示解鎖按鈕
            if(btnUnlockArea) btnUnlockArea.classList.remove('hidden');

        } else {
            // === ✏️ 未結算 / 編輯中 ===
            if(badge) { badge.className = ''; badge.innerText = ''; }
            
            // 零用金按鈕 -> 變為編輯模式 (false)
            if(btnCashier) {
                btnCashier.classList.remove('hidden');
                btnCashier.innerHTML = `<span>💵 零用金結算</span><span>❯</span>`;
                btnCashier.onclick = () => openCashier(false);
                btnCashier.classList.remove('opacity-80');
            }
            
            // 隱藏解鎖按鈕
            if(btnUnlockArea) btnUnlockArea.classList.add('hidden');
        }

        calculateDailyFinancials(); 
    };

    // 3. 計算當日財務 (定金 + 服務) - [已修改：定金與服務皆包含分類統計]
    function calculateDailyFinancials() {
        const depositDetails = [];
        const serviceDetails = [];
        let depositTotal = 0;
        let serviceTotal = 0;
        
        // 定義對照表
        const typeMap = {'cash':'現金', 'transfer':'匯款', 'linepay':'LinePay', 'jko':'街口', 'stored':'儲值金', 'none':'無'};

        // 準備統計物件
        let depositByType = { cash:0, transfer:0, linepay:0, jko:0, stored:0 };
        let serviceByType = { cash:0, transfer:0, linepay:0, jko:0, stored:0 };

        // ==========================================
        // A. 服務結算 (只看當天 activeDateStr 且已結帳)
        // ==========================================
        const dayEntries = safeArray(financeStore.data[activeDateStr]);
        dayEntries.forEach(entry => {
            if (entry.status === 'checked' && entry.checkoutDetails) {
                const d = entry.checkoutDetails;
                // 服務結算 = 總金額 - 已付定金
                const amount = parseInt(d.finalTotal) - parseInt(d.paidDeposit || 0);
                
                if (amount > 0) {
                    serviceTotal += amount;
                    
                    // 統計各方式金額
                    const method = d.paymentMethod || 'cash';
                    if (serviceByType[method] !== undefined) {
                        serviceByType[method] += amount;
                    }

                    serviceDetails.push({
                        type: d.paymentMethod, 
                        amount: amount,
                        date: activeDateStr, 
                        time: entry.time
                    });
                }
            }
        });

        // ==========================================
        // B. 定金結算 (掃描全資料庫，找出定金支付日是今天的)
        // ==========================================
        Object.keys(financeStore.data).forEach(dateKey => {
            const entries = safeArray(financeStore.data[dateKey]);
            entries.forEach(entry => {
                // 條件：有定金 且 定金日期 = 今天
                if ((entry.hasDeposit || (entry.depositMethod && entry.depositMethod !== 'none')) && entry.depositDate === activeDateStr) {
                    const depAmt = parseInt(entry.depositAmount || 100);
                    depositTotal += depAmt;

                    // 統計定金各方式金額 (★新增部分)
                    const method = entry.depositMethod || 'transfer';
                    if (depositByType[method] !== undefined) {
                        depositByType[method] += depAmt;
                    }

                    depositDetails.push({
                        type: method,
                        amount: depAmt,
                        date: dateKey, // 這是預約日期
                        time: entry.time
                    });
                }
            });
        });

        // ==========================================
        // C. 渲染 UI
        // ==========================================
        
        // 1. 更新標題上的總數字
        document.getElementById('settle-deposit-total').innerText = depositTotal;
        document.getElementById('settle-service-total').innerText = serviceTotal;

        // 2. 共用的清單渲染函式 (列出每一筆)
        const renderList = (list) => {
            if (list.length === 0) return '<div class="text-xs text-gray-400 p-2 text-center">無資料</div>';
            return list.map(i => `
                <div class="settle-detail-row">
                    <span>${i.date} ${i.time} (${typeMap[i.type]||i.type})</span>
                    <span class="font-bold">$${i.amount}</span>
                </div>`).join('');
        };

        // 3. 共用的統計區塊生成函式 (產生灰色方塊)
        const generateSummaryHtml = (typeObj, total) => {
            if (total <= 0) return '';
            
            let html = `<div class="bg-gray-100 p-3 rounded-lg mb-3 text-xs border border-gray-200">`;
            
            // 迴圈顯示各支付方式 (只顯示大於 0 的)
            for (let [key, val] of Object.entries(typeObj)) {
                if (val > 0) {
                    html += `
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-500">${typeMap[key]}</span>
                            <span class="font-bold text-[#1a3a2e]">$${val}</span>
                        </div>`;
                }
            }
            
            // 分隔線與總加總
            html += `
                <div class="border-t border-gray-300 mt-2 pt-2 flex justify-between items-center">
                    <span class="font-bold text-[#1a3a2e]">全部加總</span>
                    <span class="font-bold text-sm text-[var(--gold-main)]" style="color:#b59865">$${total}</span>
                </div>
            </div>`;
            return html;
        };

        // 4. 渲染定金詳情 (統計區塊 + 詳細列表)
        const depositSummaryHtml = generateSummaryHtml(depositByType, depositTotal);
        document.getElementById('settle-detail-deposit').innerHTML = depositSummaryHtml + renderList(depositDetails);

        // 5. 渲染服務詳情 (統計區塊 + 詳細列表)
        const serviceSummaryHtml = generateSummaryHtml(serviceByType, serviceTotal);
        document.getElementById('settle-detail-service').innerHTML = serviceSummaryHtml + renderList(serviceDetails);
    }

    window.toggleSettleDetail = function(type) {
        document.getElementById(`settle-detail-${type}`).classList.toggle('hidden');
    };

    // --- 零用金計算機邏輯 (修正版) ---
    const DENOMINATIONS = [1000, 500, 100, 50, 10, 5, 1];
    
    // 1. 開啟零用金視窗 (接收 isReadOnly 參數)
    window.openCashier = function(isReadOnly = false) {
        document.getElementById('cashierModal').classList.remove('hidden');
        // 將狀態存入 modal 的 dataset 以便渲染時判斷
        document.getElementById('cashierModal').dataset.readonly = isReadOnly;
        renderCashierInputs();
    };

    // [修正版 V7] 渲染零用金輸入框 (修復日期排序與應有金額邏輯)
    window.renderCashierInputs = function() {
        const isReadOnly = document.getElementById('cashierModal').dataset.readonly === 'true';
        const container = document.getElementById('cashierModal');
        
        // CSS 鎖定狀態
        if (isReadOnly) container.classList.add('readonly-mode');
        else container.classList.remove('readonly-mode');

        // --- 步驟 1: 準備資料 ---
        let savedDetails = { current: {}, reserve: {} };
        let savedAllocations = [];
        let savedTotal = 0;

        const currentRecord = settlementData[activeDateStr];
        if (currentRecord) {
            savedDetails.current = currentRecord.cashDetails || {};
            savedDetails.reserve = currentRecord.reserveDetails || {};
            savedAllocations = currentRecord.allocations || [];
            savedTotal = currentRecord.cashTotal || 0;
        }

        // --- 步驟 2: 生成面額格子 ---
        const renderGrid = (type) => {
            const gridContainer = document.getElementById(`cash-grid-${type}`);
            const sourceMap = savedDetails[type] || {};

            gridContainer.innerHTML = DENOMINATIONS.map(d => {
                const val = sourceMap[d] !== undefined ? sourceMap[d] : '';
                return `
                <div class="cash-grid">
                    <div class="cash-label">${d}</div>
                    <input type="number" class="cash-input" 
                           data-type="${type}" 
                           data-denom="${d}" 
                           value="${val}" 
                           placeholder="0"
                           oninput="calcCashTotal('${type}')">
                </div>`;
            }).join('');
        };

        renderGrid('current');
        renderGrid('reserve');

        // --- 步驟 3: 處理分配金額 ---
        ['backup', 'yongfeng', 'ctbc', 'wallet'].forEach(id => {
            const el = document.getElementById(`alloc-${id}`);
            if(el) el.value = ''; 
        });

        if (savedAllocations.length > 0) {
            savedAllocations.forEach(a => {
                let targetId = a.targetId;
                if (!targetId) { 
                    if (a.target === '備用金') targetId = 'backup';
                    else if (a.target === '永豐') targetId = 'yongfeng';
                    else if (a.target === '中信') targetId = 'ctbc';
                    else if (a.target === '錢包') targetId = 'wallet';
                }
                const input = document.getElementById(`alloc-${targetId}`);
                if (input) input.value = a.amount;
            });
        }

        // --- 步驟 4: 計算應有金額 (邏輯修正：使用 Date 物件進行日期排序) ---
        
        // 4-1. 找出 "今天以前" 的 "最後一筆" 結算紀錄
        const allDates = Object.keys(settlementData);
        
        // [關鍵修正] 將 activeDateStr (例如 "2026-02-09") 轉為 Date 物件的 timestamp 進行比較
        // 這樣可以避免字串比對 "2026-02-2" > "2026-02-10" 的錯誤
        const targetTs = new Date(activeDateStr).setHours(0,0,0,0);

        const prevDates = allDates.filter(d => {
            const dTs = new Date(d).setHours(0,0,0,0);
            return dTs < targetTs; // 嚴格小於今天
        }).sort((a, b) => {
            return new Date(a) - new Date(b); // 依照時間先後排序
        });

        let prevReserve = 2000; // 預設值 (若完全無過往紀錄)

        if (prevDates.length > 0) {
            // 取陣列最後一個 (離今天最近的一筆)
            const lastDate = prevDates[prevDates.length - 1];
            const lastRecord = settlementData[lastDate];
            // 抓取該日結算時的 "pettyCash" (輸入在零用金欄位的總額)
            prevReserve = parseInt(lastRecord.pettyCash) || 0;
        }

        // 4-2. 抓今日現金營收 (服務尾款 + 現金定金)
        let todayCashRev = 0;
        const dayEntries = safeArray(financeStore.data[activeDateStr]);
        
        // A. 計算今日「服務尾款」的現金收入
        dayEntries.forEach(e => {
            if (e.status === 'checked' && 
                e.checkoutDetails && 
                e.checkoutDetails.paymentMethod === 'cash') {
                
                const finalTotal = parseInt(e.checkoutDetails.finalTotal) || 0;
                const paidDeposit = parseInt(e.checkoutDetails.paidDeposit) || 0;
                todayCashRev += (finalTotal - paidDeposit);
            }
        });
        
        // B. 計算今日收到的「現金定金」
        // [關鍵修正] 使用拆解數字比對，避免 "09" 與 "9" 不相等的問題
        const [targetY, targetM, targetD] = activeDateStr.split('-').map(Number);

        Object.keys(financeStore.data).forEach(k => {
            safeArray(financeStore.data[k]).forEach(e => {
                // 檢查是否有定金資料
                if ((e.hasDeposit || (e.depositMethod && e.depositMethod !== 'none')) && e.depositDate) {
                    const [depY, depM, depD] = e.depositDate.split('-').map(Number);
                    
                    // 比對日期是否相同 且 方式為現金
                    if (depY === targetY && depM === targetM && depD === targetD && e.depositMethod === 'cash') {
                        todayCashRev += parseInt(e.depositAmount || 100);
                    }
                }
            });
        });

        // 應有總額 = 上次保留 + 今日現金營收
        const expectedTotal = prevReserve + todayCashRev;

        // --- 步驟 5: 渲染頂部摘要區域 ---
        const headerContainer = document.getElementById('current-cash-summary-container');
        
        if (headerContainer) {
            headerContainer.innerHTML = `
                <div class="text-[11px] mb-1 p-2 rounded bg-gray-100 border border-gray-200 flex justify-between items-center">
                    <span><span class="opacity-60">應有總額:</span> <b class="text-[#1a3a2e]">$${expectedTotal}</b></span>
                    <span id="cash-diff-msg" class="font-bold text-[#ff6b6b]">差額: -$${expectedTotal}</span>
                </div>
                <div class="text-right font-bold text-lg text-[#1a3a2e]">
                    實數總計: $<span id="cash-total-current" data-expected="${expectedTotal}">0</span>
                </div>
            `;
        }

        // --- 步驟 6: 更新底部按鈕 ---
        const footerContainer = document.getElementById('cashier-footer');
        if (footerContainer) {
            if (isReadOnly) {
                footerContainer.innerHTML = `<button onclick="toggleCashierEdit()" class="w-full py-3 bg-gray-500 text-white rounded-xl font-bold shadow-lg text-lg">編輯內容 (解鎖)</button>`;
            } else {
                footerContainer.innerHTML = `<button onclick="saveSettlement()" class="w-full py-3 bg-[#1a4731] text-white rounded-xl font-bold shadow-lg text-lg">結算完畢</button>`;
            }
        }

        // 立即觸發計算
        calcCashTotal('current');
        calcCashTotal('reserve');
    };

    // (原有的計算邏輯保留)
    window.calcCashTotal = function(type) {
        let total = 0;
        document.querySelectorAll(`.cash-input[data-type="${type}"]`).forEach(input => {
            total += (parseInt(input.value) || 0) * parseInt(input.dataset.denom);
        });
        const display = document.getElementById(`cash-total-${type}`);
        display.innerText = total;

        if (type === 'current') {
            const expected = parseInt(display.dataset.expected) || 0;
            const diff = total - expected;
            const msgEl = document.getElementById('cash-diff-msg');
            if (msgEl) {
                msgEl.innerText = `差額: ${diff >= 0 ? '+' : ''}${diff}`;
                msgEl.style.color = diff === 0 ? '#1a4731' : '#ff6b6b';
            }
        }
        updateSurplus();
    };

    // [修正版] 更新盈餘與已分配金額 (完全同步輸入框)
    window.updateSurplus = function() {
        // 1. 讀取 "當前現金" 與 "保留零用金" 的總計 (由 calcCashTotal 更新)
        const current = parseInt(document.getElementById('cash-total-current').innerText) || 0;
        const reserve = parseInt(document.getElementById('cash-total-reserve').innerText) || 0;
        
        // 2. 本日盈餘 = 當前現金 - 保留零用金
        const surplus = current - reserve;
        document.getElementById('cash-surplus').innerText = surplus;

        // 3. 計算 "已入庫金額" (讀取 4 個分配欄位的輸入值)
        // 使用 .value 確保讀取的是使用者看到的當下數值
        let allocated = 0;
        ['backup', 'yongfeng', 'ctbc', 'wallet'].forEach(id => {
            const el = document.getElementById(`alloc-${id}`);
            if (el) {
                const val = parseInt(el.value); // 嘗試解析整數
                if (!isNaN(val)) {
                    allocated += val; // 如果是數字就加總
                }
            }
        });

        document.getElementById('cash-stored').innerText = allocated;
        
        // 4. 更新待分配金額 (盈餘 - 已分配)
        document.getElementById('cash-remaining').innerText = surplus - allocated;
    };

    window.allocateSurplus = function(target) {
        const surplus = parseInt(document.getElementById('cash-surplus').innerText) || 0;
        ['backup', 'yongfeng', 'ctbc', 'wallet'].forEach(id => {
            const input = document.getElementById(`alloc-${id}`);
            if(input) { input.value = ''; input.dispatchEvent(new Event('input')); }
        });
        const targetInput = document.getElementById(`alloc-${target}`);
        if (targetInput) {
            targetInput.value = surplus;
            targetInput.dispatchEvent(new Event('input'));
        }
        updateSurplus();
    };

    // [修正版] 儲存結算 (包含儲存面額細節)
    window.saveSettlement = function() {
        // 防呆：唯讀模式下不執行
        if (document.getElementById('cashierModal').dataset.readonly === 'true') {
            document.getElementById('cashierModal').classList.add('hidden');
            return;
        }

        if (!confirm("確定結算完畢？\n\n・內容將變為「唯讀」\n・如需修改請點選「編輯」按鈕")) return;

        // ★★★ 1. 蒐集當前輸入框的面額細節 ★★★
        let cashDetails = {};
        document.querySelectorAll('.cash-input[data-type="current"]').forEach(input => {
            const val = parseInt(input.value);
            if(val > 0) cashDetails[input.dataset.denom] = val;
        });

        let reserveDetails = {};
        document.querySelectorAll('.cash-input[data-type="reserve"]').forEach(input => {
            const val = parseInt(input.value);
            if(val > 0) reserveDetails[input.dataset.denom] = val;
        });

        // 2. 構建資料
        const data = {
            date: activeDateStr,
            status: 'settled',
            cashTotal: parseInt(document.getElementById('cash-total-current').innerText) || 0,
            pettyCash: parseInt(document.getElementById('cash-total-reserve').innerText) || 0,
            surplus: parseInt(document.getElementById('cash-surplus').innerText) || 0,
            
            // 儲存細節 (關鍵！)
            cashDetails: cashDetails,
            reserveDetails: reserveDetails,

            allocations: ['backup', 'yongfeng', 'ctbc', 'wallet'].map(id => ({
                targetId: id, // 存 ID 最安全
                target: id === 'backup'?'備用金':(id==='yongfeng'?'永豐':(id==='ctbc'?'中信':'錢包')),
                amount: parseInt(document.getElementById(`alloc-${id}`).value) || 0
            })).filter(a => a.amount > 0),
            
            timestamp: new Date().toISOString()
        };

        // 3. 寫入 Firebase
        if (window.dbSet && window.dbRef) {
            window.dbSet(window.dbRef(window.firebaseDB, `meawMeSettlements/${activeDateStr}`), data)
                .then(() => alert("✅ 結算成功！"));
        }

        // 4. ★★★ 立即更新本地資料 (不等網路回傳，馬上變更 UI) ★★★
        settlementData[activeDateStr] = data;

        // 5. 關閉視窗並刷新
        document.getElementById('cashierModal').classList.add('hidden');
        document.getElementById('settlementModal').classList.add('hidden');
        document.body.classList.remove('editing-mode');

        checkSettlementStatus(); // 讓按鈕立刻變色
    };

    window.toggleSettlementEdit = function() {
        if (!confirm("⚠️ 確定要解除鎖定嗎？\n\n這將允許您修改結算金額與內容。")) return;

        // 1. 更新本地狀態為 'editing' (非 settled)
        if (!settlementData[activeDateStr]) settlementData[activeDateStr] = {};
        settlementData[activeDateStr].status = 'editing';

        // 2. 更新 Firebase (讓雲端也同步解鎖)
        if (window.dbSet && window.dbRef) {
            window.dbSet(window.dbRef(window.firebaseDB, `meawMeSettlements/${activeDateStr}/status`), 'editing');
        }

        // 3. 刷新 UI -> 變回可編輯狀態，隱藏解鎖按鈕
        checkSettlementStatus();
    };

    // [補回] 儲存財務資料
    function saveFinanceV2() {
        if (window.dbSet && window.dbRef) {
            window.dbSet(window.dbRef(window.firebaseDB, 'meawMeFinanceV2'), {
                data: financeStore.data,
                manualOffDays: financeStore.manualOffDays,
                offDayNotes: financeStore.offDayNotes || {}
            }).then(() => {
                // console.log("儲存成功");
            }).catch(e => {
                console.error("儲存失敗", e);
                alert("儲存失敗，請檢查網路");
            });
        }
        renderFinancePage();
        if(!document.getElementById('dayDetailModal').classList.contains('hidden')) {
            renderDayDetailList();
        }
    }

    // [修正版] 渲染財務頁面 (補上睫模顯示邏輯)
    function renderFinancePage() {
        const y = financeStore.viewDate.getFullYear();
        const m = financeStore.viewDate.getMonth();
        document.getElementById('fin-month-display').textContent = `${y} / ${String(m+1).padStart(2,'0')}`;
        
        const grid = document.getElementById('finance-calendar-grid');
        if(!grid) return;
        grid.innerHTML = '';

        const firstDay = new Date(y, m, 1).getDay();
        const offset = (firstDay === 0 ? 6 : firstDay - 1);
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const holidayMap = window.getTaiwanHolidays(); 
        const todayObj = new Date();
        const todayStr = `${todayObj.getFullYear()}-${String(todayObj.getMonth()+1).padStart(2,'0')}-${String(todayObj.getDate()).padStart(2,'0')}`;

        let totalRev = 0, realRev = 0, count = 0, offDays = 0, realOff = 0;
        let currentWeekTotal = 0, currentWeekReal = 0;

        for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayOfWeek = new Date(y, m, d).getDay();
            const isSun = dayOfWeek === 0;
            const isSat = dayOfWeek === 6;
            const holidayName = holidayMap[dateStr];
            const isManualOff = financeStore.manualOffDays.includes(dateStr);
            const notes = safeArray(financeStore.offDayNotes ? financeStore.offDayNotes[dateStr] : []);
            const entries = safeArray(financeStore.data[dateStr]);
            const isToday = (dateStr === todayStr);

            if (isSun || isSat || holidayName || isManualOff) offDays++; 
            if ((isSun || holidayName || isManualOff) && entries.length === 0) realOff++; 

            const box = document.createElement('div');
            const isRedDay = isSun || isSat || holidayName || isManualOff;
            
            let labelText = "";
            if (notes.length > 0) labelText = notes[0] + (notes.length > 1 ? "+" : ""); 
            else if (isManualOff) labelText = "公休"; 
            else if (holidayName) labelText = holidayName;
            else if (isSun) labelText = "休";

            const isCentered = isRedDay && entries.length === 0 && notes.length === 0 && labelText !== "";
            
            box.className = `fin-day-box ${isRedDay ? 'is-holiday-bg' : ''} ${isCentered ? 'centered-state' : ''}`;
            
            if (isToday) {
                box.style.cssText = `border: 2px solid var(--gold-main) !important; box-shadow: inset 0 0 10px rgba(201, 184, 150, 0.3) !important; overflow: hidden;`;
            } else {
                box.style.overflow = "hidden";
            }
            
            box.onclick = () => openDayView(dateStr);

            let contentHtml = "";
            let dateColor = isRedDay ? 'text-[#ff6b6b]' : 'font-bold';
            let labelColor = isRedDay ? 'text-[#ff6b6b] font-bold' : 'opacity-30';

            // 計算當日最早與最晚時間
            let minTimeStr = null;
            let maxTimeStr = null;

            if (entries.length > 0) {
                entries.sort((a, b) => a.time.localeCompare(b.time));
                minTimeStr = entries[0].time;
                const lastEntry = entries[entries.length - 1];
                const [lastH, lastM] = lastEntry.time.split(':').map(Number);
                let lastDur = parseInt(lastEntry.duration, 10);
                if (isNaN(lastDur) || lastDur === 0) lastDur = 60;
                let endMins = (lastH * 60) + lastM + lastDur;
                let endH = Math.floor(endMins / 60);
                let endM = endMins % 60;
                if (endH >= 24) endH = endH - 24;
                maxTimeStr = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
            }

            if (isCentered) {
                contentHtml = `<div class="date-corner ${dateColor}">${d}</div><div class="center-text ${labelColor}">${labelText}</div>`;
            } else {
                contentHtml = `
                    <div class="fin-day-header">
                        <span class="${dateColor} font-bold">${d}</span>
                        <span class="${labelColor}">${labelText}</span>
                    </div>
                    <div class="flex-1 flex flex-col">
                `;
                
                notes.forEach(note => {
                    contentHtml += `<div class="fin-item is-note"><span>${note}</span></div>`;
                });

                // [修正] 在這裡補上 eyelash.practice 到集合中
                const modelItemNames = new Set([
                    ...safeArray(serviceData.nail?.model).map(i => i.name), 
                    ...safeArray(serviceData.eyelash?.model).map(i => i.name),
                    ...safeArray(serviceData.eyelash?.practice).map(i => i.name)
                ]);

                entries.sort((a,b) => a.time.localeCompare(b.time)).forEach(e => {
                    count++;
                    let p = parsePrice(e.price);
                    let r = (p - (e.hasDeposit?100:0));
                    totalRev += p; realRev += r;
                    currentWeekTotal += p; currentWeekReal += r;
                    
                    let displayItemName = (e.items[0] || '項目').trim();
                    const baseTxt = financeStore.viewMode === 'price' ? `$${e.price}` : displayItemName;
                    let fullItemsString = safeArray(e.items).join('').replace(/\s+/g, '');
                    const hasRemoval = fullItemsString.includes("卸") || fullItemsString.includes("續");
                    const hasExtension = fullItemsString.includes("甲片") || fullItemsString.includes("延甲");

                    let suffix = "";
                    if (financeStore.viewMode !== 'price') {
                        if (hasRemoval && hasExtension) suffix = "☯"; 
                        else if (hasRemoval) suffix = "♡"; 
                        else if (hasExtension) suffix = "✩"; 
                    } 
                    
                    let itemClass = '';
                    // [修改] 判斷狀態，加入 checked 樣式 (透白底)
                    if (e.status === 'checked') {
                        itemClass = 'status-checked';
                    }

                    if (financeStore.viewMode === 'price') {
                        itemClass += ' is-price-view';
                    } else {
                        if (e.items.some(name => modelItemNames.has(name))) itemClass += ' is-model';
                    }

                    contentHtml += `
                    <div class="fin-item ${itemClass}">
                        <span class="flex-1 overflow-hidden whitespace-nowrap">${baseTxt}</span>
                        ${suffix ? `<span class="flex-shrink-0 ml-1 font-bold">${suffix}</span>` : ''}
                    </div>`;
                });

                if (minTimeStr && maxTimeStr) {
                    contentHtml += `
                        <div class="fin-day-footer">
                            <span class="start-time">${minTimeStr}</span>
                            <span class="end-time">${maxTimeStr}</span>
                        </div>`;
                }

                contentHtml += `</div>`; 
            }
            
            box.innerHTML = contentHtml;
            grid.appendChild(box);

            if (isSun || d === daysInMonth) {
                 const row = document.createElement('div');
                 row.className = 'weekly-row';
                 const rowTitle = (d === daysInMonth && !isSun) ? "📅 月底結算" : "📅 本週結算";
                 row.innerHTML = `<span>${rowTitle}</span> <span>總: $${currentWeekTotal.toLocaleString()} / 實: $${currentWeekReal.toLocaleString()}</span>`;
                 grid.appendChild(row);
                 currentWeekTotal = 0; currentWeekReal = 0;
            }
        }
        
        document.getElementById('stat-target-off').innerText = offDays;
        document.getElementById('stat-real-off').innerText = realOff;
        document.getElementById('stat-count').innerText = count;
        document.getElementById('stat-avg').innerText = count>0 ? Math.round(totalRev/count) : 0;
        document.getElementById('stat-month-total').innerText = `$${totalRev.toLocaleString()}`;
        document.getElementById('stat-month-real').innerText = `$${realRev.toLocaleString()}`;
    }

    // [修正版] 開啟當日行程 (強制鎖定狀態)
    function openDayView(dateStr) {
        activeDateStr = dateStr;
        document.getElementById('dayDetailModal').classList.remove('hidden');
        document.getElementById('dd-title').innerText = `${dateStr} 行程`;
        
        renderDayDetailList();
        updateDayOffButton();
        
        // ★★★ 核心修正：打開瞬間，強制檢查該日期的結算狀態 ★★★
        const btn = document.getElementById('btn-daily-settle');
        const record = settlementData[dateStr]; // 從全域資料抓取
        const isSettled = record && record.status === 'settled';

        if (btn) {
            if (isSettled) {
                // 狀態 A：已結算 -> 綠色實心按鈕 + 文字變更
                btn.innerText = "📋結算詳情";
                btn.className = "settle-btn settle-btn-main";
                // 確保移除舊的事件，重新綁定 (雖不影響 onclick，但視覺上要確保)
            } else {
                // 狀態 B：未結算 -> 空心按鈕 + 原始文字
                btn.innerText = "💰當日結算";
                btn.className = "settle-btn settle-btn-outline"; 
            }
        }
    }

    function closeDayDetail() { document.getElementById('dayDetailModal').classList.add('hidden'); }

    // [修正版] 渲染當日行程列表 (修復點擊錯誤 + 新增淺綠色狀態)
    function renderDayDetailList() {
        const container = document.getElementById('dd-list');
        container.innerHTML = '';
        
        // 1. 休假備註區塊
        const isOff = financeStore.manualOffDays.includes(activeDateStr);
        if (isOff) {
            const notes = safeArray(financeStore.offDayNotes ? financeStore.offDayNotes[activeDateStr] : []);
            const noteHeader = document.createElement('div');
            noteHeader.className = "text-xs font-bold mt-2 border-b pb-1 mb-2";
            noteHeader.style.color = "#ff6b6b"; 
            noteHeader.style.borderColor = "rgba(255, 107, 107, 0.3)";
            noteHeader.innerText = "休假原因";
            container.appendChild(noteHeader);

            notes.forEach((note, idx) => {
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center p-2 rounded mb-2 border';
                row.style.borderColor = '#ff6b6b';
                row.style.backgroundColor = 'rgba(255, 107, 107, 0.08)'; 
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span style="color:#ff6b6b; font-size:12px;">●</span>
                        <span style="color:#ff6b6b; font-weight:bold; font-size:14px;">${note}</span>
                    </div>
                    <button style="color:#ff6b6b;" class="font-bold text-lg px-2 hover:opacity-70" onclick="deleteOffNote(${idx})">✕</button>
                `;
                container.appendChild(row);
            });

            const addRow = document.createElement('div');
            addRow.className = "flex gap-2 mb-4";
            addRow.innerHTML = `
                <input type="text" id="new-note-input" placeholder="輸入原因 (如: 進修)" class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm text-gray-700">
                <button onclick="addOffNote()" class="bg-[#ff6b6b] text-white px-3 py-1 rounded text-xs font-bold shadow">新增</button>
            `;
            container.appendChild(addRow);
        }

        // 2. 預約行程區塊
        const entries = safeArray(financeStore.data[activeDateStr]);
        
        if(entries.length > 0) {
            const entryHeader = document.createElement('div');
            entryHeader.className = "text-xs text-gray-500 mb-2 font-bold mt-2 border-b border-gray-200 pb-1";
            entryHeader.innerText = "預約行程";
            container.appendChild(entryHeader);

            // 排序
            entries.sort((a,b) => a.time.localeCompare(b.time));

            // [關鍵] 使用 forEach 確保 e 變數正確綁定
            entries.forEach(e => {
                const [sH, sM] = e.time.split(':').map(Number);
                const dur = parseInt(e.duration || 60, 10);
                const endMins = sH * 60 + sM + dur;
                let eH = Math.floor(endMins / 60);
                const eM = endMins % 60;
                if(eH >= 24) eH -= 24;
                const endTimeStr = `${String(eH).padStart(2,'0')}:${String(eM).padStart(2,'0')}`;

                const div = document.createElement('div');
                
                // 預設樣式
                let itemClass = 'day-detail-item flex justify-between items-center bg-gray-50 border border-gray-200 p-3 rounded-lg mb-2 cursor-pointer hover:bg-gray-100 transition-all';
                
                // [新增] 如果已結帳，加入 status-checked class (變淺綠色)
                if (e.status === 'checked') {
                    itemClass += ' status-checked';
                }

                div.className = itemClass;

                // [關鍵] 這裡的 onclick 直接使用閉包內的 e，確保資料正確
                div.onclick = (event) => {
                    if(event.target.classList.contains('del-btn')) return;
                    openBookingDetail(e); 
                };

                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-baseline gap-2">
                            <span class="text-[#c9b896] font-extrabold text-lg font-serif">${e.time} - ${endTimeStr}</span>
                            <span class="text-gray-400 text-xs font-bold tracking-wider">$${e.price}</span>
                        </div>
                        <div class="text-[15px] text-[#4b3621] font-bold mt-1 tracking-wide" 
                             style="text-shadow: 0 2px 4px rgba(75, 54, 33, 0.15), 0 1px 1px rgba(255,255,255,0.8);">
                            ${safeArray(e.items).join(' + ')}
                        </div>
                    </div>
                    <div class="flex items-center gap-3 pl-3 border-l border-gray-600">
                        <button class="del-btn text-red-400 font-bold text-lg px-2 py-1 hover:text-red-300 transition-colors" onclick="deleteSingleEntry('${e.id}')">✕</button>
                    </div>
                `;
                container.appendChild(div);
            });
        } else if (!isOff) {
            container.innerHTML += `<div class="text-center opacity-40 py-6 text-sm text-gray-500">本日尚無行程</div>`;
        }
    }

    // [新增] 新增備註
    window.addOffNote = function() {
        const input = document.getElementById('new-note-input');
        if(!input || !input.value.trim()) return;
        
        if (!financeStore.offDayNotes) financeStore.offDayNotes = {};
        if (!financeStore.offDayNotes[activeDateStr]) financeStore.offDayNotes[activeDateStr] = [];
        
        // 轉為陣列處理 (舊資料如果是字串，先轉陣列)
        let current = financeStore.offDayNotes[activeDateStr];
        if (typeof current === 'string') current = [current];
        
        current.push(input.value.trim());
        financeStore.offDayNotes[activeDateStr] = current;
        
        saveFinanceV2(); // 儲存並刷新
    };

    // [新增] 刪除備註
    window.deleteOffNote = function(idx) {
        if (!financeStore.offDayNotes || !financeStore.offDayNotes[activeDateStr]) return;
        
        let current = financeStore.offDayNotes[activeDateStr];
        if (typeof current === 'string') current = [current]; // 相容舊格式
        
        current.splice(idx, 1);
        
        if (current.length === 0) {
            delete financeStore.offDayNotes[activeDateStr];
        } else {
            financeStore.offDayNotes[activeDateStr] = current;
        }
        saveFinanceV2();
    };

        // [修改] 更新排休按鈕狀態與文字
    function updateDayOffButton() {
        const holidayMap = window.getTaiwanHolidays();
        const isHoliday = !!holidayMap[activeDateStr];
        const isSun = new Date(activeDateStr).getDay() === 0;
        
        // 判斷行事曆是否有時段
        const [y, mm, dd] = activeDateStr.split('-');
        const bookingKey = `${parseInt(y)}-${parseInt(mm)-1}-${parseInt(dd)}`;
        const hasSlots = (bookingState.data.bookings[bookingKey] || []).length > 0;
        const inManualList = financeStore.manualOffDays.includes(activeDateStr);

        // 判斷目前是否視為休假
        const isCurrentlyOff = inManualList || ((isHoliday || isSun) && !hasSlots);

        const btn = document.getElementById('btn-day-off');
        if (!btn) return;

        if (isCurrentlyOff) {
            // 目前是休假 -> 按鈕功能為「改為上班」
            // 如果是國定假日，顯示「取消休假」比較直覺
            const label = (isHoliday || isSun) ? "🟢 上班 (取消休假)" : "🟢 上班 (取消排休)";
            btn.innerHTML = label;
            btn.classList.add('bg-[#1a4731]', 'text-[#ff6b6b]'); // 綠色按鈕
            btn.classList.remove('bg-[#ff6b6b]', 'border-red-400', 'text-[#ff6b6b]', 'text-red-400', 'border');
            btn.style.border = '1px solid #1a4731';
        } else {
            // 目前是上班 -> 按鈕功能為「改為休假」
            btn.innerHTML = "🔴 排休";
            btn.classList.remove('bg-[#1a4731]', 'text-white');
            btn.classList.add('border', 'border-red-400', 'text-[#ff6b6b]');
            btn.style.background = 'transparent';
        }
    }

    // [修正] 單筆刪除功能 (新增：自動釋出時段)
    window.deleteSingleEntry = function(id) {
        // 阻止事件冒泡
        if(event) event.stopPropagation();

        if(!confirm("確定刪除此筆預約？\n(對應的時段將會嘗試自動釋出)")) return;
        
        // 1. 找出要刪除的那筆資料，為了拿到它的時間
        let currentEntries = safeArray(financeStore.data[activeDateStr]);
        const targetEntry = currentEntries.find(e => String(e.id) === String(id));
        
        // 2. 刪除財務資料
        financeStore.data[activeDateStr] = currentEntries.filter(e => String(e.id) !== String(id));
        saveFinanceV2(); 
        renderDayDetailList();
        renderFinancePage();

        // 3. [新增] 自動釋出時段邏輯
        if (targetEntry && targetEntry.time) {
            // 修正 Booking Key 格式
            const [yStr, mmStr, ddStr] = activeDateStr.split('-');
            const bookingKey = `${parseInt(yStr)}-${parseInt(mmStr)-1}-${parseInt(ddStr)}`;
            
            // 如果該天還沒有時段陣列，初始化它
            if (!bookingState.data.bookings[bookingKey]) {
                bookingState.data.bookings[bookingKey] = [];
            }

            const timeToRelease = targetEntry.time;
            const currentSlots = bookingState.data.bookings[bookingKey];

            // 如果該時段不在清單中，把它加回去
            if (!currentSlots.includes(timeToRelease)) {
                // 這裡可以選擇是否要依照 DEFAULTS_TIMES 過濾，或是直接加回去
                // 建議：直接加回去，讓變更反映出來
                currentSlots.push(timeToRelease);
                currentSlots.sort(); // 排序保持美觀
                saveBookingData(); // 同步行事曆
                console.log(`時段 ${timeToRelease} 已自動釋出`);
            }
        }
    };

    // [修改] 排休/上班切換邏輯
    window.toggleDayOff = function() {
        const holidayMap = window.getTaiwanHolidays();
        const isHoliday = !!holidayMap[activeDateStr];
        const dayOfWeek = new Date(activeDateStr).getDay();
        const isSun = dayOfWeek === 0;

        const [y, mm, dd] = activeDateStr.split('-');
        const bookingKey = `${parseInt(y)}-${parseInt(mm)-1}-${parseInt(dd)}`;

        const inManualList = financeStore.manualOffDays.includes(activeDateStr);
        const currentSlots = bookingState.data.bookings[bookingKey] || [];
        const hasSlots = currentSlots.length > 0;

        // 核心邏輯：如果 (手動排休) 或 (是假日且沒開時段)，就是休假狀態
        const isCurrentlyOff = inManualList || ((isHoliday || isSun) && !hasSlots);

        if (isCurrentlyOff) {
            // 切換為上班：移除排休、開啟時段
            if (inManualList) {
                const idx = financeStore.manualOffDays.indexOf(activeDateStr);
                financeStore.manualOffDays.splice(idx, 1);
            }
            const finEntries = safeArray(financeStore.data[activeDateStr]);
            const safeDefaults = DEFAULTS_TIMES.filter(defaultTime => {
                const [dH, dM] = defaultTime.split(':').map(Number);
                const dMins = dH * 60 + dM;
                const isOccupied = finEntries.some(e => {
                     const [eH, eM] = e.time.split(':').map(Number);
                     const eStart = eH * 60 + eM;
                     const eDur = parseInt(e.duration || 60, 10);
                     return (dMins >= eStart && dMins < (eStart + eDur));
                });
                return !isOccupied;
            });
            bookingState.data.bookings[bookingKey] = safeDefaults;
        } else {
            // 切換為休假：加入排休、清空時段
            if (!inManualList) financeStore.manualOffDays.push(activeDateStr);
            bookingState.data.bookings[bookingKey] = [];
        }

        saveFinanceV2();
        saveBookingData();
        updateDayOffButton();
        renderFinancePage();
    };

    // [新增] 編輯休假原因
    window.editOffReason = function() {
        if (!financeStore.offDayNotes) financeStore.offDayNotes = {};
        const currentNote = financeStore.offDayNotes[activeDateStr] || "";
        const newNote = prompt("請輸入休假原因 (將顯示於行事曆)：", currentNote);
        
        if (newNote !== null) {
            if (newNote.trim() === "") {
                delete financeStore.offDayNotes[activeDateStr];
            } else {
                financeStore.offDayNotes[activeDateStr] = newNote;
            }
            saveFinanceV2();
        }
    };

    // [修正版] 開啟預約詳情視窗 (同步顯示備註與圖片)
    window.openBookingDetail = function(entry) {
        currentCheckoutEntry = entry; 
        const modal = document.getElementById('bookingDetailModal');
        modal.classList.remove('hidden');

        // 1. 關閉按鈕樣式
        const closeBtn = modal.querySelector('button.absolute');
        if(closeBtn) {
            closeBtn.className = "absolute top-4 right-4 text-[var(--gold-main)] text-2xl font-bold opacity-100 hover:text-white transition-colors";
        }

        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const [y, m, d] = activeDateStr.split('-').map(Number);
        const dateObj = new Date(y, m-1, d);
        
        // 日期與時間
        document.getElementById('bd-date').innerText = activeDateStr;
        const elDay = document.getElementById('bd-day');
        elDay.innerText = dayNames[dateObj.getDay()];
        elDay.className = "text-gold-force text-sm mt-1 font-bold tracking-widest"; 
        
        const [sH, sM] = entry.time.split(':').map(Number);
        const dur = parseInt(entry.duration || 60);
        const endMins = sH * 60 + sM + dur;
        let eH = Math.floor(endMins / 60);
        const eM = endMins % 60;
        if(eH >= 24) eH -= 24;
        
        const elTime = document.getElementById('bd-time');
        elTime.innerText = `${entry.time} - ${String(eH).padStart(2,'0')}:${String(eM).padStart(2,'0')}`;
        elTime.className = "text-gold-force text-2xl font-bold mt-2 font-serif";

        // 狀態標籤與按鈕
        const statusContainer = document.getElementById('bd-status-container');
        statusContainer.innerHTML = ''; 

        const statusMap = { 'pending': '尚未到來', 'checked': '已報到', 'noshow': '爽約' };
        const statusClass = { 'pending': 'status-pending', 'checked': 'status-checked', 'noshow': 'status-noshow' };
        const st = entry.status || 'pending';
        
        const badge = document.createElement('span');
        badge.className = `status-badge ${statusClass[st]}`;
        badge.innerText = statusMap[st];
        statusContainer.appendChild(badge);

        if (st === 'pending') {
            const noShowBtn = document.createElement('button');
            noShowBtn.className = "btn-noshow";
            noShowBtn.innerText = "標記爽約";
            noShowBtn.onclick = () => markAsNoShow(entry.id);
            statusContainer.appendChild(noShowBtn);
        }

        // 定金顯示
        const depMap = { 'transfer': '匯款', 'linepay': 'Line Pay', 'none': '無', 'cash': '現金', 'stored': '儲值金' };
        const methodKey = entry.depositMethod || (entry.hasDeposit ? 'transfer' : 'none');
        const depTxt = depMap[methodKey] || methodKey;
        const depAmount = entry.depositAmount || 100;
        const hasDep = (methodKey !== 'none');

        document.getElementById('bd-deposit').innerText = `${depTxt} ${hasDep ? '$' + depAmount : ''}`;

        // 項目顯示
        document.getElementById('bd-items').innerHTML = safeArray(entry.items).map(i => `<div>${i}</div>`).join('');
        
        // --- [新增] 備註顯示 ---
        const noteArea = document.getElementById('bd-note-area');
        if(entry.note && entry.note.trim() !== "") { 
            document.getElementById('bd-note').innerText = entry.note; 
            noteArea.classList.remove('hidden'); 
        } else { 
            noteArea.classList.add('hidden'); 
        }

        // --- [新增] 圖片顯示 ---
        const imgArea = document.getElementById('bd-img-area');
        const imgGrid = document.getElementById('bd-img-grid');
        
        // 相容舊資料(單張字串)與新資料(多張陣列)
        let images = [];
        if (entry.images && Array.isArray(entry.images)) {
            images = entry.images;
        } else if (entry.image) {
            images = [entry.image];
        }

        if (images.length > 0) {
            imgGrid.innerHTML = images.map(src => `
                <div class="aspect-square relative cursor-pointer group" onclick="viewLargeImage('${src}')">
                    <img src="${src}" class="w-full h-full object-cover rounded-lg border border-gray-200 shadow-sm hover:opacity-90 transition-opacity">
                    <div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 rounded-lg transition-opacity">
                        <span class="text-white text-xs font-bold">🔍</span>
                    </div>
                </div>
            `).join('');
            imgArea.classList.remove('hidden');
        } else {
            imgArea.classList.add('hidden');
        }

        // 按鈕綁定
        document.getElementById('btn-bd-edit').onclick = () => { modal.classList.add('hidden'); openEditForm(entry.id); };
        document.getElementById('btn-bd-checkout').onclick = () => { modal.classList.add('hidden'); initCheckout(entry); };
    };

    // [NEW] 標記爽約功能
    window.markAsNoShow = function(id) {
        if(!confirm("確定標記此預約為「爽約」嗎？")) return;
        
        let currentEntries = safeArray(financeStore.data[activeDateStr]);
        const idx = currentEntries.findIndex(e => String(e.id) === String(id));
        
        if (idx > -1) {
            currentEntries[idx].status = 'noshow';
            financeStore.data[activeDateStr] = currentEntries;
            saveFinanceV2();
            
            // ★這裡修改：不要關閉視窗，而是重新載入該筆資料的詳情
            openBookingDetail(currentEntries[idx]); 
            
            renderDayDetailList();
            renderFinancePage();
        }
    };

    // [NEW] 結帳系統核心
    let checkoutState = { entry: null, items: [], globalDiscount: { type: 'none', val: 0 }, deposit: 0, payMethod: 'cash', finalTotal: 0 };
    let activeDiscTarget = null; 
    let settlementData = {}; // 存放結算單資料

    // [修正版] 結帳初始化 (修復舊資料結帳錯誤)
    window.initCheckout = function(entry) {
        let items = [];
        // [核心修正] 增加防呆解析
        if (entry.itemsDetail && Array.isArray(entry.itemsDetail) && entry.itemsDetail.length > 0) {
            items = JSON.parse(JSON.stringify(entry.itemsDetail));
        } else {
            items = safeArray(entry.items).map(rawName => {
                // 嘗試分離名稱與數量
                let name = rawName;
                let qty = 1;
                const match = rawName.match(/^(.*?)\s*x(\d+)$/);
                if (match) {
                    name = match[1];
                    qty = parseInt(match[2]);
                }

                const info = findItemData(name);
                return { 
                    name: name, 
                    price: info.price, 
                    duration: info.duration, 
                    qty: qty, 
                    isPercent: name.includes('%') 
                };
            });
        }
        
        items.forEach(i => { if(!i.discount) i.discount = { type: 'none', val: 0 }; });
        const deposit = ((entry.depositMethod && entry.depositMethod !== 'none') || entry.hasDeposit) ? (parseInt(entry.depositAmount) || 100) : 0;

        checkoutState = { entry: entry, items: items, globalDiscount: { type: 'none', val: 0 }, deposit: deposit, payMethod: 'cash', finalTotal: 0 };
        renderCheckoutList();
        updateCheckoutSummary();
        document.getElementById('checkoutModal').classList.remove('hidden');
    };
    window.closeCheckout = function() { document.getElementById('checkoutModal').classList.add('hidden'); };

    window.renderCheckoutList = function() {
        const container = document.getElementById('checkout-list');
        container.innerHTML = checkoutState.items.map((item, idx) => {
            let finalPrice = item.price * (item.qty || 1);
            let discountTxt = "";
            if (item.discount.type === 'cash') { finalPrice -= item.discount.val; discountTxt = `- $${item.discount.val}`; } 
            else if (item.discount.type === 'percent') { finalPrice = Math.round(finalPrice * (item.discount.val / 100)); discountTxt = `${item.discount.val}折`; }
            
            return `<div class="checkout-item" onclick="openDiscountModal(${idx})">
                    <div><div class="font-bold text-sm text-[#1a3a2e]">${item.name} ${item.qty>1?'x'+item.qty:''}</div><div class="text-xs text-gray-400">原價 $${item.price}</div></div>
                    <div class="checkout-price-group"><div class="checkout-final-price">$${finalPrice}</div>${discountTxt ? `<span class="checkout-discount-tag">${discountTxt}</span>` : ''}</div>
                </div>`;
        }).join('');
    };

    window.openDiscountModal = function(target) {
        activeDiscTarget = target;
        document.getElementById('disc-input').value = "";
        switchDiscType('cash');
        document.getElementById('disc-title').innerText = target === 'global' ? "整筆訂單折扣" : `折扣：${checkoutState.items[target].name}`;
        document.getElementById('discountModal').classList.remove('hidden');
    };

    window.switchDiscType = function(type) {
        const input = document.getElementById('disc-input');
        input.dataset.type = type; 
        input.placeholder = type === 'cash' ? "輸入金額" : "輸入折數 (如 90)";
        document.getElementById('tab-disc-cash').className = type === 'cash' ? "flex-1 py-1.5 text-xs font-bold rounded bg-white shadow-sm" : "flex-1 py-1.5 text-xs font-bold text-gray-400";
        document.getElementById('tab-disc-percent').className = type === 'percent' ? "flex-1 py-1.5 text-xs font-bold rounded bg-white shadow-sm" : "flex-1 py-1.5 text-xs font-bold text-gray-400";
        document.getElementById('disc-grid-cash').classList.toggle('hidden', type !== 'cash');
        document.getElementById('disc-grid-percent').classList.toggle('hidden', type !== 'percent');
    };

    window.setDiscVal = function(val) { document.getElementById('disc-input').value = val; };

    window.applyDiscount = function() {
        const val = parseInt(document.getElementById('disc-input').value) || 0;
        const type = document.getElementById('disc-input').dataset.type;
        if (activeDiscTarget === 'global') {
            checkoutState.globalDiscount = { type, val };
            let txt = type === 'cash' ? `- $${val}` : `${val}折`;
            if (val === 0) txt = "- $0";
            document.getElementById('global-disc-display').innerText = txt;
        } else {
            checkoutState.items[activeDiscTarget].discount = { type, val };
            renderCheckoutList();
        }
        updateCheckoutSummary();
        document.getElementById('discountModal').classList.add('hidden');
    };

    window.updateCheckoutSummary = function() {
        let subtotal = 0, currentTotal = 0;
        checkoutState.items.forEach(item => {
            const itemTotal = item.price * (item.qty || 1);
            subtotal += itemTotal;
            let afterItemDisc = itemTotal;
            if (item.discount.type === 'cash') afterItemDisc -= item.discount.val;
            else if (item.discount.type === 'percent') afterItemDisc = Math.round(afterItemDisc * (item.discount.val / 100));
            currentTotal += afterItemDisc;
        });
        if (checkoutState.globalDiscount.type === 'cash') currentTotal -= checkoutState.globalDiscount.val;
        else if (checkoutState.globalDiscount.type === 'percent') currentTotal = Math.round(currentTotal * (checkoutState.globalDiscount.val / 100));
        
        if (currentTotal < 0) currentTotal = 0;
        checkoutState.finalTotal = currentTotal;
        document.getElementById('co-subtotal').innerText = subtotal;
        document.getElementById('co-discount-total').innerText = subtotal - currentTotal;
        document.getElementById('co-grand-total').innerText = currentTotal;
    };

    // [修正版] 開啟支付視窗
    window.openPaymentModal = function() {
        // 1. 顯示總金額
        document.getElementById('pay-total-amount').innerText = checkoutState.finalTotal;
        
        // 2. 取得當前結帳的預約資料
        const entry = checkoutState.entry; 

        // 3. 判斷定金方式 (用於顯示文字)
        const depMap = { 'transfer': '匯款', 'linepay': 'Line Pay', 'none': '無', 'cash': '現金', 'stored': '儲值金' };
        const methodKey = entry.depositMethod || (entry.hasDeposit ? 'transfer' : 'none');
        const depTxt = depMap[methodKey] || methodKey;
        
        // 更新 UI 文字：已付定金 (方式)
        document.getElementById('pay-dep-method').innerText = depTxt;

        // 4. [修正重點] 將定金數值填入 Input (使用 checkoutState 中的數據)
        // 這裡會自動帶入在 initCheckout 中已經計算好的金額 (即您手動輸入的金額)
        document.getElementById('pay-dep-input').value = checkoutState.deposit;

        // 5. 預設選取現金，並觸發一次計算
        selectPayMethod('cash', document.querySelector('.pay-method-row')); 
        
        // 6. 顯示視窗
        document.getElementById('paymentModal').classList.remove('hidden');
    };

    // [修改] 選擇支付方式
    window.selectPayMethod = function(method, row) {
        checkoutState.payMethod = method;
        
        // 處理 UI 選中狀態
        document.querySelectorAll('.pay-method-row').forEach(r => r.classList.remove('selected'));
        if (row) row.classList.add('selected');
        
        // 呼叫剛剛寫好的計算函式 (這樣邏輯就統一了)
        updatePayRemaining();
    };

    window.confirmCheckout = function() {
        if (!confirm(`確認結帳？\n總金額: $${checkoutState.finalTotal}`)) return;
        const currentEntries = safeArray(financeStore.data[activeDateStr]);
        const idx = currentEntries.findIndex(e => String(e.id) === String(checkoutState.entry.id));
        if (idx > -1) {
            const entry = currentEntries[idx];
            entry.status = 'checked';
            entry.checkoutDetails = { items: checkoutState.items, globalDiscount: checkoutState.globalDiscount, finalTotal: checkoutState.finalTotal, paymentMethod: checkoutState.payMethod, paidDeposit: checkoutState.deposit };
            entry.price = checkoutState.finalTotal;
            financeStore.data[activeDateStr] = currentEntries;
            saveFinanceV2();
        }
        document.getElementById('paymentModal').classList.add('hidden');
        document.getElementById('checkoutModal').classList.add('hidden');
        document.getElementById('bookingDetailModal').classList.add('hidden');
        renderFinancePage();
        renderDayDetailList();
        alert("結帳完成！");
    };

    // [修正] 全域查找項目資料 (補上 practice 睫模欄位)
    function findItemData(itemName) {
        const allCats = ['nail', 'eyelash', 'skin'];
        for (const cat of allCats) {
            if (!serviceData[cat]) continue;
            
            const lists = [
                safeArray(serviceData[cat].main), 
                safeArray(serviceData[cat].addon), 
                safeArray(serviceData[cat].model),
                safeArray(serviceData[cat].practice) // [新增] 確保搜尋睫模
            ];

            for (const list of lists) {
                // 1. 完全比對
                let found = list.find(i => i.name === itemName);
                
                // 2. 前綴比對 (處理括號變體)
                if (!found) {
                    const candidates = list.filter(i => itemName.startsWith(i.name));
                    if (candidates.length > 0) {
                        found = candidates.reduce((a, b) => a.name.length > b.name.length ? a : b);
                    }
                }

                if (found) {
                    const isPrice2 = ["濃密", "體驗", "方案 B"].some(k => itemName.includes(k));
                    const price = (isPrice2 && found.price2) ? parsePrice(found.price2) : parsePrice(found.price);
                    // 回傳物件包含時長
                    return { price: price, duration: found.duration || 60 }; 
                }
            }
        }
        return { price: 0, duration: 60 };
    }

    // [修改] 開啟編輯視窗 (包含定金邏輯)
    function openEditForm(entryId = null) {
        const modal = document.getElementById('finEditModal');
        if(modal) modal.classList.remove('hidden');
        
        editingEntryId = entryId;
        tempItems = [];
        currentCat = 'nail';
        document.getElementById('fe-note').value = ""; 
        clearImage();
        
        const elTitle = document.getElementById('fe-title');
        if(elTitle) {
            const dayNames = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
            const [y, m, d] = activeDateStr.split('-').map(Number);
            const dateObj = new Date(y, m - 1, d);
            const dayName = dayNames[dateObj.getDay()];
            elTitle.innerText = entryId ? `編輯預約 (${activeDateStr} ${dayName})` : `新增預約 (${activeDateStr} ${dayName})`; 
        }

        const currentEntries = safeArray(financeStore.data[activeDateStr]);
        const busyHours = new Set();
        currentEntries.forEach(e => {
            if (editingEntryId && String(e.id) === String(editingEntryId)) return;
            const h = parseInt(e.time.split(':')[0], 10);
            busyHours.add(h);
        });
        const hSel = document.getElementById('fe-h');
        if(hSel) {
            hSel.innerHTML = '';
            for(let i=10; i<=22; i++) {
                const val = String(i).padStart(2,'0');
                const isBusy = busyHours.has(i);
                hSel.innerHTML += `<option value="${val}" style="${isBusy?'color:#ccc':''}">${isBusy?i+' (忙)':i}</option>`;
            }
            hSel.onchange = checkConflictUI;
        }
        const mSel = document.getElementById('fe-m');
        if(mSel) mSel.onchange = checkConflictUI;
        const durInput = document.getElementById('fe-duration');
        if(durInput) durInput.oninput = checkConflictUI;

        let defH = "10", defM = "00";
        document.getElementById('fe-price').value = ""; 
        document.getElementById('fe-duration').value = "";
        setDepositMethod('none'); // 預設無定金

        if (entryId) {
            const entry = currentEntries.find(e => String(e.id) === String(entryId));
            if (entry) {
                const parts = (entry.time || "10:00").split(':');
                if(parts.length === 2) { defH = parts[0]; defM = parts[1]; }
                
                // 載入定金方式
                let depMethod = 'none';
                if (entry.depositMethod) depMethod = entry.depositMethod;
                else if (entry.hasDeposit) depMethod = 'transfer';
                setDepositMethod(depMethod);

                // 1. 先算出「今天」的日期 (格式 YYYY-MM-DD)
                const nowObj = new Date();
                const todayStr = `${nowObj.getFullYear()}-${String(nowObj.getMonth()+1).padStart(2,'0')}-${String(nowObj.getDate()).padStart(2,'0')}`;

                // 2. 設定日期欄位
                const dateInput = document.getElementById('fe-dep-date');

                if (entryId) {
                    const entry = currentEntries.find(e => String(e.id) === String(entryId));
                    if (entry) {
                        // 編輯模式：如果有舊紀錄就用舊的，沒有就預設「今天」
                        dateInput.value = entry.depositDate || todayStr; 
                    }
                } else {
                    // 新增模式：定金日期直接預設為「今天」
                    dateInput.value = todayStr;
                }

                document.getElementById('fe-note').value = entry.note || "";
                currentImagesList = (entry.images && Array.isArray(entry.images)) ? [...entry.images] : (entry.image ? [entry.image] : []);
                renderPreviewImages();

                if (entry.itemsDetail) {
                    tempItems = JSON.parse(JSON.stringify(entry.itemsDetail));
                } else {
                    tempItems = safeArray(entry.items).map(n => {
                        const data = findItemData(n); 
                        return { name: n, price: data.price, duration: data.duration, isPercent: n.includes('%'), qty: 1 };
                    });
                }
            }
        }
        
        if(hSel) hSel.value = String(defH).padStart(2,'0');
        if(mSel) mSel.value = defM;

        const allTabs = document.querySelectorAll('.cat-tab-btn');
        if(allTabs.length > 0) allTabs[0].click(); 
        
        renderSelectedList();
        recalcTotal();
        checkConflictUI();
    }

    // [修正] 設定定金方式 UI (支援 現金/匯款/LP/儲值/無)
    window.setDepositMethod = function(method, btn) {
        document.getElementById('fe-dep-method').value = method;
        document.querySelectorAll('.dep-opt-btn').forEach(b => b.classList.remove('active'));
        
        if (btn) {
            // 如果是點擊觸發，直接亮起該按鈕
            btn.classList.add('active');
        } else {
            // 如果是載入資料觸發，自動尋找對應的按鈕亮起
            const btns = document.querySelectorAll('.dep-opt-btn');
            let found = false;
            btns.forEach(b => {
                // 檢查按鈕的 onclick 字串中是否包含該 method
                if (b.getAttribute('onclick').includes(`'${method}'`)) {
                    b.classList.add('active');
                    found = true;
                }
            });
            // 防呆：如果找不到對應按鈕 (例如舊資料格式)，預設選「無」
            if (!found) {
                // 假設最後一個按鈕是「無/不收取」
                btns[btns.length - 1].classList.add('active');
            }
        }
    };

    // [新增] 即時衝突檢查 UI 顯示
    function checkConflictUI() {
        const warnBox = document.getElementById('conflict-msg');
        if (!warnBox) return;

        const h = document.getElementById('fe-h').value;
        const m = document.getElementById('fe-m').value;
        const duration = parseInt(document.getElementById('fe-duration').value, 10) || 0;

        if (duration === 0) {
            warnBox.classList.add('hidden');
            return;
        }

        const startH = parseInt(h, 10);
        const startM = parseInt(m, 10);
        const newStartMins = startH * 60 + startM;
        const newEndMins = newStartMins + duration;

        const currentEntries = safeArray(financeStore.data[activeDateStr]);
        let isConflict = false;
        let conflictTime = "";

        currentEntries.forEach(e => {
            if (editingEntryId && String(e.id) === String(editingEntryId)) return; // 排除自己
            
            const [eH, eM] = e.time.split(':').map(Number);
            const eStart = eH * 60 + eM;
            const eDur = parseInt(e.duration || 60, 10);
            const eEnd = eStart + eDur;

            // 判斷重疊
            if (newStartMins < eEnd && newEndMins > eStart) {
                isConflict = true;
                conflictTime = e.time;
            }
        });

        if (isConflict) {
            warnBox.innerText = `⚠️ 注意：與 ${conflictTime} 的預約時段重疊！`;
            warnBox.classList.remove('hidden');
        } else {
            warnBox.classList.add('hidden');
        }
    }

    // [修復] 關閉視窗
    function closeFinEditModal() {
        const modal = document.getElementById('finEditModal');
        if(modal) modal.classList.add('hidden');
    }

    // [修改] 儲存帳務 (寫入 depositMethod 與 status，並在編輯後刷新詳情)
    function saveFinData() {
        if (!activeDateStr) return;
        if (!financeStore.data[activeDateStr]) financeStore.data[activeDateStr] = [];
        
        let currentEntries = safeArray(financeStore.data[activeDateStr]);
        const h = document.getElementById('fe-h').value;
        const m = document.getElementById('fe-m').value;
        const timeStr = `${h}:${m}`;
        const rawPrice = parseInt(document.getElementById('fe-price').value) || 0; 
        const duration = parseInt(document.getElementById('fe-duration').value, 10) || 0;
        
        // 衝突檢查
        const startH = parseInt(h, 10);
        const startM = parseInt(m, 10);
        const newStartMins = startH * 60 + startM;
        const newEndMins = newStartMins + duration;
        let isConflict = false;
        
        currentEntries.forEach(e => {
            if (editingEntryId && String(e.id) === String(editingEntryId)) return; // 排除自己
            const [eH, eM] = e.time.split(':').map(Number);
            const eStart = eH * 60 + eM;
            const eEnd = eStart + (parseInt(e.duration || 60, 10));
            if (newStartMins < eEnd && newEndMins > eStart) isConflict = true; 
        });

        if (isConflict) {
            if(!confirm(`⚠️ 檢測到與現有帳務時間重疊 (${timeStr})\n\n確定要繼續新增嗎？`)) return;
        }

        // 舊時段釋出 (包含自動同步到雲端)
        if (editingEntryId) {
             const oldEntry = currentEntries.find(e => String(e.id) === String(editingEntryId));
             if (oldEntry && oldEntry.time !== timeStr) {
                const [yStr, mmStr, ddStr] = activeDateStr.split('-');
                const bookingKey = `${parseInt(yStr)}-${parseInt(mmStr)-1}-${parseInt(ddStr)}`;
                if (!bookingState.data.bookings[bookingKey]) bookingState.data.bookings[bookingKey] = [];
                const slots = bookingState.data.bookings[bookingKey];
                if (!slots.includes(oldEntry.time)) {
                    slots.push(oldEntry.time);
                    slots.sort();
                    saveBookingData(); // 強制同步舊時段釋出
                }
             }
        }

        const depMethod = document.getElementById('fe-dep-method').value;
        const hasDeposit = (depMethod !== 'none');
        const manualDepAmount = parseInt(document.getElementById('fe-dep-amount').value) || 0;

        // [修改] 處理定金日期邏輯 - 優先讀取手動輸入的日期
        const manualDepDate = document.getElementById('fe-dep-date').value;
        let depositDate = null;
        if (hasDeposit) {
            depositDate = manualDepDate || activeDateStr;
        }

        // 建立新資料物件
        const newData = {
            id: editingEntryId || Date.now(),
            time: timeStr,
            items: tempItems.length > 0 ? tempItems.map(i => i.qty > 1 ? `${i.name} x${i.qty}` : i.name) : ['自訂項目'],
            itemsDetail: tempItems,
            price: rawPrice, 
            duration: duration,
            hasDeposit: hasDeposit,
            depositMethod: depMethod,
            depositAmount: hasDeposit ? manualDepAmount : 0,
            depositDate: depositDate,
            note: document.getElementById('fe-note').value,
            images: currentImagesList, 
            image: currentImagesList.length > 0 ? currentImagesList[0] : "",
            
            status: 'pending', 
            checkoutDetails: null 
        };

        // 更新陣列
        if (editingEntryId) {
            const idx = currentEntries.findIndex(e => String(e.id) === String(editingEntryId));
            if(idx > -1) currentEntries[idx] = newData;
        } else {
            currentEntries.push(newData);
        }
        
        // 儲存至全域變數與雲端
        financeStore.data[activeDateStr] = currentEntries;
        saveFinanceV2(); 

        // 同步行事曆時段 (若是手動排休/營業時間調整)
        const [yStr, mmStr, ddStr] = activeDateStr.split('-');
        const bookingKey = `${parseInt(yStr)}-${parseInt(mmStr)-1}-${parseInt(ddStr)}`;
        let currentBookingSlots = bookingState.data.bookings[bookingKey];
        
        if (currentBookingSlots && Array.isArray(currentBookingSlots)) {
            let hasChanged = false;
            const updatedSlots = currentBookingSlots.filter(slot => {
                const [sH, sM] = slot.split(':').map(Number);
                const slotStartMins = sH * 60 + sM;
                // 如果該時段與新預約時間重疊，則移除該空檔
                if (slotStartMins >= newStartMins && slotStartMins < newEndMins) {
                    hasChanged = true;
                    return false; 
                }
                return true;
            });
            if (hasChanged) {
                bookingState.data.bookings[bookingKey] = updatedSlots;
                saveBookingData();
            }
        }
        
        // 1. 刷新後台列表
        renderDayDetailList(); 
        
        // 2. 關閉編輯視窗
        closeFinEditModal();    

        // 3. [關鍵修正] 編輯後直接用 newData 刷新視窗，確保顯示剛剛輸入的內容
        if (editingEntryId) {
            setTimeout(() => {
                // 直接把剛建立好的 newData 丟進去顯示，不依賴陣列查找，速度最快且最準確
                openBookingDetail(newData);
            }, 50);
        }
    }

    // [修改] 1. 切換類別：支援手模與睫模獨立顯示
    window.switchFinCat = function(catKey, btn) {
        // 設定當前主要類別 (用於價格選擇器判斷款式名稱)
        if (catKey.includes('nail')) currentCat = 'nail';
        else if (catKey.includes('eyelash')) currentCat = 'eyelash';
        else currentCat = 'skin';

        // 更新按鈕樣式
        document.querySelectorAll('.cat-tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        const grid = document.getElementById('fe-item-grid');
        if(!grid) return;
        grid.innerHTML = '';

        // 建立按鈕的 helper
        const createBtn = (i) => {
            const p1Disp = String(i.price).includes('%') ? i.price : `$${i.price}`;
            const hasP2 = (i.price2 !== undefined && i.price2 !== "" && i.price2 != 0);
            const p2Str = hasP2 ? i.price2 : "";
            const dur = i.duration || 0;

            if (hasP2) {
                return `<button class="item-option-btn" onclick="openPriceSelector('${currentCat}', '${i.name}', '${i.price}', '${p2Str}', ${dur})">${i.name} <span class="opacity-60 text-[10px] ml-1">選</span></button>`;
            } else {
                return `<button class="item-option-btn" onclick="addItemToTemp('${i.name}', '${i.price}', ${dur})">${i.name} <span class="opacity-60 text-[10px]">(${p1Disp})</span></button>`;
            }
        };

        // [核心修改] 依據 catKey 渲染對應資料
        if (catKey === 'nail_model') {
            // 手模專區
            if (serviceData.nail && safeArray(serviceData.nail.model).length > 0) {
                grid.innerHTML += `<div class="fe-section-title">--- 手模專區 ---</div>` + safeArray(serviceData.nail.model).map(createBtn).join('');
            }
        } else if (catKey === 'eyelash_practice') {
            // 睫模專區
            if (serviceData.eyelash && safeArray(serviceData.eyelash.practice).length > 0) {
                 grid.innerHTML += `<div class="fe-section-title">--- 睫模專區 ---</div>` + safeArray(serviceData.eyelash.practice).map(createBtn).join('');
            }
        } else if (catKey === 'nail') {
            // 美甲 (主項目 + 加購)
            if (serviceData.nail) {
                if (safeArray(serviceData.nail.main).length > 0) {
                    grid.innerHTML += `<div class="fe-section-title">--- 美甲項目 ---</div>` + safeArray(serviceData.nail.main).map(createBtn).join('');
                }
                if (safeArray(serviceData.nail.addon).length > 0) {
                    grid.innerHTML += `<div class="fe-section-title">--- 加購項目 ---</div>` + safeArray(serviceData.nail.addon).map(createBtn).join('');
                }
            }
        } else if (catKey === 'eyelash') {
            // 美睫 (主項目 + 加購 + 睫毛管理)
            if (serviceData.eyelash) {
                if (safeArray(serviceData.eyelash.main).length > 0) {
                    grid.innerHTML += `<div class="fe-section-title">--- 美睫項目 ---</div>` + safeArray(serviceData.eyelash.main).map(createBtn).join('');
                }
                if (safeArray(serviceData.eyelash.model).length > 0) {
                    grid.innerHTML += `<div class="fe-section-title">--- 睫毛管理 ---</div>` + safeArray(serviceData.eyelash.model).map(createBtn).join('');
                }
                if (safeArray(serviceData.eyelash.addon).length > 0) {
                    grid.innerHTML += `<div class="fe-section-title">--- 加購項目 ---</div>` + safeArray(serviceData.eyelash.addon).map(createBtn).join('');
                }
            }
        } else if (catKey === 'skin') {
            // 美容
            if (serviceData.skin) {
                 if (safeArray(serviceData.skin.main).length > 0) {
                    grid.innerHTML += `<div class="fe-section-title">--- 美容項目 ---</div>` + safeArray(serviceData.skin.main).map(createBtn).join('');
                }
                if (safeArray(serviceData.skin.addon).length > 0) {
                    grid.innerHTML += `<div class="fe-section-title">--- 加購項目 ---</div>` + safeArray(serviceData.skin.addon).map(createBtn).join('');
                }
            }
        }

        if (grid.innerHTML === '') grid.innerHTML = `<div class="col-span-2 text-center text-gray-400 text-xs py-4">尚無項目</div>`;
    };

    // 2. [修改] 開啟價格選擇視窗 (客製化文字：自然/濃密, 原價/體驗)
    window.openPriceSelector = function(cat, name, p1, p2, dur) {
        const modal = document.getElementById('priceSelectorModal');
        const container = document.getElementById('price-options-container');
        if(!modal) return alert("錯誤：找不到選擇視窗 HTML，請確認第一步是否已執行");
        
        modal.classList.remove('hidden');

        const p1Label = String(p1).includes('%') ? p1 : `$${p1}`;
        const p2Label = String(p2).includes('%') ? p2 : `$${p2}`;

        // [關鍵] 依據類別顯示不同文字
        let label1 = "方案 A";
        let label2 = "方案 B";

        if (cat === 'eyelash') {
            label1 = "自然款";
            label2 = "濃密款";
        } else if (cat === 'skin') {
            label1 = "原價";
            label2 = "體驗價";
        }

        container.innerHTML = `
            <button class="p-select-btn" onclick="confirmPriceSelection('${name} (${label1})', '${p1}', ${dur})">
                <span>${label1}</span>
                <span>${p1Label}</span>
            </button>
            <button class="p-select-btn" onclick="confirmPriceSelection('${name} (${label2})', '${p2}', ${dur})">
                <span>${label2}</span>
                <span>${p2Label}</span>
            </button>
        `;
    };

    // 3. 確認選擇後加入
    window.confirmPriceSelection = function(name, price, dur) {
        document.getElementById('priceSelectorModal').classList.add('hidden');
        addItemToTemp(name, price, dur);
    };

    // 4. [修改] 加入項目 (偵測是否為百分比)
    window.addItemToTemp = function(name, priceStr, dur) {
        const pStr = String(priceStr);
        const isPercent = pStr.includes('%');
        const priceVal = parseInt(pStr.replace(/[^0-9]/g, '')) || 0;
        const durVal = parseInt(dur) || 0;

        tempItems.push({
            name: name, 
            price: priceVal, 
            duration: durVal,
            isPercent: isPercent,
            qty: 1 // [新增] 預設數量為 1
        });

        // 預設先加一次時長，稍後 recalcTotal 會再精準計算
        const currentDur = parseInt(document.getElementById('fe-duration').value) || 0;
        document.getElementById('fe-duration').value = currentDur + durVal;

        recalcTotal();
        renderSelectedList();
    };

    // [核心修改] 重新計算總金額與總時長 (修正編輯時時長歸零問題)
    window.recalcTotal = function() {
        let currentRunningTotal = 0;
        let currentTotalDuration = 0;

        tempItems.forEach(item => {
            const val = parseFloat(item.price) || 0;
            const dur = parseInt(item.duration) || 0;
            const qty = parseInt(item.qty) || 1; // 取得數量
            
            if (!item.isPercent) {
                // 一般金額：單價 * 數量
                currentRunningTotal += (val * qty);
            } else {
                // 百分比折扣：直接打折 (通常折扣不乘數量，而是作用在總額)
                currentRunningTotal = currentRunningTotal * (val / 100);
                currentRunningTotal = Math.round(currentRunningTotal);
            }

            // 總時長：單次時長 * 數量
            currentTotalDuration += (dur * qty);
        });

        const priceInput = document.getElementById('fe-price');
        const durInput = document.getElementById('fe-duration');
        
        if (priceInput) priceInput.value = currentRunningTotal;
        if (durInput) durInput.value = currentTotalDuration;
    };

    // [修改] 渲染已選清單 (新增時長輸入框)
    window.renderSelectedList = function() {
        const list = document.getElementById('fe-selected-list');
        const count = document.getElementById('fe-count');
        if(!list) return;

        list.innerHTML = tempItems.map((item, idx) => {
            const symbolClass = item.isPercent ? 'currency-symbol hidden-symbol' : 'currency-symbol';
            const suffix = item.isPercent ? '<span class="text-xs font-bold text-[var(--gold-main)] ml-1">%</span>' : '';
            const qty = item.qty || 1;
            
            return `
            <div class="selected-list-item">
                <span class="selected-name flex-1">${item.name}</span>
                
                <div class="flex items-center">
                    <span class="text-[9px] text-gray-400 mr-1">x</span>
                    <input type="number" inputmode="numeric" class="item-qty-input" value="${qty}" onfocus="this.select()" onchange="updateItemQty(${idx}, this.value)">

                    <input type="number" inputmode="numeric" class="item-duration-input" value="${item.duration}" onfocus="this.select()" onchange="updateListDuration(${idx}, this.value)">
                    <span class="text-[9px] text-gray-400 mr-2">分</span>

                    <span class="${symbolClass}">$</span>
                    <input type="number" inputmode="numeric" class="item-price-input" value="${item.price}" onfocus="this.select()" onchange="updateListPrice(${idx}, this.value)">
                    ${suffix}
                    
                    <span class="del-item-btn ml-2" onclick="removeItemFromTemp(${idx})">✕</span>
                </div>
            </div>`;
        }).join('');
        
        if(count) count.innerText = `${tempItems.length} 項`;
    };

    // [新增] 更新單一項目的價格 (並重新計算總額)
    window.updateListPrice = function(idx, newPriceStr) {
        const newPrice = parseInt(newPriceStr) || 0;
        
        // 更新陣列中的價格
        if (tempItems[idx]) {
            tempItems[idx].price = newPrice;
        }
        
        // 重新計算總金額
        recalcTotal();
    };

    // [新增] 更新單一項目的時長
    window.updateListDuration = function(idx, newDurStr) {
        const newDur = parseInt(newDurStr) || 0;
        if (tempItems[idx]) {
            tempItems[idx].duration = newDur;
        }
        recalcTotal(); // 更新總時長
    };

    // [修改] 刪除暫存項目
    window.removeItemFromTemp = function(idx) {
        if (!tempItems[idx]) return;
        tempItems.splice(idx, 1);
        recalcTotal(); // 刪除後重算總金額與總時長
        renderSelectedList();
    };

    function deleteCurrentFin() {
        if(confirm("確定刪除此筆資料？")) {
            let currentEntries = safeArray(financeStore.data[activeDateStr]);
            financeStore.data[activeDateStr] = currentEntries.filter(e => e.id !== editingEntryId);
            saveFinanceV2();
            closeFinEditForm();
        }
    }

    function changeFinMonth(dir) {
        financeStore.viewDate.setMonth(financeStore.viewDate.getMonth() + dir);
        renderFinancePage();
    }

    function toggleFinView() {
        financeStore.viewMode = (financeStore.viewMode === 'item' ? 'price' : 'item');
        const btn = document.getElementById('finViewToggle');
        if (btn) btn.innerText = financeStore.viewMode === 'price' ? "顯示: 項目" : "顯示: 金額";
        renderFinancePage();
    }

    // 修改後的換頁函式
    window.switchPage = function(id) {
        closeNumpad(); // ★ 切換分頁時，強制先關閉鍵盤
        location.hash = id; 
    };

    // [修改] 登出/儲存功能：移除延遲，強制立刻刷新
    window.logout = function() { 
        // 使用 location.replace 替換當前歷史紀錄，避免上一頁
        // 並強制重整
        window.location.href = location.pathname + '#home';
        window.location.reload();
    };

    function router() {
        const hash = location.hash.slice(1) || 'home';
        
        // 1. 控制 Header 文字顯示 (非首頁時隱藏)
        const headerTexts = document.querySelectorAll('.studio-name, .studio-name2, .studio-subtitle');
        const brandHeader = document.querySelector('.brand-header');
        
        if (hash === 'home') {
            headerTexts.forEach(el => el.style.display = ''); 
            if(brandHeader) brandHeader.classList.remove('header-compact');
        } else {
            headerTexts.forEach(el => el.style.display = 'none'); 
            if(brandHeader) brandHeader.classList.add('header-compact');
        }

        // 2. 定義後台頁面清單 (新增了 admin-pricelist)
        const adminPages = ['admin-pricelist', 'admin-calc', 'budget', 'admin-finance', 'admin-report'];
        const isAdmin = document.body.classList.contains('admin-mode');
        
        // 3. 權限檢查
        if (adminPages.includes(hash) && !isAdmin) {
            location.hash = 'home';
            showAdminLogin();
            return;
        }

        // 4. 切換頁面顯示
        document.querySelectorAll('.page-content').forEach(p => {
            p.classList.remove('active');
            p.style.display = 'none'; 
        });

        const targetPage = document.getElementById('page-' + hash);
        if (targetPage) {
            targetPage.classList.add('active');
            targetPage.style.display = 'block'; 
        }

        // 5. 更新底部導航按鈕狀態
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
            const onclickAttr = btn.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes(`'${hash}'`)) {
                btn.classList.add('active');
            }
        });

        // 6. 特殊頁面初始化
        window.scrollTo(0,0);
        if (hash === 'booking') {
            renderCalendar();
            // 顯示預約須知
            const isAdmin = document.body.classList.contains('admin-mode');
            if (!isAdmin && !hasSeenBookingNotice) {
                setTimeout(() => {
                    const noticeModal = document.getElementById('booking-notice-modal');
                    if(noticeModal) noticeModal.classList.remove('hidden');
                }, 50); 
            }
        }
        if(hash === 'budget') renderCalendar(); 
        if(hash === 'admin-finance') renderFinancePage();
        /* --- 找到 router 函數內部的對應位置並替換 --- */
        if (hash === 'admin-report') {
            // 延遲 50ms 確保 DOM 已載入，並根據當前標籤刷新內容
            setTimeout(() => {
                // 修正：統一判斷 logic
                if (reportState.tab === 'calendar' || reportState.tab === 'day') { 
                    renderReportCalendar(); 
                } else if (reportState.tab === 'month') { 
                    renderMonthlyReport(); 
                } else if (reportState.tab === 'year') { 
                    renderYearlyReport(); 
                }
            }, 50);
        }
        if(hash === 'admin-pricelist') renderAdminList(); // 進入價目表時渲染列表
    }

    // [重要] 啟動監聽：只要網址變了，就執行 router
    window.addEventListener('hashchange', router);
    
    // 2026 台灣國定假日表 (日期: 名稱)
    window.getTaiwanHolidays = function() {
        return {
            "2026-01-01": "元旦", "2026-01-02": "元旦",
            "2026-02-16": "補假", "2026-02-17": "除夕", "2026-02-18": "春節", "2026-02-19": "春節", "2026-02-20": "春節",
            "2026-02-27": "228", "2026-02-28": "228",
            "2026-04-03": "兒童", "2026-04-04": "清明", "2026-04-05": "清明", "2026-04-06": "補假",
            "2026-05-01": "勞動",
            "2026-06-19": "端午", "2026-06-20": "端午", "2026-06-21": "端午",
            "2026-09-25": "中秋", "2026-09-26": "中秋", "2026-09-27": "中秋",
            "2026-10-09": "國慶", "2026-10-10": "國慶", "2026-10-11": "國慶",
            "2026-12-25": "聖誕", "2026-12-31": "跨年"
        };
    };

    // [修正] 舊資料校正工具 (增強版：自動修復假日狀態)
    window.fixLegacyData = function() {
        if(!confirm("⚠️ 系統校正 (進階版)：\n\n1. 自動補齊舊帳務的「時長」\n2. 重置行事曆狀態：\n   - 休假/國定假日：若無真實預約，強制清空時段 (讓狀態變回休假)\n   - 上班日：自動開啟預設時段\n\n確定執行嗎？")) return;

        let updatedDays = 0;
        const allDates = Object.keys(financeStore.data);
        const holidayMap = window.getTaiwanHolidays(); // 取得假日表

        // 為了確保所有日期都被掃描到（包含沒有帳務但有開時段的假日），我們掃描 bookingState 裡的開放月份
        // 這裡簡化：針對目前 financeStore 有資料的日期 + 手動掃描當前檢視月份
        const y = bookingState.viewDate.getFullYear();
        const m = bookingState.viewDate.getMonth();
        const lastDate = new Date(y, m + 1, 0).getDate();
        
        // 建立當月所有日期的清單
        let targetDates = [...allDates];
        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            if(!targetDates.includes(dateStr)) targetDates.push(dateStr);
        }

        targetDates.forEach(dateStr => {
            const entries = financeStore.data[dateStr];
            const hasRealBooking = (entries && entries.length > 0);
            let dataModified = false;

            // 1. 修正財務資料：補上 duration (這部分維持原樣)
            if (hasRealBooking) {
                entries.forEach(entry => {
                    if (!entry.duration || parseInt(entry.duration) === 0) {
                        let newDur = 0;
                        safeArray(entry.items).forEach(itemName => {
                            const info = findItemData(itemName); 
                            newDur += info.duration;
                        });
                        entry.duration = newDur || 60; 
                        dataModified = true;
                    }
                });
            }

            // 2. 同步行事曆 (假日邏輯修正)
            const [yStr, mStr, dStr] = dateStr.split('-');
            const bookingKey = `${parseInt(yStr)}-${parseInt(mStr)-1}-${parseInt(dStr)}`;
            
            const isManualOff = financeStore.manualOffDays.includes(dateStr);
            const isHoliday = !!holidayMap[dateStr];
            const isSun = new Date(dateStr).getDay() === 0;

            let calculatedSlots = [];

            // ★ 關鍵修正：如果是 (手動休假) 或 (國定假日) 或 (週日)
            // 且「沒有真實帳務預約」，則強制清空時段
            if ((isManualOff || isHoliday || isSun) && !hasRealBooking) {
                calculatedSlots = []; 
            } else {
                // 上班日 (或假日但有接客)：開啟 (預設時段 - 衝突時段)
                const finEntries = entries || [];
                
                // 取得原本已有的時段，如果是假日有接客，保留原狀或補滿，這裡選擇補滿邏輯
                calculatedSlots = DEFAULTS_TIMES.filter(defaultTime => {
                    const [dH, dM] = defaultTime.split(':').map(Number);
                    const dMins = dH * 60 + dM;

                    // 檢查是否被佔用
                    const isOccupied = finEntries.some(e => {
                         const [eH, eM] = e.time.split(':').map(Number);
                         const eStart = eH * 60 + eM;
                         const eDur = parseInt(e.duration || 60, 10);
                         return (dMins >= eStart && dMins < (eStart + eDur));
                    });
                    return !isOccupied; // 沒被佔用就開啟
                });
                
                // 特例：如果該日原本就有時段(且不是空的)，且目前計算出來是空的(代表全滿?)
                // 這裡保持簡單：覆蓋為計算後的結果
            }

            // 3. 比對與更新
            const currentSlots = bookingState.data.bookings[bookingKey] || [];
            const calcStr = JSON.stringify(calculatedSlots.sort());
            const currStr = JSON.stringify(currentSlots.sort());

            if (calcStr !== currStr || dataModified) {
                bookingState.data.bookings[bookingKey] = calculatedSlots;
                dataModified = true;
            }

            if (dataModified) updatedDays++;
        });

        if (updatedDays > 0) {
            saveFinanceV2();
            saveBookingData();
            alert(`✅ 校正完成！\n已修復 ${updatedDays} 天的資料狀態。\n(國定假日時段已關閉、舊帳務已補齊)`);
            renderFinancePage(); // 刷新畫面
        } else {
            alert("🎉 資料已是最新狀態，無需更新。");
        }
    };

    window.initSystem = function() {
        renderServiceFront(); 
        renderAdminList();     
        initCalc();           
        
        syncServiceData();    
        syncBookingData();    
        syncFinanceV2(); // <--- 關鍵！這行必須存在，預約才會出來
        syncSettlements();

        syncExpenses();
        
        router();
    };

    window.onload = function() {
        const checkFirebase = setInterval(() => {
            if (window.firebaseDB && window.dbRef) {
                clearInterval(checkFirebase);
                if (typeof window.initSystem === 'function') window.initSystem();
                
                // ★ 啟動自動關閉鍵盤的監聽器
                if (typeof window.initAutoCloseNumpad === 'function') window.initAutoCloseNumpad();
            }
        }, 100);
        
        setTimeout(() => {
            if (checkFirebase) clearInterval(checkFirebase);
            if (typeof window.initSystem === 'function') window.initSystem();
            
            // ★ 防止 Firebase 延遲，這裡也補跑一次
            if (typeof window.initAutoCloseNumpad === 'function') window.initAutoCloseNumpad();
        }, 3000);
    };

    // ============================================================
    // [新增功能區] 請貼在 Script 的後段
    // ============================================================

    // 1. 後台價目表內部分頁切換
    window.switchAdminPriceTab = function(tabName, btn) {
        const contents = [
            'admin-cat-content-nail', 
            'admin-cat-content-nail-model', 
            'admin-cat-content-eyelash', 
            'admin-cat-content-eyelash-practice', 
            'admin-cat-content-skin'
        ];
        
        contents.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });

        const target = document.getElementById('admin-cat-content-' + tabName);
        if(target) target.classList.remove('hidden');

        document.querySelectorAll('.admin-sub-tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    };

    // 2. 更新預約項目的數量
    window.updateItemQty = function(idx, newQty) {
        const qty = parseInt(newQty);
        if (qty > 0 && tempItems[idx]) {
            tempItems[idx].qty = qty;
            recalcTotal(); // 數量變動後，重新計算總金額
        }
    };

    // ==========================================
    // [新功能] 多圖上傳邏輯
    // ==========================================
    
    let currentImagesList = []; // 改用陣列儲存多張圖片

    // 1. 處理圖片上傳
    window.handleImageUpload = function(input) {
        const files = input.files;
        if (!files || files.length === 0) return;

        // 限制一次最多上傳幾張 (例如 5 張)
        if (currentImagesList.length + files.length > 5) {
            alert("最多只能上傳 5 張照片");
            input.value = "";
            return;
        }

        Array.from(files).forEach(file => {
            // 限制大小 (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert(`檔案 ${file.name} 過大，請小於 2MB`);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // 將 Base64 字串加入陣列
                currentImagesList.push(e.target.result);
                renderPreviewImages(); // 讀取完一張就渲染一次
            };
            reader.readAsDataURL(file);
        });

        // 清空 input 讓同個檔案可以再次被選取 (如果使用者刪除後後悔)
        input.value = "";
    };

    // 2. 渲染預覽圖 (含刪除按鈕)
    window.renderPreviewImages = function() {
        const container = document.getElementById('fe-preview-container');
        if (!container) return;
        container.innerHTML = "";

        currentImagesList.forEach((imgSrc, index) => {
            const div = document.createElement('div');
            div.className = "relative group aspect-square"; // 正方形容器
            div.innerHTML = `
                <img src="${imgSrc}" class="w-full h-full object-cover rounded-lg border border-gray-200 shadow-sm" onclick="viewLargeImage('${imgSrc}')">
                <button onclick="removeImage(${index})" class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-md hover:bg-red-600 transition-all">✕</button>
            `;
            container.appendChild(div);
        });
    };

    // 3. 刪除單張圖片
    window.removeImage = function(index) {
        currentImagesList.splice(index, 1);
        renderPreviewImages();
    };

    // (選用) 點擊圖片放大檢視 (全螢幕 Modal + 左上關閉 / 右上下載)
    window.viewLargeImage = function(src) {
        // 1. 檢查是否已經建立了 overlay
        let overlay = document.getElementById('img-preview-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'img-preview-overlay';
            // 這裡 HTML 結構也順便交換順序，方便閱讀 (Close在前，DL在後)
            overlay.innerHTML = `
                <div class="pv-btn pv-close" onclick="closeLargeImage()">✕</div>
                <div class="pv-btn pv-dl" onclick="downloadPreviewImage()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </div>
                <img id="preview-img-target" src="">
            `;
            document.body.appendChild(overlay);
        }

        // 2. 設定圖片與狀態
        const img = document.getElementById('preview-img-target');
        img.src = src;
        overlay.dataset.currentSrc = src; // 暫存給下載用

        // 3. 顯示動畫
        requestAnimationFrame(() => overlay.classList.add('active'));
    };

    // 關閉預覽
    window.closeLargeImage = function() {
        const overlay = document.getElementById('img-preview-overlay');
        if(overlay) overlay.classList.remove('active');
    };

    // 下載圖片 (觸發瀏覽器下載行為)
    window.downloadPreviewImage = function() {
        const overlay = document.getElementById('img-preview-overlay');
        const src = overlay.dataset.currentSrc;
        if(!src) return;

        const a = document.createElement('a');
        a.href = src;
        // 產生檔名：meawme_日期時間.png
        const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0,14);
        a.download = `meawme_${timestamp}.png`;
        
        // 必須將 anchor 加入 body 才能在某些手機瀏覽器觸發點擊
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    };

    // 4. 清除圖片 (修正版：適配多圖上傳)
    window.clearImage = function() {
        const input = document.getElementById('fe-image-upload');
        if(input) input.value = "";
        currentImagesList = []; // 清空陣列
        renderPreviewImages();  // 重新渲染(清空畫面)
    };

    /* --- 智能算術鍵盤系統 (防跳動優化版 V2) --- */
    let currentActiveInput = null;

    // 全域監聽輸入框聚焦
    document.addEventListener('focusin', (e) => {
        const el = e.target;

        // 1. 判斷條件
        const isTargetInput = el.tagName === 'INPUT' && 
                            (el.type === 'number' || el.type === 'tel' || el.inputMode === 'numeric' || el.classList.contains('cash-input')) &&
                            el.type !== 'password' && el.id !== 'admin-pwd';

        // 2. 裝置判斷
        if (isTargetInput && window.innerWidth < 1025) {
            
            const numpad = document.getElementById('custom-numpad');
            
            // ★★★ 關鍵變數：檢查鍵盤目前是否已經是開著的 ★★★
            const wasKeypadOpen = numpad.classList.contains('active');

            // --- 步驟 A：處理焦點切換 (每次點擊都要做) ---

            // 阻擋原生鍵盤
            el.setAttribute('inputmode', 'none'); 
            el.readOnly = true;
            
            if (!el.dataset.oldType) el.dataset.oldType = el.type;
            el.type = 'text'; 
            
            // 切換焦點樣式
            if(currentActiveInput && currentActiveInput !== el) {
                currentActiveInput.classList.remove('numpad-focus');
            }
            currentActiveInput = el; 
            el.classList.add('numpad-focus');
            
            // 確保鍵盤顯示 (如果沒開就打開，已開著就保持)
            numpad.classList.add('active');
            document.body.classList.add('numpad-active');

            // --- 步驟 B：決定是否要捲動 (只在第一次打開時執行) ---
            
            if (!wasKeypadOpen) {
                // 如果鍵盤原本是「關閉」的，代表這是第一次喚起
                // 這時候才執行自動捲動
                setTimeout(() => {
                    el.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center', 
                        inline: 'nearest' 
                    });
                }, 300);
            }
            // 如果 wasKeypadOpen 為 true (鍵盤已經開著)，
            // 則不執行 scrollIntoView，讓畫面停留在您當前滑動的位置。
        }
    });

    // 數字鍵盤輸入處理 (智慧版)
    window.numpadInput = function(key) {
        if (!currentActiveInput) return;
        let val = currentActiveInput.value;

        if (key === 'DEL') {
            // 刪除鍵
            currentActiveInput.value = val.slice(0, -1);
        } else if (key === 'AC') {
            // 清除鍵
            currentActiveInput.value = '';
        } else if (key === '\n') {
            // [智慧換行/跳格鍵]
            if (currentActiveInput.tagName === 'TEXTAREA') {
                // 情況 A：如果是備註欄 (textarea)，就執行「換行」
                currentActiveInput.value += "\n";
            } else {
                // 情況 B：如果是單行輸入框 (input)，就執行「跳下一格」
                
                // 1. 抓出目前畫面上所有看得到、能輸入的欄位
                const allInputs = Array.from(document.querySelectorAll('input:not([type="hidden"]), textarea'));
                
                // 2. 過濾出真正顯示在眼前的 (排除被 hidden 藏起來的彈窗欄位)
                const visibleInputs = allInputs.filter(el => el.offsetParent !== null && !el.disabled);
                
                // 3. 找出目前游標在哪一個
                const currentIndex = visibleInputs.indexOf(currentActiveInput);
                
                // 4. 如果後面還有欄位，就跳過去
                if (currentIndex > -1 && currentIndex < visibleInputs.length - 1) {
                    const nextInput = visibleInputs[currentIndex + 1];
                    nextInput.focus(); // 這會觸發我們的 focusin 事件，鍵盤會自動跟過去
                    
                    // 如果是金額欄位，自動全選內容，方便直接覆寫
                    if(nextInput.type === 'number' || nextInput.inputMode === 'numeric') {
                        nextInput.select(); 
                    }
                } else {
                    // 如果已經是最後一格，可以選擇收起鍵盤 (選用)
                    // closeNumpad(); 
                }
                
                // 跳格後不需要觸發 input 事件，直接結束
                return; 
            }
        } else {
            // 一般數字輸入
            // 百分比處理：自動補上 *0.01
            if (key === '%' && val.length > 0 && !isNaN(val.slice(-1))) {
                currentActiveInput.value += '*0.01';
            } else {
                currentActiveInput.value += key;
            }
        }
        
        // 手動觸發 input 事件，讓原本的金額計算邏輯能即時運作
        currentActiveInput.dispatchEvent(new Event('input'));
    };

    // 關閉鍵盤與結算 (需還原屬性)
    window.closeNumpad = function() {
        if (currentActiveInput) {
            // 1. 嘗試計算算式結果
            try {
                let expression = currentActiveInput.value;
                if (expression && /[\+\-\*\/]/.test(expression)) {
                    let result = new Function(`"use strict"; return (${expression})`)();
                    currentActiveInput.value = Math.round(result);
                }
            } catch (e) {
                console.error("計算錯誤", e);
            }
            
            // 2. 觸發系統更新事件
            currentActiveInput.classList.remove('numpad-focus');
            currentActiveInput.dispatchEvent(new Event('input'));
            currentActiveInput.dispatchEvent(new Event('change'));
            
            // 3. ★★★ 恢復原始狀態 ★★★
            let target = currentActiveInput;
            setTimeout(() => { 
                if(target.dataset.oldType) target.type = target.dataset.oldType; 
                
                // 移除 inputmode 屬性，恢復正常行為
                target.removeAttribute('inputmode');
                
                // 解除唯讀 (讓下一次點擊能再次觸發 focusin 流程)
                target.readOnly = false; 
            }, 100);
        }

        // 關閉介面
        document.getElementById('custom-numpad').classList.remove('active');
        document.body.classList.remove('numpad-active'); 
        currentActiveInput = null;
    };

    // ==========================================
    // [新功能] 自動關閉鍵盤邏輯 (Auto Close Numpad)
    // ==========================================
    function initAutoCloseNumpad() {
        // 建立觀察者：專門盯著 class 的變化
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const target = mutation.target;
                    const numpad = document.getElementById('custom-numpad');
                    
                    // 如果鍵盤本來就沒開，就不用做事
                    if (!numpad || !numpad.classList.contains('active')) return;

                    // 狀況 1: 任何彈窗 (Modal) 被加上了 'hidden' class (代表被關閉)
                    if (target.classList.contains('cal-modal-overlay') && target.classList.contains('hidden')) {
                        closeNumpad();
                    }
                    
                    // 狀況 2: 任何頁面 (Page) 被移除了 'active' class (代表被切換)
                    if (target.classList.contains('page-content') && !target.classList.contains('active')) {
                        closeNumpad();
                    }
                }
            });
        });

        // 開始監聽所有的「彈窗」和「主頁面」
        const elementsToWatch = document.querySelectorAll('.cal-modal-overlay, .page-content');
        elementsToWatch.forEach(el => {
            // 只監聽 class 屬性的變動
            observer.observe(el, { attributes: true, attributeFilter: ['class'] });
        });
    }

    // [修正] 當修改定金時，自動重算餘額，並更新底部按鈕
    window.updatePayRemaining = function() {
        // 1. 取得目前輸入的定金
        const val = parseInt(document.getElementById('pay-dep-input').value) || 0;
        
        // 2. 更新全域狀態
        checkoutState.deposit = val;
        
        // 3. 計算剩餘應付 (總額 - 定金)
        const remaining = Math.max(0, checkoutState.finalTotal - checkoutState.deposit);

        // 4. 更新介面上所有支付方式的金額顯示
        document.querySelectorAll('.pay-amt').forEach(el => el.innerText = "");
        
        // 只顯示在「目前被選中」的那一行
        const currentMethod = checkoutState.payMethod;
        const targetLabel = document.getElementById(`pay-val-${currentMethod}`);
        if (targetLabel) {
            targetLabel.innerText = `$${remaining}`;
        }

        // 5. [補回這行] 更新最底部的結帳按鈕金額！
        const btnTotal = document.getElementById('btn-pay-total');
        if (btnTotal) {
            btnTotal.innerText = remaining;
        }
    };

</script>

<div id="custom-numpad">
    <button class="num-btn num-op" onclick="numpadInput('/')">÷</button>
    <button class="num-btn num-op" onclick="numpadInput('*')">×</button>
    <button class="num-btn num-op" onclick="numpadInput('-')">-</button>
    <button class="num-btn num-op" onclick="numpadInput('+')">+</button>

    <button class="num-btn" onclick="numpadInput('7')">7</button>
    <button class="num-btn" onclick="numpadInput('8')">8</button>
    <button class="num-btn" onclick="numpadInput('9')">9</button>
    <button class="num-btn num-op num-del" onclick="numpadInput('DEL')">⌫</button>
    
    <button class="num-btn" onclick="numpadInput('4')">4</button>
    <button class="num-btn" onclick="numpadInput('5')">5</button>
    <button class="num-btn" onclick="numpadInput('6')">6</button>
    <button class="num-btn num-op" onclick="numpadInput('AC')">AC</button>
    
    <button class="num-btn" onclick="numpadInput('1')">1</button>
    <button class="num-btn" onclick="numpadInput('2')">2</button>
    <button class="num-btn" onclick="numpadInput('3')">3</button>
    <button class="num-btn num-op" onclick="numpadInput('\n')">↵</button> 
    
    <button class="num-btn" onclick="numpadInput('.')">.</button>
    <button class="num-btn" onclick="numpadInput('0')">0</button>
    <button class="num-btn num-op" onclick="numpadInput('%')">%</button>
    <button class="num-btn num-confirm" onclick="closeNumpad()">✓</button> 
</div> </body>
</html>
